<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²æ—ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js for weight/BMI visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --main-pink: #E9A4B8;
            --support-green: #7A9B7A;
            --bg-off-white: #F8F7F5;
            --text-charcoal: #4E4E4E;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-off-white);
            color: var(--text-charcoal);
        }
        h1, h2, h3, h4 {
            font-family: 'Noto Serif JP', serif;
        }
        .auth-check {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-off-white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--main-pink);
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day {
            background-color: white;
            padding: 8px;
            min-height: 60px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        .calendar-day.today {
            background-color: #fef3c7;
        }
        .calendar-day.other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }
        .calendar-day.has-record {
            background-color: #ecfdf5;
            border-left: 4px solid var(--support-green);
        }
        .mood-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .mood-very-good { background-color: #10b981; }
        .mood-good { background-color: #34d399; }
        .mood-neutral { background-color: #fbbf24; }
        .mood-bad { background-color: #f97316; }
        .mood-very-bad { background-color: #ef4444; }
        .record-form {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        .rating-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .rating-button:hover {
            border-color: var(--main-pink);
        }
        .rating-button.selected {
            background-color: var(--main-pink);
            color: white;
            border-color: var(--main-pink);
        }
        .record-details {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­ã®è¡¨ç¤º -->
    <div id="auth-check" class="auth-check">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>
        </div>
    </div>

    <div id="main-container" class="container mx-auto max-w-4xl p-4 sm:p-6" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-semibold text-gray-800">é€²æ—ç®¡ç†</h1>
                <p class="text-gray-600 mt-2">æ—¥ã€…ã®é£Ÿç”Ÿæ´»ãƒ»ä½“èª¿ãƒ»æ°—åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
            </div>
            <div class="flex gap-4">
                <a href="index.html" class="py-2 px-4 border rounded-full text-sm font-medium hover:bg-gray-100">ãƒ›ãƒ¼ãƒ </a>
                <button id="logout-button" class="py-2 px-4 border rounded-full text-sm font-medium hover:bg-gray-100">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </header>

        <!-- ä»Šæ—¥ã®è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="record-form">
            <h2 class="text-xl font-semibold mb-4">ä»Šæ—¥ã®è¨˜éŒ²</h2>
            <div id="today-date" class="text-gray-600 mb-6"></div>
            
            <form id="record-form">
                <!-- ä½“é‡ãƒ»BMI ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-8 p-6 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg border border-pink-200">
                    <h3 class="font-semibold mb-4 text-lg flex items-center">
                        <span class="bg-pink-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">ğŸ“Š</span>
                        ä½“é‡ãƒ»BMIç®¡ç†
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">ä»Šæ—¥ã®ä½“é‡ (kg)</label>
                            <input type="number" step="0.1" name="weight" id="weight-input" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="60.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">èº«é•· (cm)</label>
                            <input type="number" step="0.1" name="height" id="height-input" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="165.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">ç›®æ¨™ä½“é‡ (kg)</label>
                            <input type="number" step="0.1" name="target_weight" id="target-weight-input" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="55.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">BMI</label>
                            <div class="w-full border rounded-lg px-3 py-2 bg-gray-50 flex items-center">
                                <span id="bmi-display" class="font-semibold text-gray-700">-</span>
                                <span id="bmi-status" class="ml-2 text-xs px-2 py-1 rounded-full">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center p-3 bg-white rounded-lg">
                            <p class="text-gray-600">ç›®æ¨™ã¾ã§</p>
                            <p id="weight-diff" class="font-bold text-lg text-pink-600">-</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg">
                            <p class="text-gray-600">æ¨™æº–ä½“é‡(BMI22)</p>
                            <p id="standard-weight" class="font-bold text-lg text-green-600">-</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg">
                            <p class="text-gray-600">ç†æƒ³ä½“é‡(BMI20)</p>
                            <p id="ideal-weight" class="font-bold text-lg text-blue-600">-</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- é£Ÿç”Ÿæ´» -->
                    <div>
                        <h3 class="font-semibold mb-3">é£Ÿç”Ÿæ´»</h3>
                        <div class="space-y-3">
                            <!-- ä»Šæ—¥ã®é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªè¡¨ç¤º -->
                            <div class="p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-sm flex items-center">
                                        <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">ğŸ½ï¸</span>
                                        ä»Šæ—¥ã®é£Ÿäº‹è¨˜éŒ²
                                    </h4>
                                    <button type="button" id="add-meal-btn" class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600 transition">
                                        + é£Ÿäº‹ã‚’è¿½åŠ 
                                    </button>
                                </div>
                                <div id="today-meals" class="space-y-2 max-h-48 overflow-y-auto">
                                    <p class="text-xs text-gray-500">ã¾ã ä»Šæ—¥ã®é£Ÿäº‹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                </div>
                            </div>
                            
                            <!-- æ—¢å­˜ã®é£Ÿäº‹è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“ç‰ˆã¨ã—ã¦æ®‹ã™ï¼‰ -->
                            <div>
                                <label class="block text-sm font-medium mb-2">å‹•ç‰©æ€§é£Ÿå“ã®æ‘‚å–</label>
                                <select name="animal_food" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="none">æ‘‚å–ã—ã¦ã„ãªã„</option>
                                    <option value="little">å°‘ã—æ‘‚å–ã—ãŸ</option>
                                    <option value="moderate">æ™®é€šã«æ‘‚å–ã—ãŸ</option>
                                    <option value="much">å¤šãæ‘‚å–ã—ãŸ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ç³–è³ªã®æ‘‚å–</label>
                                <select name="sugar_intake" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="none">æ‘‚å–ã—ã¦ã„ãªã„</option>
                                    <option value="little">å°‘ã—æ‘‚å–ã—ãŸ</option>
                                    <option value="moderate">æ™®é€šã«æ‘‚å–ã—ãŸ</option>
                                    <option value="much">å¤šãæ‘‚å–ã—ãŸ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">é£Ÿäº‹å›æ•°</label>
                                <select name="meal_frequency" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="1">1å›</option>
                                    <option value="2">2å›</option>
                                    <option value="3">3å›</option>
                                    <option value="4">4å›ä»¥ä¸Š</option>
                                </select>
                            </div>
                            
                            <!-- AIè©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                            <div id="ai-food-comment" class="hidden p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border border-blue-200">
                                <h4 class="font-semibold text-sm mb-2 flex items-center">
                                    <span class="bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">ğŸ¤–</span>
                                    AIé£Ÿäº‹è©•ä¾¡
                                </h4>
                                <div id="ai-comment-content" class="text-sm space-y-2">
                                    <p id="overall-comment" class="font-medium"></p>
                                    <p id="timing-comment" class="text-gray-600"></p>
                                    <p id="advice-comment" class="text-blue-600"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä½“èª¿ -->
                    <div>
                        <h3 class="font-semibold mb-3">ä½“èª¿</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">ç–²åŠ´æ„Ÿ (1=ã¨ã¦ã‚‚ç–²ã‚Œã¦ã„ã‚‹ ã€œ 5=ã¨ã¦ã‚‚å…ƒæ°—)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">æ¶ˆåŒ–ã®èª¿å­ (1=ã¨ã¦ã‚‚æ‚ªã„ ã€œ 5=ã¨ã¦ã‚‚è‰¯ã„)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="digestion" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ç¡çœ ã®è³ª (1=ã¨ã¦ã‚‚æ‚ªã„ ã€œ 5=ã¨ã¦ã‚‚è‰¯ã„)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="sleep" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="5">5</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ°—åˆ† -->
                    <div>
                        <h3 class="font-semibold mb-3">æ°—åˆ†</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">ç·åˆçš„ãªæ°—åˆ† (1=ã¨ã¦ã‚‚æ‚ªã„ ã€œ 5=ã¨ã¦ã‚‚è‰¯ã„)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="mood" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ã‚¹ãƒˆãƒ¬ã‚¹æ„Ÿ (1=ã¨ã¦ã‚‚å¼·ã„ ã€œ 5=å…¨ããªã„)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="stress" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                                <textarea name="memo" placeholder="ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚„æ°—ã«ãªã‚‹ã“ã¨ã‚’è¨˜éŒ²..." class="w-full border rounded-lg px-3 py-2 h-20"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button type="submit" class="px-6 py-2 text-white font-bold rounded-full shadow-lg hover:opacity-90 transition" style="background-color: var(--main-pink);">
                        ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜
                    </button>
                </div>
            </form>
        </div>

        <!-- ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">ä½“é‡ãƒ»BMIæ¨ç§»</h2>
                <div class="flex gap-2">
                    <button id="chart-7days" class="px-3 py-1 border rounded hover:bg-gray-100 bg-pink-100 border-pink-300">7æ—¥</button>
                    <button id="chart-30days" class="px-3 py-1 border rounded hover:bg-gray-100">30æ—¥</button>
                    <button id="chart-90days" class="px-3 py-1 border rounded hover:bg-gray-100">90æ—¥</button>
                </div>
            </div>
            <div class="h-64 mb-4">
                <canvas id="weight-chart"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">æœ€é«˜ä½“é‡</p>
                    <p id="max-weight" class="font-bold text-lg text-red-600">-</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">æœ€ä½ä½“é‡</p>
                    <p id="min-weight" class="font-bold text-lg text-green-600">-</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">å¹³å‡ä½“é‡</p>
                    <p id="avg-weight" class="font-bold text-lg text-blue-600">-</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">å¤‰åŒ–é‡</p>
                    <p id="weight-change" class="font-bold text-lg text-purple-600">-</p>
                </div>
            </div>
        </div>

        <!-- æ „é¤Šåˆ†æã‚°ãƒ©ãƒ• -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">æ „é¤Šãƒãƒ©ãƒ³ã‚¹åˆ†æ</h2>
                <div class="flex gap-2">
                    <button id="nutrition-7days" class="px-3 py-1 border rounded hover:bg-gray-100 bg-green-100 border-green-300">7æ—¥</button>
                    <button id="nutrition-30days" class="px-3 py-1 border rounded hover:bg-gray-100">30æ—¥</button>
                    <button id="nutrition-90days" class="px-3 py-1 border rounded hover:bg-gray-100">90æ—¥</button>
                </div>
            </div>
            <div class="h-64 mb-4">
                <canvas id="nutrition-chart"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="text-center p-3 bg-red-50 rounded-lg">
                    <p class="text-gray-600">å‹•ç‰©æ€§é£Ÿå“å¹³å‡</p>
                    <p id="avg-animal" class="font-bold text-lg text-red-600">-</p>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded-lg">
                    <p class="text-gray-600">ç³–è³ªå¹³å‡</p>
                    <p id="avg-carbs" class="font-bold text-lg text-orange-600">-</p>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <p class="text-gray-600">ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå¹³å‡</p>
                    <p id="avg-protein" class="font-bold text-lg text-blue-600">-</p>
                </div>
            </div>
        </div>

        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
                <div class="flex gap-2">
                    <button id="prev-month" class="px-3 py-1 border rounded hover:bg-gray-100">&larr;</button>
                    <span id="current-month" class="px-4 py-1 font-medium"></span>
                    <button id="next-month" class="px-3 py-1 border rounded hover:bg-gray-100">&rarr;</button>
                </div>
            </div>
            
            <div class="calendar-grid">
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">æ—¥</div>
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">æœˆ</div>
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">ç«</div>
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">æ°´</div>
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">æœ¨</div>
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">é‡‘</div>
                <div class="calendar-day font-semibold text-center py-2 bg-gray-100">åœŸ</div>
                <div id="calendar-days"></div>
            </div>
        </div>

        <!-- è¨˜éŒ²è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="record-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold" id="modal-date"></h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <div id="modal-content"></div>
            </div>
        </div>

        <!-- é£Ÿäº‹è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="meal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg max-w-lg w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">é£Ÿäº‹ã‚’è¿½åŠ </h3>
                    <button id="close-meal-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <form id="meal-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">é£Ÿäº‹æ™‚é–“</label>
                            <input type="time" id="meal-time" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">é‡</label>
                            <input type="text" id="meal-amount" placeholder="ä¾‹ï¼š1çš¿ã€200g" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">é£Ÿäº‹å†…å®¹</label>
                        <input type="text" id="meal-content" placeholder="ä¾‹ï¼šã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <button type="button" id="analyze-meal-btn" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition">
                        AIåˆ†æã‚’å®Ÿè¡Œ
                    </button>
                    <div id="meal-analysis-result" class="hidden space-y-3 p-4 bg-gray-50 rounded">
                        <div>
                            <label class="block text-sm font-medium mb-1">è©³ç´°ãªå†…å®¹ï¼ˆç·¨é›†å¯èƒ½ï¼‰</label>
                            <textarea id="meal-description" class="w-full border rounded px-3 py-2 h-20 focus:ring-2 focus:ring-green-500" placeholder="AIãŒæ¨å®šã—ãŸææ–™ã‚„è©³ç´°"></textarea>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">å‹•ç‰©æ€§é£Ÿå“</label>
                                <select id="meal-animal" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="none">ãªã—</option>
                                    <option value="little">å°‘ã—</option>
                                    <option value="moderate">æ™®é€š</option>
                                    <option value="much">å¤šã„</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">ç³–è³ª</label>
                                <select id="meal-carbs" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="none">ãªã—</option>
                                    <option value="little">å°‘ã—</option>
                                    <option value="moderate">æ™®é€š</option>
                                    <option value="much">å¤šã„</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">ã‚¿ãƒ³ãƒ‘ã‚¯è³ª</label>
                                <select id="meal-protein" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="none">ãªã—</option>
                                    <option value="little">å°‘ã—</option>
                                    <option value="moderate">æ™®é€š</option>
                                    <option value="much">å¤šã„</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <button type="button" id="cancel-meal-btn" class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-50">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit" id="save-meal-btn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition" disabled>
                            ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // FirebaseåˆæœŸåŒ–
            const firebaseConfig = {
                apiKey: "AIzaSyCSK2XMhrPQbZ8J1y-Kz3YCoU45rDKv1bM",
                authDomain: "trauma-note-app.firebaseapp.com",
                projectId: "trauma-note-app",
                storageBucket: "trauma-note-app.appspot.com",
                messagingSenderId: "643740992546",
                appId: "1:643740992546:web:dba603fed8f73b09c9f67b"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            const auth = firebase.auth();
            const db = firebase.firestore();
            
            let currentUser = null;
            let currentDate = new Date();
            let records = {};
            let todayMeals = [];

            const authCheckElement = document.getElementById('auth-check');
            const mainContainer = document.getElementById('main-container');
            const logoutButton = document.getElementById('logout-button');
            const recordForm = document.getElementById('record-form');
            const todayDateElement = document.getElementById('today-date');
            const currentMonthElement = document.getElementById('current-month');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const calendarDaysContainer = document.getElementById('calendar-days');
            const recordModal = document.getElementById('record-modal');
            const closeModal = document.getElementById('close-modal');
            const modalDate = document.getElementById('modal-date');
            const modalContent = document.getElementById('modal-content');
            
            // é£Ÿäº‹ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
            const addMealBtn = document.getElementById('add-meal-btn');
            const mealModal = document.getElementById('meal-modal');
            const closeMealModal = document.getElementById('close-meal-modal');
            const cancelMealBtn = document.getElementById('cancel-meal-btn');
            const mealForm = document.getElementById('meal-form');
            const analyzeMealBtn = document.getElementById('analyze-meal-btn');
            const saveMealBtn = document.getElementById('save-meal-btn');
            const todayMealsContainer = document.getElementById('today-meals');

            // èªè¨¼çŠ¶æ…‹ã®ç¢ºèª
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authCheckElement.style.display = 'none';
                    mainContainer.style.display = 'block';
                    initializeApp();
                } else {
                    window.location.href = 'index.html';
                }
            });

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
            const initializeApp = () => {
                const today = new Date();
                todayDateElement.textContent = formatDate(today);
                setupRatingButtons();
                setupWeightBMICalculation();
                setupFormSubmission();
                setupCalendar();
                setupWeightChart();
                setupNutritionChart();
                setupFoodAnalysis();
                setupMealModal();
                loadRecords();
            };

            // ä½“é‡ãƒ»BMIè¨ˆç®—æ©Ÿèƒ½ã®è¨­å®š
            const setupWeightBMICalculation = () => {
                const weightInput = document.getElementById('weight-input');
                const heightInput = document.getElementById('height-input');
                const targetWeightInput = document.getElementById('target-weight-input');
                
                const calculateAndDisplay = () => {
                    const weight = parseFloat(weightInput.value);
                    const height = parseFloat(heightInput.value);
                    const targetWeight = parseFloat(targetWeightInput.value);
                    
                    if (weight && height) {
                        const heightInM = height / 100;
                        const bmi = weight / (heightInM * heightInM);
                        
                        // BMIè¡¨ç¤º
                        document.getElementById('bmi-display').textContent = bmi.toFixed(1);
                        
                        // BMIçŠ¶æ…‹è¡¨ç¤º
                        const bmiStatus = document.getElementById('bmi-status');
                        if (bmi < 18.5) {
                            bmiStatus.textContent = 'ç—©ã›';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800';
                        } else if (bmi < 25) {
                            bmiStatus.textContent = 'æ¨™æº–';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-green-100 text-green-800';
                        } else if (bmi < 30) {
                            bmiStatus.textContent = 'è‚¥æº€(1åº¦)';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800';
                        } else {
                            bmiStatus.textContent = 'è‚¥æº€(2åº¦ä»¥ä¸Š)';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-red-100 text-red-800';
                        }
                        
                        // ç›®æ¨™ä½“é‡ã¨ã®å·®
                        if (targetWeight) {
                            const diff = weight - targetWeight;
                            document.getElementById('weight-diff').textContent = diff > 0 ? `+${diff.toFixed(1)}kg` : `${diff.toFixed(1)}kg`;
                        }
                        
                        // æ¨™æº–ä½“é‡ãƒ»ç†æƒ³ä½“é‡
                        const standardWeight = 22 * heightInM * heightInM;
                        const idealWeight = 20 * heightInM * heightInM;
                        
                        document.getElementById('standard-weight').textContent = standardWeight.toFixed(1) + 'kg';
                        document.getElementById('ideal-weight').textContent = idealWeight.toFixed(1) + 'kg';
                    }
                };
                
                weightInput.addEventListener('input', calculateAndDisplay);
                heightInput.addEventListener('input', calculateAndDisplay);
                targetWeightInput.addEventListener('input', calculateAndDisplay);
            };

            // ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®è¨­å®š
            const setupRatingButtons = () => {
                document.querySelectorAll('.rating-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const name = button.dataset.name;
                        const value = button.dataset.value;
                        
                        document.querySelectorAll(`[data-name="${name}"]`).forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        
                        // éš ã—inputã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
                        let hiddenInput = document.querySelector(`input[name="${name}"]`);
                        if (!hiddenInput) {
                            hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = name;
                            recordForm.appendChild(hiddenInput);
                        }
                        hiddenInput.value = value;
                    });
                });
            };

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®è¨­å®š
            const setupFormSubmission = () => {
                recordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(recordForm);
                    const data = Object.fromEntries(formData.entries());
                    
                    const today = new Date();
                    const dateKey = formatDateKey(today);
                    
                    try {
                        console.log('ä¿å­˜é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', currentUser?.uid);
                        console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', data);
                        console.log('æ—¥ä»˜ã‚­ãƒ¼:', dateKey);
                        
                        if (!currentUser || !currentUser.uid) {
                            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                        
                        // æ—¢å­˜ã®è¨˜éŒ²ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸
                        const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                        const existingDoc = await docRef.get();
                        let existingData = {};
                        if (existingDoc.exists) {
                            existingData = existingDoc.data();
                        }
                        
                        await docRef.set({
                            ...existingData,
                            ...data,
                            date: firebase.firestore.Timestamp.fromDate(today),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        alert('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                        loadRecords();
                        
                        // è¨˜éŒ²èª­ã¿è¾¼ã¿å¾Œã«AIè©•ä¾¡ã‚’å®Ÿè¡Œ
                        setTimeout(() => {
                            generateDailyFoodSummary(dateKey);
                        }, 1000);
                        
                    } catch (error) {
                        console.error('è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', error.code);
                        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                        alert(`è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                    }
                });
            };

            // è¨˜éŒ²ã®èª­ã¿è¾¼ã¿
            const loadRecords = async () => {
                try {
                    const snapshot = await db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).get();
                    records = {};
                    
                    snapshot.forEach(doc => {
                        records[doc.id] = doc.data();
                    });
                    
                    renderCalendar();
                    loadTodayRecord();
                    
                    // ä½“é‡ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                    if (window.updateWeightChart) {
                        window.updateWeightChart();
                    }
                    
                    // æ „é¤Šåˆ†æã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                    if (window.updateNutritionChart) {
                        window.updateNutritionChart();
                    }
                    
                    // ä»Šæ—¥ã®é£Ÿäº‹ä¸€è¦§ã‚’æ›´æ–°
                    displayTodayMeals();
                    
                    // AIè©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
                    displayAIFoodComment();
                    
                } catch (error) {
                    console.error('è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            };

            // ä»Šæ—¥ã®è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿
            const loadTodayRecord = () => {
                const today = new Date();
                const dateKey = formatDateKey(today);
                const todayRecord = records[dateKey];
                
                if (todayRecord) {
                    // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ã®è¨˜éŒ²ã‚’è¨­å®š
                    Object.keys(todayRecord).forEach(key => {
                        const input = document.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (input.type === 'hidden') {
                                input.value = todayRecord[key];
                                document.querySelector(`[data-name="${key}"][data-value="${todayRecord[key]}"]`)?.classList.add('selected');
                            } else {
                                input.value = todayRecord[key];
                            }
                        }
                    });
                    
                    // ä½“é‡ãƒ»BMIè¨ˆç®—ã‚’æ›´æ–°
                    if (todayRecord.weight && todayRecord.height) {
                        const weightInput = document.getElementById('weight-input');
                        const heightInput = document.getElementById('height-input');
                        
                        if (weightInput && heightInput) {
                            const event = new Event('input');
                            weightInput.dispatchEvent(event);
                        }
                    }
                }
            };

            // ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•ã®è¨­å®š
            const setupWeightChart = () => {
                const ctx = document.getElementById('weight-chart').getContext('2d');
                let weightChart = null;
                let currentPeriod = 7; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯7æ—¥é–“
                
                const chartButtons = {
                    '7days': document.getElementById('chart-7days'),
                    '30days': document.getElementById('chart-30days'),
                    '90days': document.getElementById('chart-90days')
                };
                
                // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                Object.entries(chartButtons).forEach(([key, button]) => {
                    button.addEventListener('click', () => {
                        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                        Object.values(chartButtons).forEach(btn => {
                            btn.classList.remove('bg-pink-100', 'border-pink-300');
                        });
                        button.classList.add('bg-pink-100', 'border-pink-300');
                        
                        // æœŸé–“ã‚’è¨­å®š
                        currentPeriod = parseInt(key.replace('days', ''));
                        updateWeightChart();
                    });
                });
                
                const updateWeightChart = () => {
                    const weightData = getWeightData(currentPeriod);
                    
                    if (weightChart) {
                        weightChart.destroy();
                    }
                    
                    weightChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: weightData.labels,
                            datasets: [{
                                label: 'ä½“é‡ (kg)',
                                data: weightData.weights,
                                borderColor: '#E9A4B8',
                                backgroundColor: 'rgba(233, 164, 184, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            }, {
                                label: 'BMI',
                                data: weightData.bmis,
                                borderColor: '#7A9B7A',
                                backgroundColor: 'rgba(122, 155, 122, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'ä½“é‡ (kg)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'BMI'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                    updateWeightStats(weightData.weights);
                };
                
                const getWeightData = (days) => {
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - days + 1);
                    
                    const labels = [];
                    const weights = [];
                    const bmis = [];
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = formatDateKey(d);
                        const record = records[dateKey];
                        
                        labels.push(d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                        
                        if (record && record.weight && record.height) {
                            weights.push(parseFloat(record.weight));
                            const heightInM = parseFloat(record.height) / 100;
                            bmis.push(parseFloat(record.weight) / (heightInM * heightInM));
                        } else {
                            weights.push(null);
                            bmis.push(null);
                        }
                    }
                    
                    return { labels, weights, bmis };
                };
                
                const updateWeightStats = (weights) => {
                    const validWeights = weights.filter(w => w !== null);
                    
                    if (validWeights.length === 0) {
                        document.getElementById('max-weight').textContent = '-';
                        document.getElementById('min-weight').textContent = '-';
                        document.getElementById('avg-weight').textContent = '-';
                        document.getElementById('weight-change').textContent = '-';
                        return;
                    }
                    
                    const maxWeight = Math.max(...validWeights);
                    const minWeight = Math.min(...validWeights);
                    const avgWeight = validWeights.reduce((a, b) => a + b, 0) / validWeights.length;
                    const weightChange = validWeights.length > 1 ? validWeights[validWeights.length - 1] - validWeights[0] : 0;
                    
                    document.getElementById('max-weight').textContent = maxWeight.toFixed(1) + 'kg';
                    document.getElementById('min-weight').textContent = minWeight.toFixed(1) + 'kg';
                    document.getElementById('avg-weight').textContent = avgWeight.toFixed(1) + 'kg';
                    document.getElementById('weight-change').textContent = weightChange >= 0 ? `+${weightChange.toFixed(1)}kg` : `${weightChange.toFixed(1)}kg`;
                };
                
                // åˆæœŸãƒãƒ£ãƒ¼ãƒˆä½œæˆ
                window.updateWeightChart = updateWeightChart;
            };
            
            // æ „é¤Šåˆ†æã‚°ãƒ©ãƒ•ã®è¨­å®š
            const setupNutritionChart = () => {
                const ctx = document.getElementById('nutrition-chart').getContext('2d');
                let nutritionChart = null;
                let currentNutritionPeriod = 7; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯7æ—¥é–“
                
                const chartButtons = {
                    '7days': document.getElementById('nutrition-7days'),
                    '30days': document.getElementById('nutrition-30days'),
                    '90days': document.getElementById('nutrition-90days')
                };
                
                // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                Object.entries(chartButtons).forEach(([key, button]) => {
                    button.addEventListener('click', () => {
                        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                        Object.values(chartButtons).forEach(btn => {
                            btn.classList.remove('bg-green-100', 'border-green-300');
                        });
                        button.classList.add('bg-green-100', 'border-green-300');
                        
                        // æœŸé–“ã‚’è¨­å®š
                        currentNutritionPeriod = parseInt(key.replace('days', ''));
                        updateNutritionChart();
                    });
                });
                
                const updateNutritionChart = () => {
                    const nutritionData = getNutritionData(currentNutritionPeriod);
                    
                    if (nutritionChart) {
                        nutritionChart.destroy();
                    }
                    
                    nutritionChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: nutritionData.labels,
                            datasets: [{
                                label: 'å‹•ç‰©æ€§é£Ÿå“',
                                data: nutritionData.animalData,
                                borderColor: '#EF4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }, {
                                label: 'ç³–è³ª',
                                data: nutritionData.carbData,
                                borderColor: '#F97316',
                                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }, {
                                label: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª',
                                data: nutritionData.proteinData,
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 4,
                                    ticks: {
                                        callback: function(value) {
                                            const labels = ['ãªã—', 'å°‘ã—', 'æ™®é€š', 'å¤šã„'];
                                            return labels[value] || value;
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'æ‘‚å–ãƒ¬ãƒ™ãƒ«'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                    updateNutritionStats(nutritionData);
                };
                
                const getNutritionData = (days) => {
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - days + 1);
                    
                    const labels = [];
                    const animalData = [];
                    const carbData = [];
                    const proteinData = [];
                    
                    // ãƒ¬ãƒ™ãƒ«ã‚’æ•°å€¤ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                    const levelToNumber = {
                        'none': 0,
                        'little': 1,
                        'moderate': 2,
                        'much': 3
                    };
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = formatDateKey(d);
                        const record = records[dateKey];
                        
                        labels.push(d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                        
                        if (record) {
                            animalData.push(levelToNumber[record.animal_food] ?? null);
                            carbData.push(levelToNumber[record.sugar_intake] ?? null);
                            // ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ãƒ¬ãƒ™ãƒ«ãŒãªã„å ´åˆã¯æ¨å®šå€¤ã‚’ä½¿ç”¨
                            const proteinLevel = record.protein_level || 'moderate';
                            proteinData.push(levelToNumber[proteinLevel] ?? null);
                        } else {
                            animalData.push(null);
                            carbData.push(null);
                            proteinData.push(null);
                        }
                    }
                    
                    return { labels, animalData, carbData, proteinData };
                };
                
                const updateNutritionStats = (nutritionData) => {
                    const numberToLevel = {
                        0: 'ãªã—',
                        1: 'å°‘ã—',
                        2: 'æ™®é€š',
                        3: 'å¤šã„'
                    };
                    
                    const calcAverage = (data) => {
                        const validData = data.filter(d => d !== null);
                        if (validData.length === 0) return null;
                        const avg = validData.reduce((a, b) => a + b, 0) / validData.length;
                        return Math.round(avg);
                    };
                    
                    const avgAnimal = calcAverage(nutritionData.animalData);
                    const avgCarbs = calcAverage(nutritionData.carbData);
                    const avgProtein = calcAverage(nutritionData.proteinData);
                    
                    document.getElementById('avg-animal').textContent = avgAnimal !== null ? numberToLevel[avgAnimal] : '-';
                    document.getElementById('avg-carbs').textContent = avgCarbs !== null ? numberToLevel[avgCarbs] : '-';
                    document.getElementById('avg-protein').textContent = avgProtein !== null ? numberToLevel[avgProtein] : '-';
                };
                
                // åˆæœŸãƒãƒ£ãƒ¼ãƒˆä½œæˆ
                window.updateNutritionChart = updateNutritionChart;
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¨­å®š
            const setupCalendar = () => {
                prevMonthButton.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });

                nextMonthButton.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                closeModal.addEventListener('click', () => {
                    recordModal.classList.add('hidden');
                });

                recordModal.addEventListener('click', (e) => {
                    if (e.target === recordModal) {
                        recordModal.classList.add('hidden');
                    }
                });
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”»
            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                currentMonthElement.textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const today = new Date();
                const todayKey = formatDateKey(today);
                
                let calendarHtml = '';
                
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    
                    const dateKey = formatDateKey(cellDate);
                    const isToday = dateKey === todayKey;
                    const isOtherMonth = cellDate.getMonth() !== month;
                    const hasRecord = records[dateKey];
                    
                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (isOtherMonth) classes += ' other-month';
                    if (hasRecord) classes += ' has-record';
                    
                    let moodIndicator = '';
                    if (hasRecord && hasRecord.mood) {
                        const moodClass = getMoodClass(hasRecord.mood);
                        moodIndicator = `<div class="mood-indicator ${moodClass}"></div>`;
                    }
                    
                    calendarHtml += `
                        <div class="${classes}" data-date="${dateKey}">
                            <div class="font-semibold">${cellDate.getDate()}</div>
                            ${moodIndicator}
                        </div>
                    `;
                }
                
                calendarDaysContainer.innerHTML = calendarHtml;
                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelectorAll('.calendar-day[data-date]').forEach(dayElement => {
                    dayElement.addEventListener('click', () => {
                        const dateKey = dayElement.dataset.date;
                        const record = records[dateKey];
                        
                        if (record) {
                            showRecordModal(dateKey, record);
                        }
                    });
                });
            };

            // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
            const showRecordModal = (dateKey, record) => {
                const date = new Date(dateKey);
                modalDate.textContent = formatDate(date);
                
                const labels = {
                    breakfast: 'æœé£Ÿ',
                    lunch: 'æ˜¼é£Ÿ',
                    dinner: 'å¤•é£Ÿ',
                    snacks: 'é–“é£Ÿãƒ»ãã®ä»–',
                    animal_food: 'å‹•ç‰©æ€§é£Ÿå“',
                    sugar_intake: 'ç³–è³ªæ‘‚å–',
                    meal_frequency: 'é£Ÿäº‹å›æ•°',
                    fatigue: 'ç–²åŠ´æ„Ÿ',
                    digestion: 'æ¶ˆåŒ–ã®èª¿å­',
                    sleep: 'ç¡çœ ã®è³ª',
                    mood: 'æ°—åˆ†',
                    stress: 'ã‚¹ãƒˆãƒ¬ã‚¹æ„Ÿ',
                    memo: 'ãƒ¡ãƒ¢'
                };
                
                const valueLabels = {
                    animal_food: { none: 'æ‘‚å–ã—ã¦ã„ãªã„', little: 'å°‘ã—', moderate: 'æ™®é€š', much: 'å¤šã„' },
                    sugar_intake: { none: 'æ‘‚å–ã—ã¦ã„ãªã„', little: 'å°‘ã—', moderate: 'æ™®é€š', much: 'å¤šã„' }
                };
                
                let content = '<div class="space-y-3">';
                
                // é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªã‚’å…ˆã«è¡¨ç¤º
                if (record.meal_entries && record.meal_entries.length > 0) {
                    content += '<div class="mb-4"><h4 class="font-medium text-sm mb-2">é£Ÿäº‹è¨˜éŒ²</h4>';
                    const sortedMeals = record.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                    sortedMeals.forEach(meal => {
                        content += `
                            <div class="record-details">
                                <span class="font-medium">${meal.time} ${meal.content}</span>
                                <span class="ml-2 text-xs text-gray-500">${meal.amount || ''}</span>
                                ${meal.description ? `<div class="text-xs text-gray-600 mt-1">${meal.description}</div>` : ''}
                            </div>
                        `;
                    });
                    content += '</div>';
                }
                
                Object.keys(labels).forEach(key => {
                    if (record[key]) {
                        let displayValue = record[key];
                        
                        if (valueLabels[key]) {
                            displayValue = valueLabels[key][record[key]] || record[key];
                        } else if (key === 'meal_frequency') {
                            displayValue = record[key] + 'å›';
                        } else if (['fatigue', 'digestion', 'sleep', 'mood', 'stress'].includes(key)) {
                            displayValue = record[key] + '/5';
                        } else if (['breakfast', 'lunch', 'dinner', 'snacks'].includes(key)) {
                            displayValue = record[key];
                        }
                        
                        content += `
                            <div class="record-details">
                                <span class="font-medium">${labels[key]}:</span>
                                <span class="ml-2">${displayValue}</span>
                            </div>
                        `;
                    }
                });
                
                content += '</div>';
                modalContent.innerHTML = content;
                recordModal.classList.remove('hidden');
            };

            // æ°—åˆ†ã‚¯ãƒ©ã‚¹ã®å–å¾—
            const getMoodClass = (mood) => {
                const moodValue = parseInt(mood);
                if (moodValue >= 5) return 'mood-very-good';
                if (moodValue >= 4) return 'mood-good';
                if (moodValue >= 3) return 'mood-neutral';
                if (moodValue >= 2) return 'mood-bad';
                return 'mood-very-bad';
            };

            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatDate = (date) => {
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            };

            // æ—¥ä»˜ã‚­ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatDateKey = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            // AIé£Ÿäº‹è§£ææ©Ÿèƒ½ã®è¨­å®šï¼ˆæ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ - ç¾åœ¨ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰
            const setupFoodAnalysis = () => {
                // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é£Ÿäº‹è§£ææ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ä½•ã‚‚ã—ãªã„
                console.log('setupFoodAnalysis: æ–°ã—ã„å€‹åˆ¥é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ä¸­');
            };
            
            // AIé£Ÿäº‹åˆ†æ
            const analyzeFood = async (foodText) => {
                const prompt = `ä»¥ä¸‹ã®é£Ÿäº‹å†…å®¹ã‚’åˆ†æã—ã¦ã€JSONå½¢å¼ã§çµæœã‚’è¿”ã—ã¦ãã ã•ã„ï¼š

é£Ÿäº‹å†…å®¹: ${foodText}

åˆ†æé …ç›®:
1. å‹•ç‰©æ€§é£Ÿå“ã®æ‘‚å–é‡ï¼ˆnone/little/moderate/muchï¼‰
2. ç³–è³ªã®æ‘‚å–é‡ï¼ˆnone/little/moderate/muchï¼‰
3. ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®æ‘‚å–é‡ï¼ˆnone/little/moderate/muchï¼‰
4. æ¨å®šã•ã‚Œã‚‹ä¸»ãªææ–™ï¼ˆé…åˆ—ï¼‰
5. æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡

JSONå½¢å¼:
{
  "animal_food_level": "moderate",
  "sugar_level": "much",
  "protein_level": "moderate",
  "ingredients": ["ç‰›è‚‰", "ç±³", "é‡èœ"],
  "nutrition_comment": "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸé£Ÿäº‹ã§ã™"
}`;
                
                try {
                    const apiKey = "AIzaSyAdjWYPpgAnLfIflzpTBth1N5NN1_qHa0E";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!aiResponse) {
                        throw new Error('AIå¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    }
                    
                    // JSONã‚’æŠ½å‡º
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('æœ‰åŠ¹ãªJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                    
                    return JSON.parse(jsonMatch[0]);
                    
                } catch (error) {
                    console.error('AIé£Ÿäº‹åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ†æ
                    return {
                        animal_food_level: 'moderate',
                        sugar_level: 'moderate',
                        protein_level: 'moderate',
                        ingredients: ['åˆ†æã§ãã¾ã›ã‚“ã§ã—ãŸ'],
                        nutrition_comment: 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ'
                    };
                }
            };
            
            // é£Ÿäº‹åˆ†æçµæœã®è¡¨ç¤º
            const displayFoodAnalysis = (analysis) => {
                const levelLabels = {
                    'none': 'å°‘ãªã„',
                    'little': 'å°‘ã—',
                    'moderate': 'æ™®é€š',
                    'much': 'å¤šã„'
                };
                
                document.getElementById('animal-score').textContent = levelLabels[analysis.animal_food_level] || 'ä¸æ˜';
                document.getElementById('carb-score').textContent = levelLabels[analysis.sugar_level] || 'ä¸æ˜';
                document.getElementById('protein-score').textContent = levelLabels[analysis.protein_level] || 'ä¸æ˜';
                
                const details = `
                    <p><strong>æ¨å®šææ–™:</strong> ${analysis.ingredients ? analysis.ingredients.join(', ') : 'ä¸æ˜'}</p>
                    <p><strong>æ „é¤Šè©•ä¾¡:</strong> ${analysis.nutrition_comment || 'è©•ä¾¡ã§ãã¾ã›ã‚“ã§ã—ãŸ'}</p>
                `;
                
                document.getElementById('food-details').innerHTML = details;
            };
            
            // ä¸€æ—¥å…¨ä½“ã®é£Ÿäº‹è©•ä¾¡ç”Ÿæˆ
            const generateDailyFoodSummary = async (dateKey) => {
                try {
                    console.log('AIè©•ä¾¡é–‹å§‹:', dateKey);
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç›´æ¥æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    const doc = await docRef.get();
                    
                    if (!doc.exists) {
                        console.log('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', dateKey);
                        return;
                    }
                    
                    const record = doc.data();
                    console.log('å–å¾—ã—ãŸè¨˜éŒ²:', record);
                    
                    if (!record || !record.meal_entries || record.meal_entries.length === 0) {
                        console.log('é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Šã¾ã›ã‚“:', record);
                        return;
                    }
                    
                    // ä¸€æ—¥ã®é£Ÿäº‹ã‚’æ™‚ç³»åˆ—ã§æ•´ç†
                    const meals = record.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                    console.log('æ•´ç†ã•ã‚ŒãŸé£Ÿäº‹:', meals);
                    
                    const mealSummary = meals.map(meal => `${meal.time}: ${meal.content} (${meal.amount || ''})${meal.description ? ` - ${meal.description}` : ''}`).join('\\n');
                    console.log('é£Ÿäº‹ã‚µãƒãƒªãƒ¼:', mealSummary);
                    
                    const prompt = `ä»¥ä¸‹ã®ä¸€æ—¥ã®é£Ÿäº‹å†…å®¹ã‚’åˆ†æã—ã¦ã€æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã¨å¥åº·é¢ã§ã®è©•ä¾¡ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š

ã€ä¸€æ—¥ã®é£Ÿäº‹å†…å®¹ã€‘
${mealSummary}

ã€è©•ä¾¡é …ç›®ã€‘
1. å…¨ä½“çš„ãªæ „é¤Šãƒãƒ©ãƒ³ã‚¹
2. å‹•ç‰©æ€§é£Ÿå“ã®æ‘‚å–çŠ¶æ³
3. ç³–è³ªã®æ‘‚å–çŠ¶æ³
4. ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®æ‘‚å–çŠ¶æ³
5. é£Ÿäº‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
6. æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹

ã€å‡ºåŠ›å½¢å¼ã€‘
{
  "overall_comment": "ä»Šæ—¥ã®é£Ÿäº‹ãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½ã§ã™ã€‚ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãŒã—ã£ã‹ã‚Šæ‘‚ã‚Œã¦ã„ã¾ã™ã­ã€‚",
  "animal_food_summary": "moderate",
  "carb_summary": "little",
  "protein_summary": "moderate",
  "timing_comment": "é£Ÿäº‹é–“éš”ãŒé©åˆ‡ã§ã€è¦å‰‡æ­£ã—ã„é£Ÿç”Ÿæ´»ãŒã§ãã¦ã„ã¾ã™ã€‚",
  "advice": "å¤•é£Ÿã®é‡èœã‚’å¢—ã‚„ã™ã¨ã•ã‚‰ã«è‰¯ã„ã§ã—ã‚‡ã†ã€‚"
}`;
                    
                    const apiKey = "AIzaSyAdjWYPpgAnLfIflzpTBth1N5NN1_qHa0E";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    
                    console.log('AI APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    console.log('AI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('AIç”Ÿã®å¿œç­”:', result);
                    
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    console.log('AIå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ:', aiResponse);
                    
                    if (aiResponse) {
                        const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);
                        console.log('JSONæŠ½å‡º:', jsonMatch?.[0]);
                        
                        if (jsonMatch) {
                            const summary = JSON.parse(jsonMatch[0]);
                            console.log('ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ã‚µãƒãƒªãƒ¼:', summary);
                            
                            // è©•ä¾¡çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                            await docRef.update({
                                daily_food_summary: summary,
                                ai_analyzed: true,
                                ai_analysis_date: new Date().toISOString(),
                                // æ—¢å­˜ã®ç°¡æ˜“è©•ä¾¡ã‚‚è‡ªå‹•è¨­å®š
                                animal_food: summary.animal_food_summary,
                                sugar_intake: summary.carb_summary,
                                meal_frequency: meals.length.toString()
                            });
                            
                            console.log('AIè©•ä¾¡å®Œäº†:', summary);
                            
                            // è¨˜éŒ²ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
                            loadRecords();
                        }
                    }
                } catch (error) {
                    console.error('ä¸€æ—¥é£Ÿäº‹è©•ä¾¡ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                }
            };
            
            // é£Ÿäº‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¨­å®š
            const setupMealModal = () => {
                // é£Ÿäº‹è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
                addMealBtn.addEventListener('click', () => {
                    openMealModal();
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeMealModal.addEventListener('click', () => {
                    closeMealModalFunction();
                });
                
                cancelMealBtn.addEventListener('click', () => {
                    closeMealModalFunction();
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                mealModal.addEventListener('click', (e) => {
                    if (e.target === mealModal) {
                        closeMealModalFunction();
                    }
                });
                
                // AIåˆ†æãƒœã‚¿ãƒ³
                analyzeMealBtn.addEventListener('click', () => {
                    analyzeMeal();
                });
                
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
                mealForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveMeal();
                });
                
                // å…¥åŠ›å¤‰æ›´æ™‚ã®ä¿å­˜ãƒœã‚¿ãƒ³åˆ¶å¾¡
                document.getElementById('meal-content').addEventListener('input', updateSaveButton);
                document.getElementById('meal-time').addEventListener('input', updateSaveButton);
            };
            
            // é£Ÿäº‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            const openMealModal = () => {
                // ç¾åœ¨æ™‚åˆ»ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                const now = new Date();
                const timeString = now.toTimeString().slice(0, 5);
                document.getElementById('meal-time').value = timeString;
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                mealForm.reset();
                document.getElementById('meal-time').value = timeString; // ãƒªã‚»ãƒƒãƒˆå¾Œã«å†è¨­å®š
                document.getElementById('meal-analysis-result').classList.add('hidden');
                updateSaveButton();
                
                mealModal.classList.remove('hidden');
            };
            
            // é£Ÿäº‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const closeMealModalFunction = () => {
                mealModal.classList.add('hidden');
            };
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¶å¾¡
            const updateSaveButton = () => {
                const content = document.getElementById('meal-content').value.trim();
                const time = document.getElementById('meal-time').value;
                saveMealBtn.disabled = !content || !time;
            };
            
            // AIé£Ÿäº‹åˆ†æï¼ˆå€‹åˆ¥ã‚¨ãƒ³ãƒˆãƒªç”¨ï¼‰
            const analyzeMeal = async () => {
                const content = document.getElementById('meal-content').value.trim();
                if (!content) {
                    alert('é£Ÿäº‹å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                analyzeMealBtn.textContent = 'åˆ†æä¸­...';
                analyzeMealBtn.disabled = true;
                
                try {
                    const analysis = await analyzeFood(content);
                    
                    // çµæœã‚’ç·¨é›†å¯èƒ½ãªå½¢ã§è¡¨ç¤º
                    document.getElementById('meal-description').value = analysis.ingredients ? analysis.ingredients.join(', ') : '';
                    document.getElementById('meal-animal').value = analysis.animal_food_level || 'moderate';
                    document.getElementById('meal-carbs').value = analysis.sugar_level || 'moderate';
                    document.getElementById('meal-protein').value = analysis.protein_level || 'moderate';
                    
                    document.getElementById('meal-analysis-result').classList.remove('hidden');
                    updateSaveButton();
                    
                } catch (error) {
                    console.error('é£Ÿäº‹åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                    alert('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    document.getElementById('meal-analysis-result').classList.remove('hidden');
                } finally {
                    analyzeMealBtn.textContent = 'AIåˆ†æã‚’å®Ÿè¡Œ';
                    analyzeMealBtn.disabled = false;
                }
            };
            
            // é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªã‚’ä¿å­˜
            const saveMeal = async () => {
                const mealData = {
                    id: Date.now().toString(),
                    time: document.getElementById('meal-time').value,
                    content: document.getElementById('meal-content').value.trim(),
                    amount: document.getElementById('meal-amount').value.trim(),
                    description: document.getElementById('meal-description').value.trim(),
                    animal_food_level: document.getElementById('meal-animal').value,
                    sugar_level: document.getElementById('meal-carbs').value,
                    protein_level: document.getElementById('meal-protein').value,
                    created_at: new Date().toISOString()
                };
                
                try {
                    // ä»Šæ—¥ã®è¨˜éŒ²ã«è¿½åŠ 
                    const today = new Date();
                    const dateKey = formatDateKey(today);
                    
                    if (!currentUser || !currentUser.uid) {
                        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }
                    
                    // æ—¢å­˜ã®è¨˜éŒ²ã‚’å–å¾—
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    const doc = await docRef.get();
                    
                    let existingData = {};
                    if (doc.exists) {
                        existingData = doc.data();
                    }
                    
                    // é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
                    const mealEntries = existingData.meal_entries || [];
                    mealEntries.push(mealData);
                    
                    await docRef.set({
                        ...existingData,
                        meal_entries: mealEntries,
                        date: firebase.firestore.Timestamp.fromDate(today),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert('é£Ÿäº‹ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    closeMealModalFunction();
                    loadRecords(); // è¨˜éŒ²ã‚’å†èª­ã¿è¾¼ã¿
                    
                } catch (error) {
                    console.error('é£Ÿäº‹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`é£Ÿäº‹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            };
            
            // ä»Šæ—¥ã®é£Ÿäº‹ä¸€è¦§ã‚’è¡¨ç¤º
            const displayTodayMeals = () => {
                const today = new Date();
                const dateKey = formatDateKey(today);
                const todayRecord = records[dateKey];
                
                console.log('ä»Šæ—¥ã®é£Ÿäº‹è¡¨ç¤º:', dateKey, todayRecord);
                
                if (!todayRecord || !todayRecord.meal_entries || todayRecord.meal_entries.length === 0) {
                    todayMealsContainer.innerHTML = '<p class="text-xs text-gray-500">ã¾ã ä»Šæ—¥ã®é£Ÿäº‹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }
                
                const meals = todayRecord.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                
                let html = '';
                meals.forEach((meal, index) => {
                    html += `
                        <div class="flex justify-between items-center p-2 bg-white rounded border text-xs">
                            <div class="flex-1">
                                <div class="font-medium">${meal.time} - ${meal.content}</div>
                                <div class="text-gray-500">${meal.amount || ''} ${meal.description || ''}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editMeal('${dateKey}', ${index})" class="text-blue-500 hover:text-blue-700">âœï¸</button>
                                <button onclick="deleteMeal('${dateKey}', ${index})" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                });
                
                todayMealsContainer.innerHTML = html;
            };
            
            // AIé£Ÿäº‹è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
            const displayAIFoodComment = () => {
                const today = new Date();
                const dateKey = formatDateKey(today);
                const todayRecord = records[dateKey];
                
                console.log('AIè©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º:', dateKey, todayRecord?.daily_food_summary);
                
                if (!todayRecord || !todayRecord.daily_food_summary) {
                    document.getElementById('ai-food-comment').classList.add('hidden');
                    return;
                }
                
                const summary = todayRecord.daily_food_summary;
                
                document.getElementById('overall-comment').textContent = summary.overall_comment || '';
                document.getElementById('timing-comment').textContent = summary.timing_comment || '';
                document.getElementById('advice-comment').textContent = summary.advice || '';
                
                document.getElementById('ai-food-comment').classList.remove('hidden');
            };
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
            window.editMeal = async (dateKey, index) => {
                const record = records[dateKey];
                if (!record || !record.meal_entries || !record.meal_entries[index]) {
                    alert('é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const meal = record.meal_entries[index];
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                document.getElementById('meal-time').value = meal.time;
                document.getElementById('meal-content').value = meal.content;
                document.getElementById('meal-amount').value = meal.amount || '';
                document.getElementById('meal-description').value = meal.description || '';
                document.getElementById('meal-animal').value = meal.animal_food_level || 'moderate';
                document.getElementById('meal-carbs').value = meal.sugar_level || 'moderate';
                document.getElementById('meal-protein').value = meal.protein_level || 'moderate';
                
                // åˆ†æçµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                document.getElementById('meal-analysis-result').classList.remove('hidden');
                updateSaveButton();
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                mealModal.classList.remove('hidden');
                
                // ç·¨é›†ç”¨ã®å‡¦ç†ã«å¤‰æ›´
                const originalSubmitHandler = mealForm.onsubmit;
                mealForm.onsubmit = async (e) => {
                    e.preventDefault();
                    await updateMeal(dateKey, index);
                    mealForm.onsubmit = originalSubmitHandler;
                };
            };
            
            window.deleteMeal = async (dateKey, index) => {
                if (!confirm('ã“ã®é£Ÿäº‹è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
                
                try {
                    const record = records[dateKey];
                    if (!record || !record.meal_entries) {
                        throw new Error('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤
                    const mealEntries = [...record.meal_entries];
                    mealEntries.splice(index, 1);
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    await docRef.update({
                        meal_entries: mealEntries,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('é£Ÿäº‹è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadRecords();
                    
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            };
            
            // é£Ÿäº‹ã‚¨ãƒ³ãƒˆãƒªã‚’æ›´æ–°
            const updateMeal = async (dateKey, index) => {
                const mealData = {
                    id: records[dateKey].meal_entries[index].id, // æ—¢å­˜IDã‚’ä¿æŒ
                    time: document.getElementById('meal-time').value,
                    content: document.getElementById('meal-content').value.trim(),
                    amount: document.getElementById('meal-amount').value.trim(),
                    description: document.getElementById('meal-description').value.trim(),
                    animal_food_level: document.getElementById('meal-animal').value,
                    sugar_level: document.getElementById('meal-carbs').value,
                    protein_level: document.getElementById('meal-protein').value,
                    created_at: records[dateKey].meal_entries[index].created_at, // ä½œæˆæ—¥æ™‚ã‚’ä¿æŒ
                    updated_at: new Date().toISOString()
                };
                
                try {
                    const record = records[dateKey];
                    const mealEntries = [...record.meal_entries];
                    mealEntries[index] = mealData;
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    await docRef.update({
                        meal_entries: mealEntries,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('é£Ÿäº‹è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                    closeMealModalFunction();
                    loadRecords();
                    
                } catch (error) {
                    console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            };
        });
    </script>
</body>
</html>