<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄ≤ÊçóÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js for weight/BMI visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --main-pink: #E9A4B8;
            --support-green: #7A9B7A;
            --bg-off-white: #F8F7F5;
            --text-charcoal: #4E4E4E;
            --accent-purple: #A78BFA;
            --accent-orange: #FB923C;
            --warm-gray: #78716C;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--bg-off-white) 0%, #F3F4F6 100%);
            color: var(--text-charcoal);
            min-height: 100vh;
        }
        h1, h2, h3, h4 {
            font-family: 'Noto Serif JP', serif;
            background: linear-gradient(135deg, var(--text-charcoal) 0%, var(--warm-gray) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .auth-check {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-off-white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--main-pink);
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            gap: 2px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
        }
        .calendar-day {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            padding: 12px;
            min-height: 70px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            margin: 0 !important;
            box-sizing: border-box;
            display: block;
        }
        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .calendar-day.today {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid #F59E0B;
            font-weight: 600;
        }
        .calendar-day.other-month {
            background: rgba(249, 250, 251, 0.6);
            color: #9CA3AF;
        }
        .calendar-day.has-record {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border-left: 4px solid var(--support-green);
            position: relative;
        }
        .calendar-day.has-record::before {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--support-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .mood-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .mood-very-good { background-color: #10b981; }
        .mood-good { background-color: #34d399; }
        .mood-neutral { background-color: #fbbf24; }
        .mood-bad { background-color: #f97316; }
        .mood-very-bad { background-color: #ef4444; }
        .record-form {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            margin-bottom: 32px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .record-form:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        .rating-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #E5E7EB;
            background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .rating-button:hover {
            border-color: var(--main-pink);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(233, 164, 184, 0.3);
        }
        .rating-button.selected {
            background: linear-gradient(135deg, var(--main-pink) 0%, #DC8DA8 100%);
            color: white;
            border-color: var(--main-pink);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(233, 164, 184, 0.4);
        }
        .record-details {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠„ÅÆË°®Á§∫ -->
    <div id="auth-check" class="auth-check">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÅÑ„Åæ„Åô...</p>
        </div>
    </div>

    <div id="main-container" class="container mx-auto max-w-4xl p-4 sm:p-6" style="display: none;">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-semibold text-gray-800">ÈÄ≤ÊçóÁÆ°ÁêÜ</h1>
                <p class="text-gray-600 mt-2">Êó•„ÄÖ„ÅÆÈ£üÁîüÊ¥ª„Éª‰ΩìË™ø„ÉªÊ∞óÂàÜ„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ</p>
            </div>
            <div class="flex gap-4">
                <a href="index.html" class="py-2 px-4 border rounded-full text-sm font-medium hover:bg-gray-100">„Éõ„Éº„É†</a>
                <button id="feedback-button" class="py-2 px-4 bg-blue-500 text-white rounded-full text-sm font-medium hover:bg-blue-600">„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</button>
                <button id="logout-button" class="py-2 px-4 border rounded-full text-sm font-medium hover:bg-gray-100">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </header>

        <!-- ‰ªäÊó•„ÅÆË®òÈå≤„Éï„Ç©„Éº„É† -->
        <div class="record-form">
            <h2 class="text-xl font-semibold mb-4">‰ªäÊó•„ÅÆË®òÈå≤</h2>
            <div id="today-date" class="text-gray-600 mb-6"></div>
            
            <form id="record-form">
                <!-- ‰ΩìÈáç„ÉªBMI „Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="mb-8 p-6 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg border border-pink-200">
                    <h3 class="font-semibold mb-4 text-lg flex items-center">
                        <span class="bg-pink-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">üìä</span>
                        ‰ΩìÈáç„ÉªBMIÁÆ°ÁêÜ
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">‰ªäÊó•„ÅÆ‰ΩìÈáç (kg)</label>
                            <input type="number" step="0.1" name="weight" id="weight-input" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="60.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Ë∫´Èï∑ (cm)</label>
                            <input type="number" step="0.1" name="height" id="height-input" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="165.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">ÁõÆÊ®ô‰ΩìÈáç (kg)</label>
                            <input type="number" step="0.1" name="target_weight" id="target-weight-input" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="55.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">BMI</label>
                            <div class="w-full border rounded-lg px-3 py-2 bg-gray-50 flex items-center">
                                <span id="bmi-display" class="font-semibold text-gray-700">-</span>
                                <span id="bmi-status" class="ml-2 text-xs px-2 py-1 rounded-full">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center p-3 bg-white rounded-lg">
                            <p class="text-gray-600">ÁõÆÊ®ô„Åæ„Åß</p>
                            <p id="weight-diff" class="font-bold text-lg text-pink-600">-</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg">
                            <p class="text-gray-600">Ê®ôÊ∫ñ‰ΩìÈáç(BMI22)</p>
                            <p id="standard-weight" class="font-bold text-lg text-green-600">-</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg">
                            <p class="text-gray-600">ÁêÜÊÉ≥‰ΩìÈáç(BMI20)</p>
                            <p id="ideal-weight" class="font-bold text-lg text-blue-600">-</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- È£üÁîüÊ¥ª -->
                    <div class="glass-card p-6">
                        <h3 class="font-bold mb-6 text-lg flex items-center">
                            <span class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üçé</span>
                            È£üÁîüÊ¥ª
                            <span class="ml-auto text-sm font-normal text-gray-500">Ê†ÑÈ§ä„Éê„É©„É≥„Çπ</span>
                        </h3>
                        <div class="space-y-4">
                            <!-- ‰ªäÊó•„ÅÆÈ£ü‰∫ã„Ç®„É≥„Éà„É™Ë°®Á§∫ -->
                            <div class="p-5 bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 rounded-xl border border-green-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-base flex items-center">
                                        <span class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 shadow-md">üçΩÔ∏è</span>
                                        ‰ªäÊó•„ÅÆÈ£ü‰∫ãË®òÈå≤
                                    </h4>
                                    <button type="button" id="add-meal-btn" class="animated-button text-sm py-2 px-4 bg-gradient-to-r from-green-500 to-emerald-500">
                                        + È£ü‰∫ã„ÇíËøΩÂä†
                                    </button>
                                </div>
                                <div id="today-meals" class="space-y-3 max-h-56 overflow-y-auto">
                                    <p class="text-sm text-gray-500 text-center py-4">„Åæ„Å†‰ªäÊó•„ÅÆÈ£ü‰∫ã„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                                </div>
                            </div>
                            
                            <!-- Êó¢Â≠ò„ÅÆÈ£ü‰∫ãË®òÈå≤„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÁ∞°ÊòìÁâà„Å®„Åó„Å¶ÊÆã„ÅôÔºâ -->
                            <div>
                                <label class="block text-sm font-medium mb-2">ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÅÆÊëÇÂèñ</label>
                                <select name="animal_food" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="none">ÊëÇÂèñ„Åó„Å¶„ÅÑ„Å™„ÅÑ</option>
                                    <option value="little">Â∞ë„ÅóÊëÇÂèñ„Åó„Åü</option>
                                    <option value="moderate">ÊôÆÈÄö„Å´ÊëÇÂèñ„Åó„Åü</option>
                                    <option value="much">Â§ö„ÅèÊëÇÂèñ„Åó„Åü</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Á≥ñË≥™„ÅÆÊëÇÂèñ</label>
                                <select name="sugar_intake" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="none">ÊëÇÂèñ„Åó„Å¶„ÅÑ„Å™„ÅÑ</option>
                                    <option value="little">Â∞ë„ÅóÊëÇÂèñ„Åó„Åü</option>
                                    <option value="moderate">ÊôÆÈÄö„Å´ÊëÇÂèñ„Åó„Åü</option>
                                    <option value="much">Â§ö„ÅèÊëÇÂèñ„Åó„Åü</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">È£ü‰∫ãÂõûÊï∞</label>
                                <select name="meal_frequency" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="1">1Âõû</option>
                                    <option value="2">2Âõû</option>
                                    <option value="3">3Âõû</option>
                                    <option value="4">4Âõû‰ª•‰∏ä</option>
                                </select>
                            </div>
                            
                        </div>
                    </div>

                    <!-- ‰ΩìË™ø -->
                    <div class="glass-card p-6">
                        <h3 class="font-bold mb-6 text-lg flex items-center">
                            <span class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üí™</span>
                            ‰ΩìË™ø
                            <span class="ml-auto text-sm font-normal text-gray-500">Ë∫´‰Ωì„ÅÆÁä∂ÊÖã</span>
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Áñ≤Âä¥ÊÑü (1=„Å®„Å¶„ÇÇÁñ≤„Çå„Å¶„ÅÑ„Çã „Äú 5=„Å®„Å¶„ÇÇÂÖÉÊ∞ó)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="fatigue" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Ê∂àÂåñ„ÅÆË™øÂ≠ê (1=„Å®„Å¶„ÇÇÊÇ™„ÅÑ „Äú 5=„Å®„Å¶„ÇÇËâØ„ÅÑ)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="digestion" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="digestion" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Áù°Áú†„ÅÆË≥™ (1=„Å®„Å¶„ÇÇÊÇ™„ÅÑ „Äú 5=„Å®„Å¶„ÇÇËâØ„ÅÑ)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="sleep" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="sleep" data-value="5">5</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ê∞óÂàÜ -->
                    <div class="glass-card p-6">
                        <h3 class="font-bold mb-6 text-lg flex items-center">
                            <span class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üòä</span>
                            Ê∞óÂàÜ
                            <span class="ml-auto text-sm font-normal text-gray-500">„É°„É≥„Çø„É´Áä∂ÊÖã</span>
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Á∑èÂêàÁöÑ„Å™Ê∞óÂàÜ (1=„Å®„Å¶„ÇÇÊÇ™„ÅÑ „Äú 5=„Å®„Å¶„ÇÇËâØ„ÅÑ)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="mood" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="mood" data-value="5">5</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">„Çπ„Éà„É¨„ÇπÊÑü (1=„Å®„Å¶„ÇÇÂº∑„ÅÑ „Äú 5=ÂÖ®„Åè„Å™„ÅÑ)</label>
                                <div class="flex gap-2">
                                    <button type="button" class="rating-button" data-name="stress" data-value="1">1</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="2">2</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="3">3</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="4">4</button>
                                    <button type="button" class="rating-button" data-name="stress" data-value="5">5</button>
                                </div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg border border-gray-200">
                                <label class="block text-sm font-semibold mb-3 text-gray-700">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label>
                                <textarea name="memo" placeholder="‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä„ÇÑÊ∞ó„Å´„Å™„Çã„Åì„Å®„ÇíË®òÈå≤..." class="w-full border rounded-lg px-3 py-2 h-24 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-10">
                    <button type="submit" class="animated-button px-8 py-3 text-lg font-bold rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                        üíæ ‰ªäÊó•„ÅÆË®òÈå≤„Çí‰øùÂ≠ò
                    </button>
                </div>
            </form>
        </div>

        <!-- AIÈ£ü‰∫ãË©ï‰æ°„Ç®„É™„Ç¢ÔºàÁã¨Á´ã„Åó„Åü„Éï„É´„ÉØ„Ç§„Éâ„Çª„ÇØ„Ç∑„Éß„É≥Ôºâ -->
        <div id="ai-food-comment" class="hidden glass-card p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center">
                    <span class="bg-gradient-to-r from-blue-500 to-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">ü§ñ</span>
                    AIÈ£ü‰∫ãË©ï‰æ°
                </h2>
                <button id="refresh-ai-comment" class="text-blue-500 hover:text-blue-700 text-sm underline">
                    ÂÜçË©ï‰æ°
                </button>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-4">
                <div class="space-y-3 text-sm">
                    <p><span class="font-semibold text-green-700">üéØ Á∑èÂêàË©ï‰æ°Ôºö</span> <span id="overall-comment" class="text-gray-800"></span></p>
                    <p><span class="font-semibold text-orange-700">‚è∞ „Çø„Ç§„Éü„É≥„Ç∞Ôºö</span> <span id="timing-comment" class="text-gray-800"></span></p>
                    <p><span class="font-semibold text-purple-700">üí° „Ç¢„Éâ„Éê„Ç§„ÇπÔºö</span> <span id="advice-comment" class="text-gray-800"></span></p>
                </div>
            </div>
        </div>

        <!-- ‰ΩìÈáçÊé®Áßª„Ç∞„É©„Éï -->
        <div class="glass-card p-8 mb-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üìà</span>
                    ‰ΩìÈáç„ÉªBMIÊé®Áßª
                </h2>
                <div class="flex gap-2">
                    <button id="chart-7days" class="animated-button px-4 py-2 text-sm bg-pink-100 text-pink-700 border border-pink-300 rounded-full hover:bg-pink-200">7Êó•</button>
                    <button id="chart-30days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">30Êó•</button>
                    <button id="chart-90days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">90Êó•</button>
                </div>
            </div>
            <div class="h-64 mb-4">
                <canvas id="weight-chart"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">ÊúÄÈ´ò‰ΩìÈáç</p>
                    <p id="max-weight" class="font-bold text-lg text-red-600">-</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">ÊúÄ‰Ωé‰ΩìÈáç</p>
                    <p id="min-weight" class="font-bold text-lg text-green-600">-</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">Âπ≥Âùá‰ΩìÈáç</p>
                    <p id="avg-weight" class="font-bold text-lg text-blue-600">-</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600">Â§âÂåñÈáè</p>
                    <p id="weight-change" class="font-bold text-lg text-purple-600">-</p>
                </div>
            </div>
        </div>

        <!-- Ê†ÑÈ§äÂàÜÊûê„Ç∞„É©„Éï -->
        <div class="glass-card p-8 mb-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üå±</span>
                    Ê†ÑÈ§ä„Éê„É©„É≥„ÇπÂàÜÊûê
                </h2>
                <div class="flex gap-2">
                    <button id="nutrition-7days" class="animated-button px-4 py-2 text-sm bg-green-100 text-green-700 border border-green-300 rounded-full hover:bg-green-200">7Êó•</button>
                    <button id="nutrition-30days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">30Êó•</button>
                    <button id="nutrition-90days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">90Êó•</button>
                </div>
            </div>
            <div class="h-64 mb-4">
                <canvas id="nutrition-chart"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                <div class="text-center p-4 glass-card bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">ÂãïÁâ©ÊÄßÈ£üÂìÅÂπ≥Âùá</p>
                    <p id="avg-animal" class="font-bold text-lg text-red-600">-</p>
                </div>
                <div class="text-center p-4 glass-card bg-gradient-to-br from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">Á≥ñË≥™Âπ≥Âùá</p>
                    <p id="avg-carbs" class="font-bold text-lg text-orange-600">-</p>
                </div>
                <div class="text-center p-4 glass-card bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">„Çø„É≥„Éë„ÇØË≥™Âπ≥Âùá</p>
                    <p id="avg-protein" class="font-bold text-lg text-blue-600">-</p>
                </div>
            </div>
        </div>

        <!-- È£ü‰∫ãÈñìÈöîÂàÜÊûê„Ç∞„É©„Éï -->
        <div class="glass-card p-8 mb-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">‚è∞</span>
                    È£ü‰∫ãÈñìÈöîÂàÜÊûêÔºàIFÔºâ
                </h2>
                <div class="flex gap-2">
                    <button id="interval-7days" class="animated-button px-4 py-2 text-sm bg-orange-100 text-orange-700 border border-orange-300 rounded-full hover:bg-orange-200">7Êó•</button>
                    <button id="interval-30days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">30Êó•</button>
                    <button id="interval-90days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">90Êó•</button>
                </div>
            </div>
            <div class="h-64 mb-6">
                <canvas id="interval-chart"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-sm">
                <div class="text-center p-4 glass-card bg-gradient-to-br from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">Âπ≥Âùá„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì</p>
                    <p id="avg-fasting" class="font-bold text-lg text-green-600">-</p>
                </div>
                <div class="text-center p-4 glass-card bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">ÊúÄÈï∑„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞</p>
                    <p id="max-fasting" class="font-bold text-lg text-blue-600">-</p>
                </div>
                <div class="text-center p-4 glass-card bg-gradient-to-br from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">È£ü‰∫ã„Ç¶„Ç£„É≥„Éâ„Ç¶Âπ≥Âùá</p>
                    <p id="avg-eating-window" class="font-bold text-lg text-purple-600">-</p>
                </div>
                <div class="text-center p-4 glass-card bg-gradient-to-br from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 transition-all duration-300">
                    <p class="text-gray-600 mb-2">IF„Çπ„Ç≥„Ç¢</p>
                    <p id="if-score" class="font-bold text-lg text-orange-600">-</p>
                </div>
            </div>
            <div class="mt-6 p-4 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg border border-orange-200">
                <h4 class="font-bold text-sm mb-2 text-orange-800">‰ªäÊó•„ÅÆ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞Áä∂Ê≥Å</h4>
                <div id="today-fasting-status" class="text-sm text-orange-700">
                    <p>‰ªäÊó•„ÅÆÈ£ü‰∫ã„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                </div>
            </div>
        </div>

        <!-- Áõ∏Èñ¢ÂàÜÊûê„Ç∞„É©„Éï -->
        <div class="glass-card p-8 mb-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üîç</span>
                    Áõ∏Èñ¢ÂàÜÊûê
                </h2>
                <div class="flex gap-2">
                    <button id="correlation-7days" class="animated-button px-4 py-2 text-sm bg-indigo-100 text-indigo-700 border border-indigo-300 rounded-full hover:bg-indigo-200">7Êó•</button>
                    <button id="correlation-30days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">30Êó•</button>
                    <button id="correlation-90days" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">90Êó•</button>
                </div>
            </div>
            
            <!-- Áõ∏Èñ¢ÂàÜÊûê„Çø„Éñ -->
            <div class="mb-6">
                <div class="flex gap-2 mb-6">
                    <button id="tab-weight-correlation" class="animated-button px-4 py-2 text-sm bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-full">‰ΩìÈáç„Å®„ÅÆÁõ∏Èñ¢</button>
                    <button id="tab-mood-correlation" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">Ê∞óÂàÜ„Å®„ÅÆÁõ∏Èñ¢</button>
                    <button id="tab-health-correlation" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">‰ΩìË™ø„Å®„ÅÆÁõ∏Èñ¢</button>
                    <button id="tab-comprehensive-correlation" class="px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors">Á∑èÂêàÂàÜÊûê</button>
                </div>
            </div>
            
            <!-- Áõ∏Èñ¢ÂàÜÊûê„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div id="correlation-content">
                <div class="h-64 mb-6">
                    <canvas id="correlation-chart"></canvas>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 bg-gradient-to-br from-blue-50 to-indigo-50">
                        <h4 class="font-bold text-lg mb-4 text-indigo-800">Áõ∏Èñ¢‰øÇÊï∞</h4>
                        <div id="correlation-stats" class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">ÂãïÁâ©ÊÄßÈ£üÂìÅ</span>
                                <span id="animal-correlation" class="font-bold text-indigo-600">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Á≥ñË≥™ÊëÇÂèñ</span>
                                <span id="carbs-correlation" class="font-bold text-indigo-600">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">„Çø„É≥„Éë„ÇØË≥™</span>
                                <span id="protein-correlation" class="font-bold text-indigo-600">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì</span>
                                <span id="fasting-correlation" class="font-bold text-indigo-600">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">È£ü‰∫ãÂõûÊï∞</span>
                                <span id="meal-count-correlation" class="font-bold text-indigo-600">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6 bg-gradient-to-br from-green-50 to-emerald-50">
                        <h4 class="font-bold text-lg mb-4 text-emerald-800">ÂàÜÊûêÁµêÊûú</h4>
                        <div id="correlation-insights" class="space-y-2 text-sm">
                            <p class="text-gray-600">„Éá„Éº„Çø„ÇíÂàÜÊûê‰∏≠...</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                    <h4 class="font-bold text-sm mb-2 text-blue-800">Áõ∏Èñ¢‰øÇÊï∞„ÅÆË™≠„ÅøÊñπ</h4>
                    <div class="text-xs text-blue-700 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <span class="font-semibold text-green-600">0.7‰ª•‰∏ä</span>: Âº∑„ÅÑÊ≠£„ÅÆÁõ∏Èñ¢
                        </div>
                        <div>
                            <span class="font-semibold text-orange-600">0.3-0.7</span>: ‰∏≠Á®ãÂ∫¶„ÅÆÁõ∏Èñ¢
                        </div>
                        <div>
                            <span class="font-semibold text-red-600">-0.7‰ª•‰∏ã</span>: Âº∑„ÅÑË≤†„ÅÆÁõ∏Èñ¢
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫ -->
        <div class="glass-card p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-lg">üìÖ</span>
                    Ë®òÈå≤„Ç´„É¨„É≥„ÉÄ„Éº
                </h2>
                <div class="flex gap-3">
                    <button id="prev-month" class="animated-button px-4 py-2 text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full hover:from-purple-600 hover:to-pink-600">&larr;</button>
                    <span id="current-month" class="px-6 py-2 font-bold text-lg bg-gradient-to-r from-purple-100 to-pink-100 rounded-full border border-purple-200"></span>
                    <button id="next-month" class="animated-button px-4 py-2 text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full hover:from-purple-600 hover:to-pink-600">&rarr;</button>
                </div>
            </div>
            
            <div id="calendar-container" class="calendar-grid">
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Êó•</div>
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Êúà</div>
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">ÁÅ´</div>
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Ê∞¥</div>
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Êú®</div>
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Èáë</div>
                <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Âúü</div>
            </div>
        </div>

        <!-- Ë®òÈå≤Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
        <div id="record-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="glass-card max-w-md w-full p-8 bg-white">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="modal-date"></h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
                </div>
                <div id="modal-content"></div>
            </div>
        </div>

        <!-- È£ü‰∫ãËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
        <div id="meal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="glass-card max-w-lg w-full p-8 bg-white">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold flex items-center">
                        <span class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3">üçΩÔ∏è</span>
                        È£ü‰∫ã„ÇíËøΩÂä†
                    </h3>
                    <button id="close-meal-modal" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
                </div>
                <form id="meal-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">È£ü‰∫ãÊôÇÈñì</label>
                            <input type="time" id="meal-time" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Èáè</label>
                            <input type="text" id="meal-amount" placeholder="‰æãÔºö1Áöø„ÄÅ200g" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">È£ü‰∫ãÂÜÖÂÆπ</label>
                        <input type="text" id="meal-content" placeholder="‰æãÔºö„Ç´„É¨„Éº„É©„Ç§„Çπ" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <button type="button" id="analyze-meal-btn" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition">
                        AIÂàÜÊûê„ÇíÂÆüË°å
                    </button>
                    <div id="meal-analysis-result" class="hidden space-y-3 p-4 bg-gray-50 rounded">
                        <div>
                            <label class="block text-sm font-medium mb-1">Ë©≥Á¥∞„Å™ÂÜÖÂÆπÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ</label>
                            <textarea id="meal-description" class="w-full border rounded px-3 py-2 h-20 focus:ring-2 focus:ring-green-500" placeholder="AI„ÅåÊé®ÂÆö„Åó„ÅüÊùêÊñô„ÇÑË©≥Á¥∞"></textarea>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">ÂãïÁâ©ÊÄßÈ£üÂìÅ</label>
                                <select id="meal-animal" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="none">„Å™„Åó</option>
                                    <option value="little">Â∞ë„Åó</option>
                                    <option value="moderate">ÊôÆÈÄö</option>
                                    <option value="much">Â§ö„ÅÑ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Á≥ñË≥™</label>
                                <select id="meal-carbs" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="none">„Å™„Åó</option>
                                    <option value="little">Â∞ë„Åó</option>
                                    <option value="moderate">ÊôÆÈÄö</option>
                                    <option value="much">Â§ö„ÅÑ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">„Çø„É≥„Éë„ÇØË≥™</label>
                                <select id="meal-protein" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="none">„Å™„Åó</option>
                                    <option value="little">Â∞ë„Åó</option>
                                    <option value="moderate">ÊôÆÈÄö</option>
                                    <option value="much">Â§ö„ÅÑ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 pt-6">
                        <button type="button" id="cancel-meal-btn" class="flex-1 border border-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="submit" id="save-meal-btn" class="animated-button flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 px-6 rounded-lg font-semibold" disabled>
                            ‰øùÂ≠ò
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // FirebaseÂàùÊúüÂåñ
            const firebaseConfig = {
                apiKey: "AIzaSyCSK2XMhrPQbZ8J1y-Kz3YCoU45rDKv1bM",
                authDomain: "trauma-note-app.firebaseapp.com",
                projectId: "trauma-note-app",
                storageBucket: "trauma-note-app.appspot.com",
                messagingSenderId: "643740992546",
                appId: "1:643740992546:web:dba603fed8f73b09c9f67b"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            const auth = firebase.auth();
            const db = firebase.firestore();
            
            let currentUser = null;
            let currentDate = new Date();
            let records = {};
            let todayMeals = [];
            
            // „Éá„Éê„ÉÉ„Ç∞Áî®„Å´window„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†
            window.records = records;
            window.currentUser = null;

            const authCheckElement = document.getElementById('auth-check');
            const mainContainer = document.getElementById('main-container');
            const logoutButton = document.getElementById('logout-button');
            const recordForm = document.getElementById('record-form');
            const todayDateElement = document.getElementById('today-date');
            const currentMonthElement = document.getElementById('current-month');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const calendarDaysContainer = document.getElementById('calendar-container');
            const recordModal = document.getElementById('record-modal');
            const closeModal = document.getElementById('close-modal');
            const modalDate = document.getElementById('modal-date');
            const modalContent = document.getElementById('modal-content');
            
            // È£ü‰∫ã„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
            const addMealBtn = document.getElementById('add-meal-btn');
            const mealModal = document.getElementById('meal-modal');
            const closeMealModal = document.getElementById('close-meal-modal');
            const cancelMealBtn = document.getElementById('cancel-meal-btn');
            const mealForm = document.getElementById('meal-form');
            const analyzeMealBtn = document.getElementById('analyze-meal-btn');
            const saveMealBtn = document.getElementById('save-meal-btn');
            const todayMealsContainer = document.getElementById('today-meals');

            // Ë™çË®ºÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    window.currentUser = user; // „Éá„Éê„ÉÉ„Ç∞Áî®
                    authCheckElement.style.display = 'none';
                    mainContainer.style.display = 'block';
                    initializeApp();
                } else {
                    window.location.href = 'index.html';
                }
            });

            // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊ©üËÉΩ
            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            // „Ç¢„Éó„É™ÂàùÊúüÂåñ
            const initializeApp = () => {
                const today = new Date();
                todayDateElement.textContent = formatDate(today);
                setupRatingButtons();
                setupWeightBMICalculation();
                setupFormSubmission();
                setupCalendar();
                setupWeightChart();
                setupNutritionChart();
                setupFoodAnalysis();
                setupMealModal();
                setupAICommentRefresh();
                loadRecords();
            };

            // ‰ΩìÈáç„ÉªBMIË®àÁÆóÊ©üËÉΩ„ÅÆË®≠ÂÆö
            const setupWeightBMICalculation = () => {
                const weightInput = document.getElementById('weight-input');
                const heightInput = document.getElementById('height-input');
                const targetWeightInput = document.getElementById('target-weight-input');
                
                const calculateAndDisplay = () => {
                    const weight = parseFloat(weightInput.value);
                    const height = parseFloat(heightInput.value);
                    const targetWeight = parseFloat(targetWeightInput.value);
                    
                    if (weight && height) {
                        const heightInM = height / 100;
                        const bmi = weight / (heightInM * heightInM);
                        
                        // BMIË°®Á§∫
                        document.getElementById('bmi-display').textContent = bmi.toFixed(1);
                        
                        // BMIÁä∂ÊÖãË°®Á§∫
                        const bmiStatus = document.getElementById('bmi-status');
                        if (bmi < 18.5) {
                            bmiStatus.textContent = 'Áó©„Åõ';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800';
                        } else if (bmi < 25) {
                            bmiStatus.textContent = 'Ê®ôÊ∫ñ';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-green-100 text-green-800';
                        } else if (bmi < 30) {
                            bmiStatus.textContent = 'ËÇ•Ê∫Ä(1Â∫¶)';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800';
                        } else {
                            bmiStatus.textContent = 'ËÇ•Ê∫Ä(2Â∫¶‰ª•‰∏ä)';
                            bmiStatus.className = 'ml-2 text-xs px-2 py-1 rounded-full bg-red-100 text-red-800';
                        }
                        
                        // ÁõÆÊ®ô‰ΩìÈáç„Å®„ÅÆÂ∑Æ
                        if (targetWeight) {
                            const diff = weight - targetWeight;
                            document.getElementById('weight-diff').textContent = diff > 0 ? `+${diff.toFixed(1)}kg` : `${diff.toFixed(1)}kg`;
                        }
                        
                        // Ê®ôÊ∫ñ‰ΩìÈáç„ÉªÁêÜÊÉ≥‰ΩìÈáç
                        const standardWeight = 22 * heightInM * heightInM;
                        const idealWeight = 20 * heightInM * heightInM;
                        
                        document.getElementById('standard-weight').textContent = standardWeight.toFixed(1) + 'kg';
                        document.getElementById('ideal-weight').textContent = idealWeight.toFixed(1) + 'kg';
                    }
                };
                
                weightInput.addEventListener('input', calculateAndDisplay);
                heightInput.addEventListener('input', calculateAndDisplay);
                targetWeightInput.addEventListener('input', calculateAndDisplay);
            };

            // „É¨„Éº„ÉÜ„Ç£„É≥„Ç∞„Éú„Çø„É≥„ÅÆË®≠ÂÆö
            const setupRatingButtons = () => {
                document.querySelectorAll('.rating-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const name = button.dataset.name;
                        const value = button.dataset.value;
                        
                        document.querySelectorAll(`[data-name="${name}"]`).forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        
                        // Èö†„Åóinput„Çí‰ΩúÊàê„Åæ„Åü„ÅØÊõ¥Êñ∞
                        let hiddenInput = document.querySelector(`input[name="${name}"]`);
                        if (!hiddenInput) {
                            hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = name;
                            recordForm.appendChild(hiddenInput);
                        }
                        hiddenInput.value = value;
                    });
                });
            };

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÅÆË®≠ÂÆö
            const setupFormSubmission = () => {
                recordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(recordForm);
                    const data = Object.fromEntries(formData.entries());
                    
                    const today = new Date();
                    const dateKey = formatDateKey(today);
                    
                    try {
                        console.log('‰øùÂ≠òÈñãÂßã - „É¶„Éº„Ç∂„ÉºID:', currentUser?.uid);
                        console.log('‰øùÂ≠ò„Éá„Éº„Çø:', data);
                        console.log('Êó•‰ªò„Ç≠„Éº:', dateKey);
                        
                        if (!currentUser || !currentUser.uid) {
                            throw new Error('„É¶„Éº„Ç∂„Éº„ÅåË™çË®º„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                        }
                        
                        // Êó¢Â≠ò„ÅÆË®òÈå≤„ÇíÂèñÂæó„Åó„Å¶„Éû„Éº„Ç∏
                        const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                        const existingDoc = await docRef.get();
                        let existingData = {};
                        if (existingDoc.exists) {
                            existingData = existingDoc.data();
                        }
                        
                        await docRef.set({
                            ...existingData,
                            ...data,
                            date: firebase.firestore.Timestamp.fromDate(today),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        alert('Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                        await loadRecords();
                        
                        // Ë®òÈå≤Ë™≠„ÅøËæº„ÅøÂæå„Å´AIË©ï‰æ°„ÇíÂÆüË°å
                        console.log('AIË©ï‰æ°„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô:', dateKey);
                        try {
                            await generateDailyFoodSummary(dateKey);
                        } catch (error) {
                            console.error('AIË©ï‰æ°„Ç®„É©„Éº:', error);
                        }
                        
                    } catch (error) {
                        console.error('Ë®òÈå≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                        console.error('„Ç®„É©„Éº„Ç≥„Éº„Éâ:', error.code);
                        console.error('„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:', error.message);
                        alert(`Ë®òÈå≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                    }
                });
            };

            // Ë®òÈå≤„ÅÆË™≠„ÅøËæº„Åø
            const loadRecords = async () => {
                try {
                    console.log('loadRecordsÈñãÂßã - „É¶„Éº„Ç∂„Éº:', currentUser?.uid);
                    const snapshot = await db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).get();
                    records = {};
                    
                    snapshot.forEach(doc => {
                        records[doc.id] = doc.data();
                    });
                    
                    console.log('loadRecordsÂÆå‰∫Ü - records:', records);
                    
                    // „Éá„Éê„ÉÉ„Ç∞Áî®„Å´window„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
                    window.records = records;
                    
                    renderCalendar();
                    loadTodayRecord();
                    
                    // ‰ΩìÈáç„Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
                    if (window.updateWeightChart) {
                        window.updateWeightChart();
                    }
                    
                    // Ê†ÑÈ§äÂàÜÊûê„Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
                    if (window.updateNutritionChart) {
                        window.updateNutritionChart();
                    }
                    
                    // ‰ªäÊó•„ÅÆÈ£ü‰∫ã‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                    displayTodayMeals();
                    
                    // ‰ªäÊó•„ÅÆ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞Áä∂Ê≥Å„ÇíÊõ¥Êñ∞
                    displayTodayFastingStatus();
                    
                    // AIË©ï‰æ°„Ç≥„É°„É≥„Éà„ÇíË°®Á§∫
                    displayAIFoodComment();
                    
                } catch (error) {
                    console.error('Ë®òÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                }
            };

            // ‰ªäÊó•„ÅÆË®òÈå≤„ÇíË™≠„ÅøËæº„Åø
            const loadTodayRecord = () => {
                const today = new Date();
                const dateKey = formatDateKey(today);
                const todayRecord = records[dateKey];
                
                if (todayRecord) {
                    // „Éï„Ç©„Éº„É†„Å´Êó¢Â≠ò„ÅÆË®òÈå≤„ÇíË®≠ÂÆö
                    Object.keys(todayRecord).forEach(key => {
                        const input = document.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (input.type === 'hidden') {
                                input.value = todayRecord[key];
                                document.querySelector(`[data-name="${key}"][data-value="${todayRecord[key]}"]`)?.classList.add('selected');
                            } else {
                                input.value = todayRecord[key];
                            }
                        }
                    });
                    
                    // ‰ΩìÈáç„ÉªBMIË®àÁÆó„ÇíÊõ¥Êñ∞
                    if (todayRecord.weight && todayRecord.height) {
                        const weightInput = document.getElementById('weight-input');
                        const heightInput = document.getElementById('height-input');
                        
                        if (weightInput && heightInput) {
                            const event = new Event('input');
                            weightInput.dispatchEvent(event);
                        }
                    }
                }
            };

            // ‰ΩìÈáçÊé®Áßª„Ç∞„É©„Éï„ÅÆË®≠ÂÆö
            const setupWeightChart = () => {
                const ctx = document.getElementById('weight-chart').getContext('2d');
                let weightChart = null;
                let currentPeriod = 7; // „Éá„Éï„Ç©„É´„Éà„ÅØ7Êó•Èñì
                
                const chartButtons = {
                    '7days': document.getElementById('chart-7days'),
                    '30days': document.getElementById('chart-30days'),
                    '90days': document.getElementById('chart-90days')
                };
                
                // „Éú„Çø„É≥„Ç§„Éô„É≥„ÉàË®≠ÂÆö
                Object.entries(chartButtons).forEach(([key, button]) => {
                    button.addEventListener('click', () => {
                        // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                        Object.values(chartButtons).forEach(btn => {
                            btn.classList.remove('bg-pink-100', 'border-pink-300');
                        });
                        button.classList.add('bg-pink-100', 'border-pink-300');
                        
                        // ÊúüÈñì„ÇíË®≠ÂÆö
                        currentPeriod = parseInt(key.replace('days', ''));
                        updateWeightChart();
                    });
                });
                
                const updateWeightChart = () => {
                    const weightData = getWeightData(currentPeriod);
                    
                    if (weightChart) {
                        weightChart.destroy();
                    }
                    
                    weightChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: weightData.labels,
                            datasets: [{
                                label: '‰ΩìÈáç (kg)',
                                data: weightData.weights,
                                borderColor: '#E9A4B8',
                                backgroundColor: 'rgba(233, 164, 184, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            }, {
                                label: 'BMI',
                                data: weightData.bmis,
                                borderColor: '#7A9B7A',
                                backgroundColor: 'rgba(122, 155, 122, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: '‰ΩìÈáç (kg)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'BMI'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                    
                    // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                    updateWeightStats(weightData.weights);
                };
                
                const getWeightData = (days) => {
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - days + 1);
                    
                    const labels = [];
                    const weights = [];
                    const bmis = [];
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = formatDateKey(d);
                        const record = records[dateKey];
                        
                        labels.push(d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                        
                        if (record && record.weight && record.height) {
                            weights.push(parseFloat(record.weight));
                            const heightInM = parseFloat(record.height) / 100;
                            bmis.push(parseFloat(record.weight) / (heightInM * heightInM));
                        } else {
                            weights.push(null);
                            bmis.push(null);
                        }
                    }
                    
                    return { labels, weights, bmis };
                };
                
                const updateWeightStats = (weights) => {
                    const validWeights = weights.filter(w => w !== null);
                    
                    if (validWeights.length === 0) {
                        document.getElementById('max-weight').textContent = '-';
                        document.getElementById('min-weight').textContent = '-';
                        document.getElementById('avg-weight').textContent = '-';
                        document.getElementById('weight-change').textContent = '-';
                        return;
                    }
                    
                    const maxWeight = Math.max(...validWeights);
                    const minWeight = Math.min(...validWeights);
                    const avgWeight = validWeights.reduce((a, b) => a + b, 0) / validWeights.length;
                    const weightChange = validWeights.length > 1 ? validWeights[validWeights.length - 1] - validWeights[0] : 0;
                    
                    document.getElementById('max-weight').textContent = maxWeight.toFixed(1) + 'kg';
                    document.getElementById('min-weight').textContent = minWeight.toFixed(1) + 'kg';
                    document.getElementById('avg-weight').textContent = avgWeight.toFixed(1) + 'kg';
                    document.getElementById('weight-change').textContent = weightChange >= 0 ? `+${weightChange.toFixed(1)}kg` : `${weightChange.toFixed(1)}kg`;
                };
                
                // ÂàùÊúü„ÉÅ„É£„Éº„Éà‰ΩúÊàê
                window.updateWeightChart = updateWeightChart;
            };
            
            // Ê†ÑÈ§äÂàÜÊûê„Ç∞„É©„Éï„ÅÆË®≠ÂÆö
            const setupNutritionChart = () => {
                const ctx = document.getElementById('nutrition-chart').getContext('2d');
                let nutritionChart = null;
                let currentNutritionPeriod = 7; // „Éá„Éï„Ç©„É´„Éà„ÅØ7Êó•Èñì
                
                const chartButtons = {
                    '7days': document.getElementById('nutrition-7days'),
                    '30days': document.getElementById('nutrition-30days'),
                    '90days': document.getElementById('nutrition-90days')
                };
                
                // „Éú„Çø„É≥„Ç§„Éô„É≥„ÉàË®≠ÂÆö
                Object.entries(chartButtons).forEach(([key, button]) => {
                    button.addEventListener('click', () => {
                        // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                        Object.values(chartButtons).forEach(btn => {
                            btn.classList.remove('bg-green-100', 'border-green-300');
                        });
                        button.classList.add('bg-green-100', 'border-green-300');
                        
                        // ÊúüÈñì„ÇíË®≠ÂÆö
                        currentNutritionPeriod = parseInt(key.replace('days', ''));
                        updateNutritionChart();
                    });
                });
                
                const updateNutritionChart = () => {
                    const nutritionData = getNutritionData(currentNutritionPeriod);
                    
                    if (nutritionChart) {
                        nutritionChart.destroy();
                    }
                    
                    nutritionChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: nutritionData.labels,
                            datasets: [{
                                label: 'ÂãïÁâ©ÊÄßÈ£üÂìÅ',
                                data: nutritionData.animalData,
                                borderColor: '#EF4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }, {
                                label: 'Á≥ñË≥™',
                                data: nutritionData.carbData,
                                borderColor: '#F97316',
                                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }, {
                                label: '„Çø„É≥„Éë„ÇØË≥™',
                                data: nutritionData.proteinData,
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 4,
                                    ticks: {
                                        callback: function(value) {
                                            const labels = ['„Å™„Åó', 'Â∞ë„Åó', 'ÊôÆÈÄö', 'Â§ö„ÅÑ'];
                                            return labels[value] || value;
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'ÊëÇÂèñ„É¨„Éô„É´'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                    
                    // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                    updateNutritionStats(nutritionData);
                };
                
                const getNutritionData = (days) => {
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - days + 1);
                    
                    const labels = [];
                    const animalData = [];
                    const carbData = [];
                    const proteinData = [];
                    
                    // „É¨„Éô„É´„ÇíÊï∞ÂÄ§„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                    const levelToNumber = {
                        'none': 0,
                        'little': 1,
                        'moderate': 2,
                        'much': 3
                    };
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = formatDateKey(d);
                        const record = records[dateKey];
                        
                        labels.push(d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                        
                        if (record) {
                            animalData.push(levelToNumber[record.animal_food] ?? null);
                            carbData.push(levelToNumber[record.sugar_intake] ?? null);
                            // „Éó„É≠„ÉÜ„Ç§„É≥„É¨„Éô„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊé®ÂÆöÂÄ§„Çí‰ΩøÁî®
                            const proteinLevel = record.protein_level || 'moderate';
                            proteinData.push(levelToNumber[proteinLevel] ?? null);
                        } else {
                            animalData.push(null);
                            carbData.push(null);
                            proteinData.push(null);
                        }
                    }
                    
                    return { labels, animalData, carbData, proteinData };
                };
                
                const updateNutritionStats = (nutritionData) => {
                    const numberToLevel = {
                        0: '„Å™„Åó',
                        1: 'Â∞ë„Åó',
                        2: 'ÊôÆÈÄö',
                        3: 'Â§ö„ÅÑ'
                    };
                    
                    const calcAverage = (data) => {
                        const validData = data.filter(d => d !== null);
                        if (validData.length === 0) return null;
                        const avg = validData.reduce((a, b) => a + b, 0) / validData.length;
                        return Math.round(avg);
                    };
                    
                    const avgAnimal = calcAverage(nutritionData.animalData);
                    const avgCarbs = calcAverage(nutritionData.carbData);
                    const avgProtein = calcAverage(nutritionData.proteinData);
                    
                    document.getElementById('avg-animal').textContent = avgAnimal !== null ? numberToLevel[avgAnimal] : '-';
                    document.getElementById('avg-carbs').textContent = avgCarbs !== null ? numberToLevel[avgCarbs] : '-';
                    document.getElementById('avg-protein').textContent = avgProtein !== null ? numberToLevel[avgProtein] : '-';
                };
                
                // ÂàùÊúü„ÉÅ„É£„Éº„Éà‰ΩúÊàê
                window.updateNutritionChart = updateNutritionChart;
            };

            // „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆË®≠ÂÆö
            const setupCalendar = () => {
                prevMonthButton.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });

                nextMonthButton.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                closeModal.addEventListener('click', () => {
                    recordModal.classList.add('hidden');
                });

                recordModal.addEventListener('click', (e) => {
                    if (e.target === recordModal) {
                        recordModal.classList.add('hidden');
                    }
                });
            };

            // „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊèèÁîª
            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                currentMonthElement.textContent = `${year}Âπ¥ ${month + 1}Êúà`;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const today = new Date();
                const todayKey = formatDateKey(today);
                
                // ÊõúÊó•„Éò„ÉÉ„ÉÄ„Éº„Åã„ÇâÈñãÂßã
                let calendarHtml = `
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Êó•</div>
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Êúà</div>
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">ÁÅ´</div>
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Ê∞¥</div>
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Êú®</div>
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Èáë</div>
                    <div class="calendar-day font-bold text-center py-3 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700">Âúü</div>
                `;
                
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    
                    const dateKey = formatDateKey(cellDate);
                    const isToday = dateKey === todayKey;
                    const isOtherMonth = cellDate.getMonth() !== month;
                    const hasRecord = records[dateKey];
                    
                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (isOtherMonth) classes += ' other-month';
                    if (hasRecord) classes += ' has-record';
                    
                    let moodIndicator = '';
                    if (hasRecord && hasRecord.mood) {
                        const moodClass = getMoodClass(hasRecord.mood);
                        moodIndicator = `<div class="mood-indicator ${moodClass}"></div>`;
                    }
                    
                    calendarHtml += `
                        <div class="${classes}" data-date="${dateKey}">
                            <div class="font-semibold">${cellDate.getDate()}</div>
                            ${moodIndicator}
                        </div>
                    `;
                }
                
                calendarDaysContainer.innerHTML = calendarHtml;
                
                // „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                document.querySelectorAll('.calendar-day[data-date]').forEach(dayElement => {
                    dayElement.addEventListener('click', () => {
                        const dateKey = dayElement.dataset.date;
                        const record = records[dateKey];
                        
                        if (record) {
                            showRecordModal(dateKey, record);
                        }
                    });
                });
            };

            // Ë®òÈå≤„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫
            const showRecordModal = (dateKey, record) => {
                const date = new Date(dateKey);
                modalDate.textContent = formatDate(date);
                
                const labels = {
                    breakfast: 'ÊúùÈ£ü',
                    lunch: 'ÊòºÈ£ü',
                    dinner: 'Â§ïÈ£ü',
                    snacks: 'ÈñìÈ£ü„Éª„Åù„ÅÆ‰ªñ',
                    animal_food: 'ÂãïÁâ©ÊÄßÈ£üÂìÅ',
                    sugar_intake: 'Á≥ñË≥™ÊëÇÂèñ',
                    meal_frequency: 'È£ü‰∫ãÂõûÊï∞',
                    fatigue: 'Áñ≤Âä¥ÊÑü',
                    digestion: 'Ê∂àÂåñ„ÅÆË™øÂ≠ê',
                    sleep: 'Áù°Áú†„ÅÆË≥™',
                    mood: 'Ê∞óÂàÜ',
                    stress: '„Çπ„Éà„É¨„ÇπÊÑü',
                    memo: '„É°„É¢'
                };
                
                const valueLabels = {
                    animal_food: { none: 'ÊëÇÂèñ„Åó„Å¶„ÅÑ„Å™„ÅÑ', little: 'Â∞ë„Åó', moderate: 'ÊôÆÈÄö', much: 'Â§ö„ÅÑ' },
                    sugar_intake: { none: 'ÊëÇÂèñ„Åó„Å¶„ÅÑ„Å™„ÅÑ', little: 'Â∞ë„Åó', moderate: 'ÊôÆÈÄö', much: 'Â§ö„ÅÑ' }
                };
                
                let content = '<div class="space-y-3">';
                
                // È£ü‰∫ã„Ç®„É≥„Éà„É™„ÇíÂÖà„Å´Ë°®Á§∫
                if (record.meal_entries && record.meal_entries.length > 0) {
                    content += '<div class="mb-4"><h4 class="font-medium text-sm mb-2">È£ü‰∫ãË®òÈå≤</h4>';
                    const sortedMeals = record.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                    sortedMeals.forEach(meal => {
                        content += `
                            <div class="record-details">
                                <span class="font-medium">${meal.time} ${meal.content}</span>
                                <span class="ml-2 text-xs text-gray-500">${meal.amount || ''}</span>
                                ${meal.description ? `<div class="text-xs text-gray-600 mt-1">${meal.description}</div>` : ''}
                            </div>
                        `;
                    });
                    content += '</div>';
                }
                
                Object.keys(labels).forEach(key => {
                    if (record[key]) {
                        let displayValue = record[key];
                        
                        if (valueLabels[key]) {
                            displayValue = valueLabels[key][record[key]] || record[key];
                        } else if (key === 'meal_frequency') {
                            displayValue = record[key] + 'Âõû';
                        } else if (['fatigue', 'digestion', 'sleep', 'mood', 'stress'].includes(key)) {
                            displayValue = record[key] + '/5';
                        } else if (['breakfast', 'lunch', 'dinner', 'snacks'].includes(key)) {
                            displayValue = record[key];
                        }
                        
                        content += `
                            <div class="record-details">
                                <span class="font-medium">${labels[key]}:</span>
                                <span class="ml-2">${displayValue}</span>
                            </div>
                        `;
                    }
                });
                
                content += '</div>';
                modalContent.innerHTML = content;
                recordModal.classList.remove('hidden');
            };

            // Ê∞óÂàÜ„ÇØ„É©„Çπ„ÅÆÂèñÂæó
            const getMoodClass = (mood) => {
                const moodValue = parseInt(mood);
                if (moodValue >= 5) return 'mood-very-good';
                if (moodValue >= 4) return 'mood-good';
                if (moodValue >= 3) return 'mood-neutral';
                if (moodValue >= 2) return 'mood-bad';
                return 'mood-very-bad';
            };

            // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            const formatDate = (date) => {
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            };

            // Êó•‰ªò„Ç≠„Éº„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            const formatDateKey = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            // AIÈ£ü‰∫ãËß£ÊûêÊ©üËÉΩ„ÅÆË®≠ÂÆöÔºàÊóß„Éê„Éº„Ç∏„Éß„É≥ - ÁèæÂú®„ÅØ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºâ
            const setupFoodAnalysis = () => {
                // Êóß„Éê„Éº„Ç∏„Éß„É≥„ÅÆÈ£ü‰∫ãËß£ÊûêÊ©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åü„Åü„ÇÅ„ÄÅ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                console.log('setupFoodAnalysis: Êñ∞„Åó„ÅÑÂÄãÂà•È£ü‰∫ã„Ç®„É≥„Éà„É™„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®‰∏≠');
            };
            
            // AIË©ï‰æ°„Ç≥„É°„É≥„ÉàÂÜçÁîüÊàêÊ©üËÉΩ„ÅÆË®≠ÂÆö
            const setupAICommentRefresh = () => {
                const refreshButton = document.getElementById('refresh-ai-comment');
                if (refreshButton) {
                    refreshButton.addEventListener('click', async () => {
                        const today = new Date();
                        const dateKey = formatDateKey(today);
                        
                        console.log('AIË©ï‰æ°„ÇíÊâãÂãï„ÅßÂÜçÂÆüË°å:', dateKey);
                        refreshButton.textContent = 'Ë©ï‰æ°‰∏≠...';
                        refreshButton.disabled = true;
                        
                        try {
                            await generateDailyFoodSummary(dateKey);
                        } catch (error) {
                            console.error('AIË©ï‰æ°„Ç®„É©„Éº:', error);
                            alert('AIË©ï‰æ°„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                        } finally {
                            refreshButton.textContent = 'ÂÜçË©ï‰æ°';
                            refreshButton.disabled = false;
                        }
                    });
                }
            };
            
            // AIÈ£ü‰∫ãÂàÜÊûê
            const analyzeFood = async (foodText) => {
                const prompt = `‰ª•‰∏ã„ÅÆÈ£ü‰∫ãÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„Å¶„ÄÅJSONÂΩ¢Âºè„ÅßÁµêÊûú„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

È£ü‰∫ãÂÜÖÂÆπ: ${foodText}

„ÄêÈáçË¶Å„Äë„Åì„ÅÆË©ï‰æ°„ÅØ„ÄÅÂÆåÂÖ®ËèúÈ£ü‰∏ªÁæ©Ôºà„É¥„Ç£„Éº„Ç¨„É≥Ôºâ„Åã„Å§Á≥ñË≥™Âà∂Èôê„ÇíÂü∫Êú¨„Å®„Åô„ÇãÂÅ•Â∫∑ÁêÜÂøµ„Å´Âü∫„Å•„ÅÑ„Å¶Ë°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂàÜÊûêÈ†ÖÁõÆ:
1. ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÅÆÊëÇÂèñÈáèÔºànone/little/moderate/muchÔºâ‚ÄªÂãïÁâ©ÊÄßÈ£üÂìÅ„ÅØÊ∏õ„Çâ„Åô„Åπ„Åç
2. Á≥ñË≥™„ÅÆÊëÇÂèñÈáèÔºànone/little/moderate/muchÔºâ‚ÄªÁ≥ñË≥™„ÅØÂà∂Èôê„Åô„Åπ„Åç
3. „Çø„É≥„Éë„ÇØË≥™„ÅÆÊëÇÂèñÈáèÔºànone/little/moderate/muchÔºâ‚ÄªÊ§çÁâ©ÊÄß„Çø„É≥„Éë„ÇØË≥™„ÇíÊé®Â•®
4. Êé®ÂÆö„Åï„Çå„Çã‰∏ª„Å™ÊùêÊñôÔºàÈÖçÂàóÔºâ‚ÄªÊ§çÁâ©ÊÄßÈ£üÂìÅ„Çí‰∏≠ÂøÉ„Å´Ë®òËºâ
5. Ê†ÑÈ§ä„Éê„É©„É≥„Çπ„ÅÆË©ï‰æ°‚Äª„É¥„Ç£„Éº„Ç¨„É≥„ÉªÁ≥ñË≥™Âà∂Èôê„ÅÆË¶≥ÁÇπ„Åã„Çâ

JSONÂΩ¢Âºè:
{
  "animal_food_level": "none",
  "sugar_level": "little",
  "protein_level": "moderate",
  "ingredients": ["Â§ßË±Ü„Éü„Éº„Éà", "„Ç¢„Éº„É¢„É≥„Éâ", "ËëâÈáéËèú"],
  "nutrition_comment": "Ê§çÁâ©ÊÄß„Çø„É≥„Éë„ÇØË≥™„ÅåÈÅ©Âàá„Å´ÊëÇ„Çå„Å¶„ÅÑ„Åæ„Åô"
}`;
                
                try {
                    const apiKey = "AIzaSyB2_fG2KexNapPvM0gA-AThGu5SK6WFLPA";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!aiResponse) {
                        throw new Error('AIÂøúÁ≠î„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                    
                    // JSON„ÇíÊäΩÂá∫
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('ÊúâÂäπ„Å™JSON„É¨„Çπ„Éù„É≥„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                    
                    return JSON.parse(jsonMatch[0]);
                    
                } catch (error) {
                    console.error('AIÈ£ü‰∫ãÂàÜÊûê„Ç®„É©„Éº:', error);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂàÜÊûê
                    return {
                        animal_food_level: 'little',
                        sugar_level: 'little',
                        protein_level: 'moderate',
                        ingredients: ['ÂàÜÊûê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü'],
                        nutrition_comment: 'ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà„É¥„Ç£„Éº„Ç¨„É≥„ÉªÁ≥ñË≥™Âà∂Èôê„ÅÆÂéüÂâá„Å´Âü∫„Å•„ÅèË©ï‰æ°Ôºâ'
                    };
                }
            };
            
            // È£ü‰∫ãÂàÜÊûêÁµêÊûú„ÅÆË°®Á§∫
            const displayFoodAnalysis = (analysis) => {
                const levelLabels = {
                    'none': 'Â∞ë„Å™„ÅÑ',
                    'little': 'Â∞ë„Åó',
                    'moderate': 'ÊôÆÈÄö',
                    'much': 'Â§ö„ÅÑ'
                };
                
                document.getElementById('animal-score').textContent = levelLabels[analysis.animal_food_level] || '‰∏çÊòé';
                document.getElementById('carb-score').textContent = levelLabels[analysis.sugar_level] || '‰∏çÊòé';
                document.getElementById('protein-score').textContent = levelLabels[analysis.protein_level] || '‰∏çÊòé';
                
                const details = `
                    <p><strong>Êé®ÂÆöÊùêÊñô:</strong> ${analysis.ingredients ? analysis.ingredients.join(', ') : '‰∏çÊòé'}</p>
                    <p><strong>Ê†ÑÈ§äË©ï‰æ°:</strong> ${analysis.nutrition_comment || 'Ë©ï‰æ°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü'}</p>
                `;
                
                document.getElementById('food-details').innerHTML = details;
            };
            
            // ‰∏ÄÊó•ÂÖ®‰Ωì„ÅÆÈ£ü‰∫ãË©ï‰æ°ÁîüÊàê
            // ‰øÆÊ≠£Ê∏à„Åø: recordsÂ§âÊï∞„ÅÆ„Çπ„Ç≥„Éº„ÉóÂïèÈ°å„ÇíËß£Ê±∫„ÄÅ„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†„ÄÅ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞ÊîπÂñÑ
            const generateDailyFoodSummary = async (dateKey) => {
                try {
                    console.log('AIË©ï‰æ°ÈñãÂßã:', dateKey);
                    console.log('ÁèæÂú®„ÅÆrecords:', records);
                    console.log('ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº:', currentUser?.uid);
                    
                    // „Åæ„Åö„ÄÅÊó¢Â≠ò„ÅÆrecords„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâË®òÈå≤„ÇíÂèñÂæó
                    let record = records[dateKey];
                    console.log('records[dateKey]„Åã„ÇâÂèñÂæó:', record);
                    
                    // records„Å´„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÁõ¥Êé•ÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó
                    if (!record) {
                        console.log('records„Å´Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÁõ¥Êé•ÂèñÂæó');
                        const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                        const doc = await docRef.get();
                        
                        if (!doc.exists) {
                            console.log('Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', dateKey);
                            return;
                        }
                        
                        record = doc.data();
                        console.log('„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂèñÂæó„Åó„ÅüË®òÈå≤:', record);
                    }
                    
                    if (!record || !record.meal_entries || record.meal_entries.length === 0) {
                        console.log('È£ü‰∫ã„Ç®„É≥„Éà„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì:', record);
                        return;
                    }
                    
                    // ‰∏ÄÊó•„ÅÆÈ£ü‰∫ã„ÇíÊôÇÁ≥ªÂàó„ÅßÊï¥ÁêÜ
                    const meals = record.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                    console.log('Êï¥ÁêÜ„Åï„Çå„ÅüÈ£ü‰∫ã:', meals);
                    
                    const mealSummary = meals.map(meal => `${meal.time}: ${meal.content} (${meal.amount || ''})${meal.description ? ` - ${meal.description}` : ''}`).join('\\n');
                    console.log('È£ü‰∫ã„Çµ„Éû„É™„Éº:', mealSummary);
                    
                    const prompt = `‰ª•‰∏ã„ÅÆ‰∏ÄÊó•„ÅÆÈ£ü‰∫ãÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„Å¶„ÄÅÊ†ÑÈ§ä„Éê„É©„É≥„Çπ„Å®ÂÅ•Â∫∑Èù¢„Åß„ÅÆË©ï‰æ°„ÇíÊó•Êú¨Ë™û„ÅßÁ∞°ÊΩî„Å´„Ç≥„É°„É≥„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

„Äê‰∏ÄÊó•„ÅÆÈ£ü‰∫ãÂÜÖÂÆπ„Äë
${mealSummary}

„ÄêÈáçË¶Å„Å™Ë©ï‰æ°Âü∫Ê∫ñ„Äë
- ÂÆåÂÖ®ËèúÈ£ü‰∏ªÁæ©Ôºà„É¥„Ç£„Éº„Ç¨„É≥Ôºâ„ÅåÊé®Â•®„Åï„Çå„Çã
- Á≥ñË≥™Âà∂Èôê„ÅåÊé®Â•®„Åï„Çå„Çã
- Ê§çÁâ©ÊÄß„Çø„É≥„Éë„ÇØË≥™ÔºàÂ§ßË±Ü„ÄÅË±ÜÈ°û„ÄÅ„Éä„ÉÉ„ÉÑÈ°ûÔºâ„ÅÆÊëÇÂèñ„ÅåÁêÜÊÉ≥ÁöÑ
- ÂãïÁâ©ÊÄßÈ£üÂìÅÔºàËÇâ„ÄÅÈ≠ö„ÄÅÂçµ„ÄÅ‰π≥Ë£ΩÂìÅÔºâ„ÅÆÊëÇÂèñ„ÅØÊéß„Åà„Çã„Åπ„Åç
- Á≥ñË≥™ÔºàÁ±≥„ÄÅ„Éë„É≥„ÄÅÈ∫∫È°û„ÄÅÊûúÁâ©Ôºâ„ÅÆÊëÇÂèñ„ÅØÂà∂Èôê„Åô„Åπ„Åç

„ÄêË©ï‰æ°È†ÖÁõÆ„Äë
1. ÂÖ®‰ΩìÁöÑ„Å™Ê†ÑÈ§ä„Éê„É©„É≥„ÇπÔºà„É¥„Ç£„Éº„Ç¨„É≥„ÉªÁ≥ñË≥™Âà∂Èôê„ÅÆË¶≥ÁÇπ„Åã„ÇâÔºâ
2. ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÅÆÊëÇÂèñÁä∂Ê≥ÅÔºàÂ∞ë„Å™„ÅÑ„Åª„Å©ËâØ„ÅÑÔºâ
3. Á≥ñË≥™„ÅÆÊëÇÂèñÁä∂Ê≥ÅÔºàÂ∞ë„Å™„ÅÑ„Åª„Å©ËâØ„ÅÑÔºâ
4. „Çø„É≥„Éë„ÇØË≥™„ÅÆÊëÇÂèñÁä∂Ê≥ÅÔºàÊ§çÁâ©ÊÄß„Çø„É≥„Éë„ÇØË≥™„ÇíË©ï‰æ°Ôºâ
5. È£ü‰∫ã„Çø„Ç§„Éü„É≥„Ç∞ÔºàÊñ≠È£üÊôÇÈñì„ÇíËÄÉÊÖÆÔºâ
6. ÊîπÂñÑ„Ç¢„Éâ„Éê„Ç§„ÇπÔºàÊ§çÁâ©ÊÄßÈ£üÂìÅ„Å®‰ΩéÁ≥ñË≥™È£üÂìÅ„ÇíÊé®Â•®Ôºâ

„ÄêÂá∫ÂäõÂΩ¢Âºè„Äë
{
  "overall_comment": "Ê§çÁâ©ÊÄß„Çø„É≥„Éë„ÇØË≥™„ÅåÈÅ©Âàá„Å´ÊëÇ„Çå„Å¶„Åä„Çä„ÄÅÁ≥ñË≥™Âà∂Èôê„ÇÇÂÆà„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
  "animal_food_summary": "little",
  "carb_summary": "little",
  "protein_summary": "moderate",
  "timing_comment": "È£ü‰∫ãÈñìÈöî„ÅåÈÅ©Âàá„Åß„ÄÅÊñ≠È£üÊôÇÈñì„ÇÇÁ¢∫‰øù„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
  "advice": "Â§ßË±ÜË£ΩÂìÅ„ÇÑ„Éä„ÉÉ„ÉÑÈ°û„ÇíÂ¢ó„ÇÑ„Åô„Å®„Åï„Çâ„Å´ËâØ„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ"
}`;
                    
                    const apiKey = "AIzaSyB2_fG2KexNapPvM0gA-AThGu5SK6WFLPA";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                    
                    console.log('AI API„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°‰∏≠...');
                    console.log('ÈÄÅ‰ø°„Éó„É≠„É≥„Éó„Éà:', prompt);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    console.log('AI API„É¨„Çπ„Éù„É≥„Çπ:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Details:', errorText);
                        throw new Error(`API Error: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('AIÁîü„ÅÆÂøúÁ≠î:', result);
                    
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    console.log('AIÂøúÁ≠î„ÉÜ„Ç≠„Çπ„Éà:', aiResponse);
                    
                    if (aiResponse) {
                        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                        console.log('JSONÊäΩÂá∫:', jsonMatch?.[0]);
                        
                        if (jsonMatch) {
                            const summary = JSON.parse(jsonMatch[0]);
                            console.log('„Éë„Éº„ÇπÊ∏à„Åø„Çµ„Éû„É™„Éº:', summary);
                            
                            // Ë©ï‰æ°ÁµêÊûú„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
                            const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                            await docRef.update({
                                daily_food_summary: summary,
                                ai_analyzed: true,
                                ai_analysis_date: new Date().toISOString(),
                                // Êó¢Â≠ò„ÅÆÁ∞°ÊòìË©ï‰æ°„ÇÇËá™ÂãïË®≠ÂÆö
                                animal_food: summary.animal_food_summary,
                                sugar_intake: summary.carb_summary,
                                meal_frequency: meals.length.toString()
                            });
                            
                            console.log('AIË©ï‰æ°ÂÆå‰∫Ü:', summary);
                            
                            // Ë®òÈå≤„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Ç≥„É°„É≥„Éà„ÇíË°®Á§∫
                            await loadRecords();
                            console.log('AIË©ï‰æ°Âá¶ÁêÜÂÆå‰∫Ü');
                        } else {
                            console.error('JSON„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', aiResponse);
                        }
                    } else {
                        console.error('AIÂøúÁ≠î„ÅåÁ©∫„Åß„Åô:', result);
                    }
                } catch (error) {
                    console.error('‰∏ÄÊó•È£ü‰∫ãË©ï‰æ°ÁîüÊàê„Ç®„É©„Éº:', error);
                }
            };
            
            // È£ü‰∫ã„É¢„Éº„ÉÄ„É´„ÅÆË®≠ÂÆö
            const setupMealModal = () => {
                // È£ü‰∫ãËøΩÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ
                addMealBtn.addEventListener('click', () => {
                    openMealModal();
                });
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                closeMealModal.addEventListener('click', () => {
                    closeMealModalFunction();
                });
                
                cancelMealBtn.addEventListener('click', () => {
                    closeMealModalFunction();
                });
                
                // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                mealModal.addEventListener('click', (e) => {
                    if (e.target === mealModal) {
                        closeMealModalFunction();
                    }
                });
                
                // AIÂàÜÊûê„Éú„Çø„É≥
                analyzeMealBtn.addEventListener('click', () => {
                    analyzeMeal();
                });
                
                // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
                mealForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveMeal();
                });
                
                // ÂÖ•ÂäõÂ§âÊõ¥ÊôÇ„ÅÆ‰øùÂ≠ò„Éú„Çø„É≥Âà∂Âæ°
                document.getElementById('meal-content').addEventListener('input', updateSaveButton);
                document.getElementById('meal-time').addEventListener('input', updateSaveButton);
            };
            
            // È£ü‰∫ã„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            const openMealModal = () => {
                // ÁèæÂú®ÊôÇÂàª„Çí„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                const now = new Date();
                const timeString = now.toTimeString().slice(0, 5);
                document.getElementById('meal-time').value = timeString;
                
                // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                mealForm.reset();
                document.getElementById('meal-time').value = timeString; // „É™„Çª„ÉÉ„ÉàÂæå„Å´ÂÜçË®≠ÂÆö
                document.getElementById('meal-analysis-result').classList.add('hidden');
                updateSaveButton();
                
                mealModal.classList.remove('hidden');
            };
            
            // È£ü‰∫ã„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            const closeMealModalFunction = () => {
                mealModal.classList.add('hidden');
            };
            
            // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°ÂäπÂà∂Âæ°
            const updateSaveButton = () => {
                const content = document.getElementById('meal-content').value.trim();
                const time = document.getElementById('meal-time').value;
                saveMealBtn.disabled = !content || !time;
            };
            
            // AIÈ£ü‰∫ãÂàÜÊûêÔºàÂÄãÂà•„Ç®„É≥„Éà„É™Áî®Ôºâ
            const analyzeMeal = async () => {
                const content = document.getElementById('meal-content').value.trim();
                if (!content) {
                    alert('È£ü‰∫ãÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                analyzeMealBtn.textContent = 'ÂàÜÊûê‰∏≠...';
                analyzeMealBtn.disabled = true;
                
                try {
                    const analysis = await analyzeFood(content);
                    
                    // ÁµêÊûú„ÇíÁ∑®ÈõÜÂèØËÉΩ„Å™ÂΩ¢„ÅßË°®Á§∫
                    document.getElementById('meal-description').value = analysis.ingredients ? analysis.ingredients.join(', ') : '';
                    document.getElementById('meal-animal').value = analysis.animal_food_level || 'moderate';
                    document.getElementById('meal-carbs').value = analysis.sugar_level || 'moderate';
                    document.getElementById('meal-protein').value = analysis.protein_level || 'moderate';
                    
                    document.getElementById('meal-analysis-result').classList.remove('hidden');
                    updateSaveButton();
                    
                } catch (error) {
                    console.error('È£ü‰∫ãÂàÜÊûê„Ç®„É©„Éº:', error);
                    alert('ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    document.getElementById('meal-analysis-result').classList.remove('hidden');
                } finally {
                    analyzeMealBtn.textContent = 'AIÂàÜÊûê„ÇíÂÆüË°å';
                    analyzeMealBtn.disabled = false;
                }
            };
            
            // È£ü‰∫ã„Ç®„É≥„Éà„É™„Çí‰øùÂ≠ò
            const saveMeal = async () => {
                const mealData = {
                    id: Date.now().toString(),
                    time: document.getElementById('meal-time').value,
                    content: document.getElementById('meal-content').value.trim(),
                    amount: document.getElementById('meal-amount').value.trim(),
                    description: document.getElementById('meal-description').value.trim(),
                    animal_food_level: document.getElementById('meal-animal').value,
                    sugar_level: document.getElementById('meal-carbs').value,
                    protein_level: document.getElementById('meal-protein').value,
                    created_at: new Date().toISOString()
                };
                
                try {
                    // ‰ªäÊó•„ÅÆË®òÈå≤„Å´ËøΩÂä†
                    const today = new Date();
                    const dateKey = formatDateKey(today);
                    
                    if (!currentUser || !currentUser.uid) {
                        throw new Error('„É¶„Éº„Ç∂„Éº„ÅåË™çË®º„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }
                    
                    // Êó¢Â≠ò„ÅÆË®òÈå≤„ÇíÂèñÂæó
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    const doc = await docRef.get();
                    
                    let existingData = {};
                    if (doc.exists) {
                        existingData = doc.data();
                    }
                    
                    // È£ü‰∫ã„Ç®„É≥„Éà„É™„ÇíËøΩÂä†
                    const mealEntries = existingData.meal_entries || [];
                    mealEntries.push(mealData);
                    
                    await docRef.set({
                        ...existingData,
                        meal_entries: mealEntries,
                        date: firebase.firestore.Timestamp.fromDate(today),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert('È£ü‰∫ã„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                    closeMealModalFunction();
                    await loadRecords(); // Ë®òÈå≤„ÇíÂÜçË™≠„ÅøËæº„Åø
                    
                    // ‰ªäÊó•„ÅÆ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞Áä∂Ê≥Å„ÇíÊõ¥Êñ∞
                    displayTodayFastingStatus();
                    
                    // È£ü‰∫ã„Ç®„É≥„Éà„É™„ÅåËøΩÂä†„Åï„Çå„Åü„ÅÆ„ÅßAIË©ï‰æ°„ÇíÂÆüË°å
                    console.log('È£ü‰∫ãËøΩÂä†Âæå„ÅÆAIË©ï‰æ°„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô:', dateKey);
                    try {
                        await generateDailyFoodSummary(dateKey);
                    } catch (error) {
                        console.error('AIË©ï‰æ°„Ç®„É©„Éº:', error);
                    }
                    
                } catch (error) {
                    console.error('È£ü‰∫ã‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    alert(`È£ü‰∫ã„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };
            
            // ‰ªäÊó•„ÅÆÈ£ü‰∫ã‰∏ÄË¶ß„ÇíË°®Á§∫
            const displayTodayMeals = () => {
                const today = new Date();
                const dateKey = formatDateKey(today);
                const todayRecord = records[dateKey];
                
                console.log('‰ªäÊó•„ÅÆÈ£ü‰∫ãË°®Á§∫:', dateKey, todayRecord);
                
                if (!todayRecord || !todayRecord.meal_entries || todayRecord.meal_entries.length === 0) {
                    todayMealsContainer.innerHTML = '<p class="text-xs text-gray-500">„Åæ„Å†‰ªäÊó•„ÅÆÈ£ü‰∫ã„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }
                
                const meals = todayRecord.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                
                let html = '';
                meals.forEach((meal, index) => {
                    html += `
                        <div class="flex justify-between items-center p-2 bg-white rounded border text-xs">
                            <div class="flex-1">
                                <div class="font-medium">${meal.time} - ${meal.content}</div>
                                <div class="text-gray-500">${meal.amount || ''} ${meal.description || ''}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editMeal('${dateKey}', ${index})" class="text-blue-500 hover:text-blue-700">‚úèÔ∏è</button>
                                <button onclick="deleteMeal('${dateKey}', ${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                todayMealsContainer.innerHTML = html;
            };
            
            // AIÈ£ü‰∫ãË©ï‰æ°„Ç≥„É°„É≥„ÉàË°®Á§∫
            const displayAIFoodComment = () => {
                const today = new Date();
                const dateKey = formatDateKey(today);
                const todayRecord = records[dateKey];
                
                console.log('AIË©ï‰æ°„Ç≥„É°„É≥„ÉàË°®Á§∫:', dateKey, todayRecord?.daily_food_summary);
                
                if (!todayRecord || !todayRecord.daily_food_summary) {
                    document.getElementById('ai-food-comment').classList.add('hidden');
                    return;
                }
                
                const summary = todayRecord.daily_food_summary;
                
                // AIË©ï‰æ°Ë¶ÅÁ¥†„Å´Ë®≠ÂÆö
                document.getElementById('overall-comment').textContent = summary.overall_comment || '';
                document.getElementById('timing-comment').textContent = summary.timing_comment || '';
                document.getElementById('advice-comment').textContent = summary.advice || '';
                
                document.getElementById('ai-food-comment').classList.remove('hidden');
            };
            
            // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÔºàHTML„Åã„ÇâÂëº„Å≥Âá∫„ÅóÁî®Ôºâ
            window.editMeal = async (dateKey, index) => {
                const record = records[dateKey];
                if (!record || !record.meal_entries || !record.meal_entries[index]) {
                    alert('È£ü‰∫ã„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const meal = record.meal_entries[index];
                
                // „É¢„Éº„ÉÄ„É´„Å´Êó¢Â≠ò„Éá„Éº„Çø„ÇíË®≠ÂÆö
                document.getElementById('meal-time').value = meal.time;
                document.getElementById('meal-content').value = meal.content;
                document.getElementById('meal-amount').value = meal.amount || '';
                document.getElementById('meal-description').value = meal.description || '';
                document.getElementById('meal-animal').value = meal.animal_food_level || 'moderate';
                document.getElementById('meal-carbs').value = meal.sugar_level || 'moderate';
                document.getElementById('meal-protein').value = meal.protein_level || 'moderate';
                
                // ÂàÜÊûêÁµêÊûú„Ç®„É™„Ç¢„ÇíË°®Á§∫
                document.getElementById('meal-analysis-result').classList.remove('hidden');
                updateSaveButton();
                
                // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
                mealModal.classList.remove('hidden');
                
                // Á∑®ÈõÜÁî®„ÅÆÂá¶ÁêÜ„Å´Â§âÊõ¥
                const originalSubmitHandler = mealForm.onsubmit;
                mealForm.onsubmit = async (e) => {
                    e.preventDefault();
                    await updateMeal(dateKey, index);
                    mealForm.onsubmit = originalSubmitHandler;
                };
            };
            
            window.deleteMeal = async (dateKey, index) => {
                if (!confirm('„Åì„ÅÆÈ£ü‰∫ãË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    return;
                }
                
                try {
                    const record = records[dateKey];
                    if (!record || !record.meal_entries) {
                        throw new Error('Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    
                    // È£ü‰∫ã„Ç®„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                    const mealEntries = [...record.meal_entries];
                    mealEntries.splice(index, 1);
                    
                    // „Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÊõ¥Êñ∞
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    await docRef.update({
                        meal_entries: mealEntries,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('È£ü‰∫ãË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                    await loadRecords();
                    
                    // È£ü‰∫ã„Ç®„É≥„Éà„É™„ÅåÂâäÈô§„Åï„Çå„Åü„ÅÆ„ÅßAIË©ï‰æ°„ÇíÂÆüË°å
                    console.log('È£ü‰∫ãÂâäÈô§Âæå„ÅÆAIË©ï‰æ°„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô:', dateKey);
                    try {
                        await generateDailyFoodSummary(dateKey);
                    } catch (error) {
                        console.error('AIË©ï‰æ°„Ç®„É©„Éº:', error);
                    }
                    
                } catch (error) {
                    console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
                    alert(`ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };
            
            // È£ü‰∫ã„Ç®„É≥„Éà„É™„ÇíÊõ¥Êñ∞
            const updateMeal = async (dateKey, index) => {
                const mealData = {
                    id: records[dateKey].meal_entries[index].id, // Êó¢Â≠òID„Çí‰øùÊåÅ
                    time: document.getElementById('meal-time').value,
                    content: document.getElementById('meal-content').value.trim(),
                    amount: document.getElementById('meal-amount').value.trim(),
                    description: document.getElementById('meal-description').value.trim(),
                    animal_food_level: document.getElementById('meal-animal').value,
                    sugar_level: document.getElementById('meal-carbs').value,
                    protein_level: document.getElementById('meal-protein').value,
                    created_at: records[dateKey].meal_entries[index].created_at, // ‰ΩúÊàêÊó•ÊôÇ„Çí‰øùÊåÅ
                    updated_at: new Date().toISOString()
                };
                
                try {
                    const record = records[dateKey];
                    const mealEntries = [...record.meal_entries];
                    mealEntries[index] = mealData;
                    
                    // „Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÊõ¥Êñ∞
                    const docRef = db.collection(`trauma_notes_users/${currentUser.uid}/progress_records`).doc(dateKey);
                    await docRef.update({
                        meal_entries: mealEntries,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('È£ü‰∫ãË®òÈå≤„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                    closeMealModalFunction();
                    await loadRecords();
                    
                    // È£ü‰∫ã„Ç®„É≥„Éà„É™„ÅåÊõ¥Êñ∞„Åï„Çå„Åü„ÅÆ„ÅßAIË©ï‰æ°„ÇíÂÆüË°å
                    console.log('È£ü‰∫ãÊõ¥Êñ∞Âæå„ÅÆAIË©ï‰æ°„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô:', dateKey);
                    try {
                        await generateDailyFoodSummary(dateKey);
                    } catch (error) {
                        console.error('AIË©ï‰æ°„Ç®„É©„Éº:', error);
                    }
                    
                } catch (error) {
                    console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
                    alert(`Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };
            
            // È£ü‰∫ãÈñìÈöîÂàÜÊûêÈñ¢Êï∞
            const calculateFastingIntervals = (records) => {
                const intervals = [];
                
                // Ë®òÈå≤„ÇíÊó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„Éà
                const sortedDates = Object.keys(records).sort();
                
                sortedDates.forEach(dateKey => {
                    const record = records[dateKey];
                    if (record && record.meal_entries && record.meal_entries.length > 0) {
                        const meals = record.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                        const date = new Date(dateKey);
                        
                        // „Åù„ÅÆÊó•„ÅÆÊúÄÂàù„Å®ÊúÄÂæå„ÅÆÈ£ü‰∫ãÊôÇÂàª„ÇíÂèñÂæó
                        const firstMeal = meals[0];
                        const lastMeal = meals[meals.length - 1];
                        
                        const firstMealTime = new Date(date);
                        const [firstHour, firstMinute] = firstMeal.time.split(':').map(Number);
                        firstMealTime.setHours(firstHour, firstMinute, 0, 0);
                        
                        const lastMealTime = new Date(date);
                        const [lastHour, lastMinute] = lastMeal.time.split(':').map(Number);
                        lastMealTime.setHours(lastHour, lastMinute, 0, 0);
                        
                        intervals.push({
                            date: dateKey,
                            firstMeal: firstMealTime,
                            lastMeal: lastMealTime,
                            meals: meals,
                            mealCount: meals.length,
                            eatingWindow: (lastMealTime - firstMealTime) / (1000 * 60 * 60) // ÊôÇÈñìÂçò‰Ωç
                        });
                    }
                });
                
                return intervals;
            };
            
            const calculateFastingStats = (intervals) => {
                if (intervals.length === 0) return null;
                
                const fastingPeriods = [];
                
                // ÈÄ£Á∂ö„Åô„ÇãÊó•„ÅÆ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„ÇíË®àÁÆó
                for (let i = 0; i < intervals.length - 1; i++) {
                    const current = intervals[i];
                    const next = intervals[i + 1];
                    
                    // ÁøîÊó•„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    const currentDate = new Date(current.date);
                    const nextDate = new Date(next.date);
                    const dayDiff = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
                    
                    if (dayDiff === 1) {
                        const fastingHours = (next.firstMeal - current.lastMeal) / (1000 * 60 * 60);
                        fastingPeriods.push({
                            from: current.date,
                            to: next.date,
                            hours: fastingHours
                        });
                    }
                }
                
                // „Çπ„Çø„ÉÉ„Éà„ÇíË®àÁÆó
                const avgFasting = fastingPeriods.length > 0 ? 
                    fastingPeriods.reduce((sum, p) => sum + p.hours, 0) / fastingPeriods.length : 0;
                
                const maxFasting = fastingPeriods.length > 0 ? 
                    Math.max(...fastingPeriods.map(p => p.hours)) : 0;
                
                const avgEatingWindow = intervals.length > 0 ? 
                    intervals.reduce((sum, i) => sum + i.eatingWindow, 0) / intervals.length : 0;
                
                // IF„Çπ„Ç≥„Ç¢„ÇíË®àÁÆóÔºà„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„ÅåÈï∑„ÅÑ„Åª„Å©È´ò„ÅÑÔºâ
                let ifScore = 0;
                if (avgFasting >= 16) ifScore += 40; // 16ÊôÇÈñì‰ª•‰∏ä
                else if (avgFasting >= 14) ifScore += 30; // 14ÊôÇÈñì‰ª•‰∏ä
                else if (avgFasting >= 12) ifScore += 20; // 12ÊôÇÈñì‰ª•‰∏ä
                else if (avgFasting >= 10) ifScore += 10; // 10ÊôÇÈñì‰ª•‰∏ä
                
                if (avgEatingWindow <= 8) ifScore += 30; // 8ÊôÇÈñì‰ª•‰∏ã„ÅÆÈ£ü‰∫ã„Ç¶„Ç£„É≥„Éâ„Ç¶
                else if (avgEatingWindow <= 10) ifScore += 20;
                else if (avgEatingWindow <= 12) ifScore += 10;
                
                // È£ü‰∫ãÂõûÊï∞„ÅåÂ∞ë„Å™„ÅÑ„Åª„Å©È´ò„ÅÑ„Çπ„Ç≥„Ç¢
                const avgMealCount = intervals.reduce((sum, i) => sum + i.mealCount, 0) / intervals.length;
                if (avgMealCount <= 2) ifScore += 30;
                else if (avgMealCount <= 2.5) ifScore += 20;
                else if (avgMealCount <= 3) ifScore += 10;
                
                return {
                    avgFasting: avgFasting,
                    maxFasting: maxFasting,
                    avgEatingWindow: avgEatingWindow,
                    ifScore: Math.min(ifScore, 100), // ÊúÄÂ§ß100ÁÇπ
                    fastingPeriods: fastingPeriods
                };
            };
            
            const displayTodayFastingStatus = () => {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                const todayKey = formatDateKey(today);
                const yesterdayKey = formatDateKey(yesterday);
                
                console.log('displayTodayFastingStatus - todayKey:', todayKey);
                console.log('displayTodayFastingStatus - records:', records);
                
                const todayRecord = records[todayKey];
                const yesterdayRecord = records[yesterdayKey];
                
                console.log('displayTodayFastingStatus - todayRecord:', todayRecord);
                
                const statusDiv = document.getElementById('today-fasting-status');
                
                if (!todayRecord || !todayRecord.meal_entries || todayRecord.meal_entries.length === 0) {
                    console.log('displayTodayFastingStatus - È£ü‰∫ãË®òÈå≤„Å™„Åó');
                    statusDiv.innerHTML = '<p>‰ªäÊó•„ÅÆÈ£ü‰∫ã„Åå„Åæ„Å†Ë®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }
                
                const todayMeals = todayRecord.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                const firstMeal = todayMeals[0];
                const lastMeal = todayMeals[todayMeals.length - 1];
                
                const firstMealTime = new Date(today);
                const [firstHour, firstMinute] = firstMeal.time.split(':').map(Number);
                firstMealTime.setHours(firstHour, firstMinute, 0, 0);
                
                const lastMealTime = new Date(today);
                const [lastHour, lastMinute] = lastMeal.time.split(':').map(Number);
                lastMealTime.setHours(lastHour, lastMinute, 0, 0);
                
                const eatingWindow = (lastMealTime - firstMealTime) / (1000 * 60 * 60);
                
                let fastingFromYesterday = 0;
                if (yesterdayRecord && yesterdayRecord.meal_entries && yesterdayRecord.meal_entries.length > 0) {
                    const yesterdayMeals = yesterdayRecord.meal_entries.sort((a, b) => a.time.localeCompare(b.time));
                    const lastYesterdayMeal = yesterdayMeals[yesterdayMeals.length - 1];
                    
                    const lastYesterdayTime = new Date(yesterday);
                    const [lastYHour, lastYMinute] = lastYesterdayMeal.time.split(':').map(Number);
                    lastYesterdayTime.setHours(lastYHour, lastYMinute, 0, 0);
                    
                    fastingFromYesterday = (firstMealTime - lastYesterdayTime) / (1000 * 60 * 60);
                }
                
                let statusHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">È£ü‰∫ãÂõûÊï∞</div>
                            <div class="font-bold text-lg">${todayMeals.length}Âõû</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500">È£ü‰∫ã„Ç¶„Ç£„É≥„Éâ„Ç¶</div>
                            <div class="font-bold text-lg">${eatingWindow.toFixed(1)}ÊôÇÈñì</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500">ÂàùÈ£üÊôÇÂàª</div>
                            <div class="font-bold text-lg">${firstMeal.time}</div>
                        </div>
                    </div>
                `;
                
                if (fastingFromYesterday > 0) {
                    statusHtml += `
                        <div class="text-center p-2 bg-green-100 rounded">
                            <div class="text-xs text-green-600">Êò®Êó•„Åã„Çâ„ÅÆ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞</div>
                            <div class="font-bold text-lg text-green-700">${fastingFromYesterday.toFixed(1)}ÊôÇÈñì</div>
                        </div>
                    `;
                }
                
                // „Ç¢„Éâ„Éê„Ç§„Çπ„ÇíËøΩÂä†
                if (firstHour <= 7) {
                    statusHtml += '<div class="text-xs text-orange-600 mt-2">‚ö†Ô∏è ÊúùÊó©„ÅÑÈ£ü‰∫ã„ÅØ‰Ωì„Å´Ë≤†ÊãÖ„Çí„Åã„Åë„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô</div>';
                }
                
                if (eatingWindow > 12) {
                    statusHtml += '<div class="text-xs text-orange-600 mt-2">‚ö†Ô∏è È£ü‰∫ã„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÈï∑„ÅÑ„Åß„Åô„ÄÇ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„ÇíÂª∂„Å∞„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ</div>';
                } else if (eatingWindow <= 8) {
                    statusHtml += '<div class="text-xs text-green-600 mt-2">‚úì ÁêÜÊÉ≥ÁöÑ„Å™È£ü‰∫ã„Ç¶„Ç£„É≥„Éâ„Ç¶„Åß„ÅôÔºÅ</div>';
                }
                
                if (fastingFromYesterday >= 16) {
                    statusHtml += '<div class="text-xs text-green-600 mt-2">‚úì ÂÑ™ÁßÄ„Å™„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„Åß„ÅôÔºÅ</div>';
                }
                
                statusDiv.innerHTML = statusHtml;
            };
            
            const updateIntervalChart = (days) => {
                const ctx = document.getElementById('interval-chart').getContext('2d');
                
                if (intervalChart) {
                    intervalChart.destroy();
                }
                
                const endDate = new Date();
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - days + 1);
                
                const intervals = calculateFastingIntervals(records);
                const stats = calculateFastingStats(intervals);
                
                const labels = [];
                const fastingData = [];
                const eatingWindowData = [];
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateKey = formatDateKey(d);
                    labels.push(d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                    
                    const intervalData = intervals.find(i => i.date === dateKey);
                    if (intervalData) {
                        eatingWindowData.push(intervalData.eatingWindow);
                        
                        // ÂâçÊó•„Åã„Çâ„ÅÆ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„ÇíÊ§úÁ¥¢
                        const fastingPeriod = stats?.fastingPeriods?.find(p => p.to === dateKey);
                        fastingData.push(fastingPeriod ? fastingPeriod.hours : null);
                    } else {
                        fastingData.push(null);
                        eatingWindowData.push(null);
                    }
                }
                
                intervalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì',
                            data: fastingData,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y'
                        }, {
                            label: 'È£ü‰∫ã„Ç¶„Ç£„É≥„Éâ„Ç¶',
                            data: eatingWindowData,
                            borderColor: 'rgb(251, 146, 60)',
                            backgroundColor: 'rgba(251, 146, 60, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `È£ü‰∫ãÈñìÈöîÂàÜÊûê (${days}Êó•Èñì)`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ÊôÇÈñì'
                                }
                            }
                        },
                        elements: {
                            point: {
                                radius: 4
                            }
                        }
                    }
                });
                
                // „Çπ„Çø„ÉÉ„Éà„ÇíÊõ¥Êñ∞
                if (stats) {
                    document.getElementById('avg-fasting').textContent = `${stats.avgFasting.toFixed(1)}ÊôÇÈñì`;
                    document.getElementById('max-fasting').textContent = `${stats.maxFasting.toFixed(1)}ÊôÇÈñì`;
                    document.getElementById('avg-eating-window').textContent = `${stats.avgEatingWindow.toFixed(1)}ÊôÇÈñì`;
                    document.getElementById('if-score').textContent = `${stats.ifScore}/100`;
                } else {
                    document.getElementById('avg-fasting').textContent = '-';
                    document.getElementById('max-fasting').textContent = '-';
                    document.getElementById('avg-eating-window').textContent = '-';
                    document.getElementById('if-score').textContent = '-';
                }
            };
            
            // È£ü‰∫ãÈñìÈöî„ÉÅ„É£„Éº„Éà„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            let intervalChart;
            let currentIntervalPeriod = 7;
            
            document.getElementById('interval-7days').addEventListener('click', () => {
                currentIntervalPeriod = 7;
                updateIntervalChart(7);
                updateIntervalButtons('interval-7days');
            });
            
            document.getElementById('interval-30days').addEventListener('click', () => {
                currentIntervalPeriod = 30;
                updateIntervalChart(30);
                updateIntervalButtons('interval-30days');
            });
            
            document.getElementById('interval-90days').addEventListener('click', () => {
                currentIntervalPeriod = 90;
                updateIntervalChart(90);
                updateIntervalButtons('interval-90days');
            });
            
            const updateIntervalButtons = (activeId) => {
                ['interval-7days', 'interval-30days', 'interval-90days'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (id === activeId) {
                        btn.className = 'animated-button px-4 py-2 text-sm bg-orange-100 text-orange-700 border border-orange-300 rounded-full hover:bg-orange-200';
                    } else {
                        btn.className = 'px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors';
                    }
                });
            };
            
            // Áõ∏Èñ¢ÂàÜÊûêÈñ¢Êï∞
            const calculateCorrelation = (x, y) => {
                const validPairs = [];
                for (let i = 0; i < x.length; i++) {
                    if (x[i] !== null && y[i] !== null && !isNaN(x[i]) && !isNaN(y[i])) {
                        validPairs.push({ x: x[i], y: y[i] });
                    }
                }
                
                if (validPairs.length < 3) return null;
                
                const n = validPairs.length;
                const sumX = validPairs.reduce((sum, p) => sum + p.x, 0);
                const sumY = validPairs.reduce((sum, p) => sum + p.y, 0);
                const sumXY = validPairs.reduce((sum, p) => sum + p.x * p.y, 0);
                const sumX2 = validPairs.reduce((sum, p) => sum + p.x * p.x, 0);
                const sumY2 = validPairs.reduce((sum, p) => sum + p.y * p.y, 0);
                
                const numerator = n * sumXY - sumX * sumY;
                const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
                
                if (denominator === 0) return null;
                return numerator / denominator;
            };
            
            const prepareCorrelationData = (days) => {
                const endDate = new Date();
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - days + 1);
                
                const data = [];
                const intervals = calculateFastingIntervals(records);
                const stats = calculateFastingStats(intervals);
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateKey = formatDateKey(d);
                    const record = records[dateKey];
                    
                    if (record) {
                        const levelToNumber = {
                            'none': 0,
                            'little': 1,
                            'moderate': 2,
                            'much': 3
                        };
                        
                        const intervalData = intervals.find(i => i.date === dateKey);
                        const fastingPeriod = stats?.fastingPeriods?.find(p => p.to === dateKey);
                        
                        data.push({
                            date: dateKey,
                            weight: record.weight || null,
                            mood: record.mood || null,
                            stress: record.stress || null,
                            fatigue: record.fatigue || null,
                            digestion: record.digestion || null,
                            sleep: record.sleep || null,
                            animalFood: levelToNumber[record.animal_food] ?? null,
                            carbs: levelToNumber[record.sugar_intake] ?? null,
                            protein: levelToNumber[record.protein_level] ?? null,
                            fastingHours: fastingPeriod ? fastingPeriod.hours : null,
                            eatingWindow: intervalData ? intervalData.eatingWindow : null,
                            mealCount: intervalData ? intervalData.mealCount : null
                        });
                    } else {
                        data.push({
                            date: dateKey,
                            weight: null,
                            mood: null,
                            stress: null,
                            fatigue: null,
                            digestion: null,
                            sleep: null,
                            animalFood: null,
                            carbs: null,
                            protein: null,
                            fastingHours: null,
                            eatingWindow: null,
                            mealCount: null
                        });
                    }
                }
                
                return data;
            };
            
            const updateCorrelationChart = (days, targetVariable) => {
                const ctx = document.getElementById('correlation-chart').getContext('2d');
                
                if (correlationChart) {
                    correlationChart.destroy();
                }
                
                const data = prepareCorrelationData(days);
                
                const labels = data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                });
                
                const targetData = data.map(d => d[targetVariable]);
                
                const datasets = [];
                const colors = {
                    animalFood: 'rgb(239, 68, 68)',
                    carbs: 'rgb(251, 146, 60)',
                    protein: 'rgb(59, 130, 246)',
                    fastingHours: 'rgb(34, 197, 94)',
                    mealCount: 'rgb(168, 85, 247)'
                };
                
                // „É°„Ç§„É≥„Çø„Éº„Ç≤„ÉÉ„Éà„Éá„Éº„Çø„ÇíËøΩÂä†
                let targetLabel = '';
                let targetColor = '';
                
                switch (targetVariable) {
                    case 'weight':
                        targetLabel = '‰ΩìÈáç';
                        targetColor = 'rgb(236, 72, 153)';
                        break;
                    case 'mood':
                        targetLabel = 'Ê∞óÂàÜ';
                        targetColor = 'rgb(251, 191, 36)';
                        break;
                    case 'stress':
                        targetLabel = '„Çπ„Éà„É¨„Çπ';
                        targetColor = 'rgb(239, 68, 68)';
                        break;
                    case 'fatigue':
                        targetLabel = 'Áñ≤Âä¥ÊÑü';
                        targetColor = 'rgb(99, 102, 241)';
                        break;
                    case 'digestion':
                        targetLabel = 'Ê∂àÂåñ„ÅÆË™øÂ≠ê';
                        targetColor = 'rgb(34, 197, 94)';
                        break;
                    case 'sleep':
                        targetLabel = 'Áù°Áú†„ÅÆË≥™';
                        targetColor = 'rgb(168, 85, 247)';
                        break;
                }
                
                datasets.push({
                    label: targetLabel,
                    data: targetData,
                    borderColor: targetColor,
                    backgroundColor: targetColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    tension: 0.1,
                    yAxisID: 'y1'
                });
                
                // È£ü‰∫ã„Éá„Éº„Çø„ÇíËøΩÂä†
                const foodVariables = ['animalFood', 'carbs', 'protein', 'fastingHours', 'mealCount'];
                foodVariables.forEach(variable => {
                    const variableData = data.map(d => d[variable]);
                    let label = '';
                    
                    switch (variable) {
                        case 'animalFood':
                            label = 'ÂãïÁâ©ÊÄßÈ£üÂìÅ';
                            break;
                        case 'carbs':
                            label = 'Á≥ñË≥™';
                            break;
                        case 'protein':
                            label = '„Çø„É≥„Éë„ÇØË≥™';
                            break;
                        case 'fastingHours':
                            label = '„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì';
                            break;
                        case 'mealCount':
                            label = 'È£ü‰∫ãÂõûÊï∞';
                            break;
                    }
                    
                    datasets.push({
                        label: label,
                        data: variableData,
                        borderColor: colors[variable],
                        backgroundColor: colors[variable].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                        tension: 0.1,
                        yAxisID: 'y2'
                    });
                });
                
                correlationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${targetLabel}„Å®È£ü‰∫ã„Éá„Éº„Çø„ÅÆÁõ∏Èñ¢ÂàÜÊûê (${days}Êó•Èñì)`
                            }
                        },
                        scales: {
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: targetLabel
                                }
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'È£ü‰∫ã„Éá„Éº„Çø'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        elements: {
                            point: {
                                radius: 3
                            }
                        }
                    }
                });
                
                // Áõ∏Èñ¢‰øÇÊï∞„ÇíË®àÁÆó„Åó„Å¶Ë°®Á§∫
                const correlations = {};
                foodVariables.forEach(variable => {
                    const variableData = data.map(d => d[variable]);
                    const correlation = calculateCorrelation(targetData, variableData);
                    correlations[variable] = correlation;
                });
                
                updateCorrelationStats(correlations);
                generateCorrelationInsights(correlations, targetVariable);
            };
            
            const updateCorrelationStats = (correlations) => {
                const formatCorrelation = (value) => {
                    if (value === null) return '-';
                    return value.toFixed(3);
                };
                
                const getCorrelationColor = (value) => {
                    if (value === null) return 'text-gray-500';
                    if (Math.abs(value) >= 0.7) return 'text-red-600';
                    if (Math.abs(value) >= 0.3) return 'text-orange-600';
                    return 'text-green-600';
                };
                
                document.getElementById('animal-correlation').textContent = formatCorrelation(correlations.animalFood);
                document.getElementById('animal-correlation').className = `font-bold ${getCorrelationColor(correlations.animalFood)}`;
                
                document.getElementById('carbs-correlation').textContent = formatCorrelation(correlations.carbs);
                document.getElementById('carbs-correlation').className = `font-bold ${getCorrelationColor(correlations.carbs)}`;
                
                document.getElementById('protein-correlation').textContent = formatCorrelation(correlations.protein);
                document.getElementById('protein-correlation').className = `font-bold ${getCorrelationColor(correlations.protein)}`;
                
                document.getElementById('fasting-correlation').textContent = formatCorrelation(correlations.fastingHours);
                document.getElementById('fasting-correlation').className = `font-bold ${getCorrelationColor(correlations.fastingHours)}`;
                
                document.getElementById('meal-count-correlation').textContent = formatCorrelation(correlations.mealCount);
                document.getElementById('meal-count-correlation').className = `font-bold ${getCorrelationColor(correlations.mealCount)}`;
            };
            
            const generateCorrelationInsights = (correlations, targetVariable) => {
                const insights = [];
                
                const getVariableName = (variable) => {
                    switch (variable) {
                        case 'weight': return '‰ΩìÈáç';
                        case 'mood': return 'Ê∞óÂàÜ';
                        case 'stress': return '„Çπ„Éà„É¨„Çπ';
                        case 'fatigue': return 'Áñ≤Âä¥ÊÑü';
                        case 'digestion': return 'Ê∂àÂåñ„ÅÆË™øÂ≠ê';
                        case 'sleep': return 'Áù°Áú†„ÅÆË≥™';
                        default: return variable;
                    }
                };
                
                const targetName = getVariableName(targetVariable);
                
                // Âº∑„ÅÑÁõ∏Èñ¢„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                Object.entries(correlations).forEach(([key, value]) => {
                    if (value !== null) {
                        let foodName = '';
                        switch (key) {
                            case 'animalFood':
                                foodName = 'ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÅÆÊëÇÂèñ';
                                break;
                            case 'carbs':
                                foodName = 'Á≥ñË≥™„ÅÆÊëÇÂèñ';
                                break;
                            case 'protein':
                                foodName = '„Çø„É≥„Éë„ÇØË≥™„ÅÆÊëÇÂèñ';
                                break;
                            case 'fastingHours':
                                foodName = '„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì';
                                break;
                            case 'mealCount':
                                foodName = 'È£ü‰∫ãÂõûÊï∞';
                                break;
                        }
                        
                        if (Math.abs(value) >= 0.7) {
                            const direction = value > 0 ? 'Ê≠£„ÅÆ' : 'Ë≤†„ÅÆ';
                            insights.push(`üîç ${foodName}„Å®${targetName}„Å´Âº∑„ÅÑ${direction}Áõ∏Èñ¢„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${value.toFixed(3)}Ôºâ`);
                        } else if (Math.abs(value) >= 0.3) {
                            const direction = value > 0 ? 'Ê≠£„ÅÆ' : 'Ë≤†„ÅÆ';
                            insights.push(`üîç ${foodName}„Å®${targetName}„Å´‰∏≠Á®ãÂ∫¶„ÅÆ${direction}Áõ∏Èñ¢„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${value.toFixed(3)}Ôºâ`);
                        }
                    }
                });
                
                // „É¥„Ç£„Éº„Ç¨„É≥„ÉªÁ≥ñË≥™Âà∂Èôê„Å´Âü∫„Å•„Åè„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíËøΩÂä†
                if (targetVariable === 'weight') {
                    if (correlations.fastingHours && correlations.fastingHours < -0.3) {
                        insights.push('‚ú® „Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„ÇíÂª∂„Å∞„Åô„Åì„Å®„Åß‰ΩìÈáçÁÆ°ÁêÜ„Å´ÂäπÊûú„Åå„ÅÇ„Çä„Åù„ÅÜ„Åß„Åô');
                    }
                    if (correlations.mealCount && correlations.mealCount > 0.3) {
                        insights.push('‚ú® È£ü‰∫ãÂõûÊï∞„ÇíÊ∏õ„Çâ„Åô„Åì„Å®„Åß‰ΩìÈáçÁÆ°ÁêÜ„Å´ÂäπÊûú„Åå„ÅÇ„Çä„Åù„ÅÜ„Åß„Åô');
                    }
                    if (correlations.animalFood && correlations.animalFood > 0.3) {
                        insights.push('‚ú® ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÇíÊ∏õ„Çâ„Åô„Åì„Å®„Åß‰ΩìÈáçÁÆ°ÁêÜ„Å´ÂäπÊûú„Åå„ÅÇ„Çä„Åù„ÅÜ„Åß„Åô');
                    }
                    if (correlations.carbohydrates && correlations.carbohydrates > 0.3) {
                        insights.push('‚ú® Á≥ñË≥™Âà∂Èôê„Çí„Åô„Çã„Åì„Å®„Åß‰ΩìÈáçÁÆ°ÁêÜ„Å´ÂäπÊûú„Åå„ÅÇ„Çä„Åù„ÅÜ„Åß„Åô');
                    }
                }
                
                if (targetVariable === 'mood' || targetVariable === 'stress') {
                    if (correlations.animalFood && correlations.animalFood > 0.3) {
                        insights.push('‚ú® ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÇíÊ∏õ„Çâ„Åô„Åì„Å®„Åß„É°„É≥„Çø„É´„Éò„É´„Çπ„ÅåÊîπÂñÑ„Åó„Åù„ÅÜ„Åß„Åô');
                    }
                    if (correlations.fastingHours && correlations.fastingHours < -0.3) {
                        insights.push('‚ú® „Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞„Åå„É°„É≥„Çø„É´„Éò„É´„Çπ„Å´ËâØ„ÅÑÂΩ±Èüø„Çí‰∏é„Åà„Å¶„ÅÑ„Çã„Çà„ÅÜ„Åß„Åô');
                    }
                    if (correlations.carbohydrates && correlations.carbohydrates > 0.3) {
                        insights.push('‚ú® Á≥ñË≥™Âà∂Èôê„Åå„É°„É≥„Çø„É´„Éò„É´„Çπ„Å´ËâØ„ÅÑÂΩ±Èüø„Çí‰∏é„Åà„Å¶„ÅÑ„Çã„Çà„ÅÜ„Åß„Åô');
                    }
                }
                
                if (targetVariable === 'health') {
                    if (correlations.animalFood && correlations.animalFood > 0.3) {
                        insights.push('‚ú® ÂãïÁâ©ÊÄßÈ£üÂìÅ„ÇíÊ∏õ„Çâ„Åô„Åì„Å®„Åß‰ΩìË™øÊîπÂñÑ„Å´ÂäπÊûú„Åå„ÅÇ„Çä„Åù„ÅÜ„Åß„Åô');
                    }
                    if (correlations.carbohydrates && correlations.carbohydrates > 0.3) {
                        insights.push('‚ú® Á≥ñË≥™Âà∂Èôê„Åå‰ΩìË™øÊîπÂñÑ„Å´ËâØ„ÅÑÂΩ±Èüø„Çí‰∏é„Åà„Å¶„ÅÑ„Çã„Çà„ÅÜ„Åß„Åô');
                    }
                    if (correlations.plantProtein && correlations.plantProtein < -0.3) {
                        insights.push('‚ú® Ê§çÁâ©ÊÄß„Çø„É≥„Éë„ÇØË≥™„ÇíÂ¢ó„ÇÑ„Åô„Åì„Å®„Åß‰ΩìË™øÊîπÂñÑ„Å´ÂäπÊûú„Åå„ÅÇ„Çä„Åù„ÅÜ„Åß„Åô');
                    }
                }
                
                if (insights.length === 0) {
                    insights.push('ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åß„ÅØÊòéÁ¢∫„Å™Áõ∏Èñ¢Èñ¢‰øÇ„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Çà„ÇäÂ§ö„Åè„ÅÆ„Éá„Éº„Çø„ÇíË®òÈå≤„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ');
                }
                
                const insightsElement = document.getElementById('correlation-insights');
                insightsElement.innerHTML = insights.map(insight => `<p>${insight}</p>`).join('');
            };
            
            // Áõ∏Èñ¢ÂàÜÊûê„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            let correlationChart;
            let currentCorrelationPeriod = 7;
            let currentCorrelationTarget = 'weight';
            
            // ÊúüÈñì„Éú„Çø„É≥
            document.getElementById('correlation-7days').addEventListener('click', () => {
                currentCorrelationPeriod = 7;
                updateCorrelationChart(7, currentCorrelationTarget);
                updateCorrelationButtons('correlation-7days');
            });
            
            document.getElementById('correlation-30days').addEventListener('click', () => {
                currentCorrelationPeriod = 30;
                updateCorrelationChart(30, currentCorrelationTarget);
                updateCorrelationButtons('correlation-30days');
            });
            
            document.getElementById('correlation-90days').addEventListener('click', () => {
                currentCorrelationPeriod = 90;
                updateCorrelationChart(90, currentCorrelationTarget);
                updateCorrelationButtons('correlation-90days');
            });
            
            // „Çø„Éº„Ç≤„ÉÉ„Éà„Éú„Çø„É≥
            document.getElementById('tab-weight-correlation').addEventListener('click', () => {
                currentCorrelationTarget = 'weight';
                updateCorrelationChart(currentCorrelationPeriod, 'weight');
                updateCorrelationTabs('tab-weight-correlation');
            });
            
            document.getElementById('tab-mood-correlation').addEventListener('click', () => {
                currentCorrelationTarget = 'mood';
                updateCorrelationChart(currentCorrelationPeriod, 'mood');
                updateCorrelationTabs('tab-mood-correlation');
            });
            
            document.getElementById('tab-health-correlation').addEventListener('click', () => {
                currentCorrelationTarget = 'digestion';
                updateCorrelationChart(currentCorrelationPeriod, 'digestion');
                updateCorrelationTabs('tab-health-correlation');
            });
            
            document.getElementById('tab-comprehensive-correlation').addEventListener('click', () => {
                // Á∑èÂêàÂàÜÊûê„ÅÆÂ†¥Âêà„ÅØË§áÊï∞„ÅÆÊåáÊ®ô„ÇíË°®Á§∫
                updateComprehensiveCorrelationChart(currentCorrelationPeriod);
                updateCorrelationTabs('tab-comprehensive-correlation');
            });
            
            const updateCorrelationButtons = (activeId) => {
                ['correlation-7days', 'correlation-30days', 'correlation-90days'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (id === activeId) {
                        btn.className = 'animated-button px-4 py-2 text-sm bg-indigo-100 text-indigo-700 border border-indigo-300 rounded-full hover:bg-indigo-200';
                    } else {
                        btn.className = 'px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors';
                    }
                });
            };
            
            const updateCorrelationTabs = (activeId) => {
                ['tab-weight-correlation', 'tab-mood-correlation', 'tab-health-correlation', 'tab-comprehensive-correlation'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (id === activeId) {
                        btn.className = 'animated-button px-4 py-2 text-sm bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-full';
                    } else {
                        btn.className = 'px-4 py-2 text-sm border rounded-full hover:bg-gray-100 transition-colors';
                    }
                });
            };
            
            const updateComprehensiveCorrelationChart = (days) => {
                const ctx = document.getElementById('correlation-chart').getContext('2d');
                
                if (correlationChart) {
                    correlationChart.destroy();
                }
                
                const data = prepareCorrelationData(days);
                const labels = data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                });
                
                // Ë§áÊï∞„ÅÆÊåáÊ®ô„ÇíË°®Á§∫
                const datasets = [
                    {
                        label: '‰ΩìÈáç',
                        data: data.map(d => d.weight),
                        borderColor: 'rgb(236, 72, 153)',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Ê∞óÂàÜ',
                        data: data.map(d => d.mood),
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y2'
                    },
                    {
                        label: '„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì',
                        data: data.map(d => d.fastingHours),
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y3'
                    }
                ];
                
                correlationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Á∑èÂêàÂàÜÊûê (${days}Êó•Èñì)`
                            }
                        },
                        scales: {
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '‰ΩìÈáç'
                                }
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Ê∞óÂàÜ„Éª‰ΩìË™ø'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            y3: {
                                type: 'linear',
                                display: false,
                                position: 'right'
                            }
                        },
                        elements: {
                            point: {
                                radius: 3
                            }
                        }
                    }
                });
                
                // Á∑èÂêàÂàÜÊûê„ÅÆÁµêÊûú„ÇíË°®Á§∫
                const comprehensiveInsights = [
                    'üîç ‰ΩìÈáç„ÄÅÊ∞óÂàÜ„ÄÅ„Éï„Ç°„Çπ„ÉÜ„Ç£„É≥„Ç∞ÊôÇÈñì„ÅÆÂÖ®‰ΩìÁöÑ„Å™„Éà„É¨„É≥„Éâ„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô',
                    'üîç ÂêÑÊåáÊ®ô„ÅÆÈÄ£Âãï„ÇÑ„Éë„Çø„Éº„É≥„ÇíË¶≥ÂØü„Åó„Å¶„ÄÅÁ∑èÂêàÁöÑ„Å™ÂÅ•Â∫∑ÁÆ°ÁêÜ„Å´Ê¥ªÁî®„Åó„Åæ„Åó„Çá„ÅÜ'
                ];
                
                document.getElementById('correlation-insights').innerHTML = comprehensiveInsights.map(insight => `<p>${insight}</p>`).join('');
                
                // Á∑èÂêàÁöÑ„Å™Áõ∏Èñ¢„ÇíË°®Á§∫
                const weightData = data.map(d => d.weight);
                const moodData = data.map(d => d.mood);
                const fastingData = data.map(d => d.fastingHours);
                
                const weightMoodCorr = calculateCorrelation(weightData, moodData);
                const weightFastingCorr = calculateCorrelation(weightData, fastingData);
                const moodFastingCorr = calculateCorrelation(moodData, fastingData);
                
                const comprehensiveCorrelations = {
                    animalFood: null,
                    carbs: null,
                    protein: null,
                    fastingHours: weightFastingCorr,
                    mealCount: null
                };
                
                updateCorrelationStats(comprehensiveCorrelations);
            };
            
            // ÂàùÊúüË™≠„ÅøËæº„ÅøÊôÇ„Å´È£ü‰∫ãÈñìÈöîÂàÜÊûê„Å®Áõ∏Èñ¢ÂàÜÊûê„ÇíËøΩÂä†
            const updateCharts = () => {
                if (window.updateWeightChart) window.updateWeightChart();
                if (window.updateNutritionChart) window.updateNutritionChart();
                updateIntervalChart(currentIntervalPeriod);
                displayTodayFastingStatus();
                updateCorrelationChart(currentCorrelationPeriod, currentCorrelationTarget);
            };

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÊ©üËÉΩ
            const setupFeedbackSystem = () => {
                const feedbackButton = document.getElementById('feedback-button');
                let feedbackModal = null;

                feedbackButton.addEventListener('click', () => {
                    if (feedbackModal) return;

                    feedbackModal = document.createElement('div');
                    feedbackModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50';
                    feedbackModal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                            <div class="p-6">
                                <h2 class="text-xl font-bold mb-4">„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÈÄÅ‰ø°</h2>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Á®ÆÈ°û</label>
                                    <select id="feedback-type" class="w-full p-2 border rounded-lg">
                                        <option value="improvement">ÊîπÂñÑË¶ÅÊúõ</option>
                                        <option value="bug">„Éê„Ç∞Â†±Âëä</option>
                                        <option value="other">„Åù„ÅÆ‰ªñ</option>
                                    </select>
                                </div>
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-2">„É°„ÉÉ„Çª„Éº„Ç∏</label>
                                    <textarea id="feedback-text" placeholder="„ÅîÊÑèË¶ã„Éª„ÅîË¶ÅÊúõ„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ..." class="w-full h-32 p-3 border rounded-lg"></textarea>
                                </div>
                                <div class="flex gap-3 justify-end">
                                    <button id="feedback-cancel" class="px-4 py-2 border rounded-lg hover:bg-gray-50">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button id="feedback-submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ÈÄÅ‰ø°</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(feedbackModal);

                    const submitBtn = feedbackModal.querySelector('#feedback-submit');
                    const cancelBtn = feedbackModal.querySelector('#feedback-cancel');
                    const textArea = feedbackModal.querySelector('#feedback-text');
                    const typeSelect = feedbackModal.querySelector('#feedback-type');

                    const closeFeedback = () => {
                        document.body.removeChild(feedbackModal);
                        feedbackModal = null;
                    };

                    cancelBtn.addEventListener('click', closeFeedback);

                    submitBtn.addEventListener('click', async () => {
                        const feedbackText = textArea.value.trim();
                        if (!feedbackText) return;

                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÈÄÅ‰ø°‰∏≠...';

                        try {
                            const currentUser = auth.currentUser;
                            
                            // Firestore„Å´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí‰øùÂ≠ò
                            await db.collection('feedback').add({
                                userId: currentUser.uid,
                                userEmail: currentUser.email,
                                feedbackType: typeSelect.value,
                                message: feedbackText,
                                page: 'progress-tracker',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                userAgent: navigator.userAgent
                            });

                            // SlackÈÄöÁü•„ÅØÂæå„ÅßCloud FunctionÁµåÁî±„ÅßÂÆüË£Ö‰∫àÂÆö
                            console.log('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈÄÅ‰ø°ÂÆå‰∫ÜÔºàFirestore„Å´‰øùÂ≠òÊ∏à„ÅøÔºâ');

                            alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
                            closeFeedback();
                        } catch (error) {
                            console.error('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                            alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'ÈÄÅ‰ø°';
                        }
                    });
                });
            };

            setupFeedbackSystem();
        });
    </script>
</body>
</html>