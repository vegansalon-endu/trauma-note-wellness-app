<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë®∫Êñ≠Â±•Ê≠¥ - „Ç®„É≥„Éâ„Ç•„Éª„Ç¶„Çß„É´„Éç„Çπ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">„Ç®„É≥„Éâ„Ç•„Éª„Ç¶„Çß„É´„Éç„Çπ</h1>
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='index.html'" class="text-sm text-gray-600 hover:text-gray-800">„Éõ„Éº„É†</button>
                <span id="user-email" class="text-sm text-gray-600"></span>
                <button id="logout-button" class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1 rounded border hover:bg-gray-50">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </div>
    </header>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Ë®∫Êñ≠Â±•Ê≠¥</h2>
            <p class="text-gray-600">„Åì„Çå„Åæ„Åß„ÅÆË®∫Êñ≠ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂÅ•Â∫∑ÊîπÂñÑ„ÅÆÈÄ≤Êçó„ÇíËøΩË∑°„Åß„Åç„Åæ„Åô</p>
        </div>

        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Ë®∫Êñ≠Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>

        <!-- „Ç®„É©„ÉºË°®Á§∫ -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-red-800" id="error-text"></p>
        </div>

        <!-- Ë®∫Êñ≠Â±•Ê≠¥„Å™„Åó„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="no-history" class="hidden text-center py-12">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                <span class="text-3xl">üìã</span>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Ë®∫Êñ≠Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
            <p class="text-gray-500 mb-6">„Åæ„Åö„ÅØAIË®∫Êñ≠„ÇíÂèó„Åë„Å¶„Åø„Åæ„Åó„Çá„ÅÜ</p>
            <button onclick="window.location.href='ai-shindan.html'" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                AIË®∫Êñ≠„ÇíÂèó„Åë„Çã
            </button>
        </div>

        <!-- Ë®∫Êñ≠Â±•Ê≠¥„É™„Çπ„Éà -->
        <div id="history-list" class="hidden">
            <!-- Ë®∫Êñ≠ÁµêÊûú„Ç´„Éº„Éâ‰∏ÄË¶ß -->
            <div id="diagnosis-cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- „Ç´„Éº„Éâ„ÅØJavaScript„ÅßÂãïÁöÑÁîüÊàê -->
            </div>
        </div>

        <!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
        <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Ë®∫Êñ≠ÁµêÊûúË©≥Á¥∞</h3>
                        <button id="close-detail" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="detail-content">
                        <!-- Ë©≥Á¥∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØJavaScript„ÅßÂãïÁöÑÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyCSK2XMhrPQbZ8J1y-Kz3YCoU45rDKv1bM",
            authDomain: "trauma-note-app.firebaseapp.com",
            projectId: "trauma-note-app",
            storageBucket: "trauma-note-app.appspot.com",
            messagingSenderId: "643740992546",
            appId: "1:643740992546:web:dba603fed8f73b09c9f67b"
        };

        // FirebaseÂàùÊúüÂåñ
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let allDiagnoses = [];

        // DOMË¶ÅÁ¥†
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const errorTextEl = document.getElementById('error-text');
        const noHistoryEl = document.getElementById('no-history');
        const historyListEl = document.getElementById('history-list');
        const diagnosisCardsEl = document.getElementById('diagnosis-cards');
        const detailModal = document.getElementById('detail-modal');
        const detailContent = document.getElementById('detail-content');
        const userEmailEl = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                userEmailEl.textContent = user.email;
                loadDiagnosisHistory();
            } else {
                window.location.href = 'index.html';
            }
        });

        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // Ë®∫Êñ≠Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø
        async function loadDiagnosisHistory() {
            try {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('ai_diagnoses')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allDiagnoses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                loadingEl.classList.add('hidden');
                
                if (allDiagnoses.length === 0) {
                    noHistoryEl.classList.remove('hidden');
                } else {
                    historyListEl.classList.remove('hidden');
                    renderDiagnosisCards();
                }
            } catch (error) {
                console.error('Ë®∫Êñ≠Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                loadingEl.classList.add('hidden');
                showError('Ë®∫Êñ≠Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            errorTextEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // Ë®∫Êñ≠ÁµêÊûú„Ç´„Éº„Éâ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderDiagnosisCards() {
            diagnosisCardsEl.innerHTML = allDiagnoses.map(diagnosis => {
                const date = diagnosis.createdAt?.toDate?.() || new Date();
                const dateStr = date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return `
                    <div class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onclick="viewDetails('${diagnosis.id}')">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-bold text-gray-900">${diagnosis.title || 'Ë®∫Êñ≠ÁµêÊûú'}</h3>
                                <span class="text-sm text-gray-500">${dateStr}</span>
                            </div>
                            
                            ${diagnosis.basicInfo ? `
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Âü∫Êú¨ÊÉÖÂ†±</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>Âπ¥ÈΩ¢: ${diagnosis.basicInfo.age || 'N/A'}Ê≠≥</div>
                                        <div>ÊÄßÂà•: ${diagnosis.basicInfo.gender || 'N/A'}</div>
                                        <div>BMI: ${diagnosis.basicInfo.bmi ? diagnosis.basicInfo.bmi.toFixed(1) : 'N/A'}</div>
                                        <div>ÁõÆÊ®ô‰ΩìÈáç: ${diagnosis.basicInfo.targetWeight || 'N/A'}kg</div>
                                    </div>
                                </div>
                            ` : ''}

                            ${diagnosis.scores ? `
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">„Çπ„Ç≥„Ç¢</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>Ë∫´‰ΩìÁóáÁä∂: ${diagnosis.scores.physicalSymptoms || 0}/25</div>
                                        <div>Á≤æÁ•ûÁóáÁä∂: ${diagnosis.scores.mentalSymptoms || 0}/30</div>
                                        <div>È£üÁîüÊ¥ª: ${diagnosis.scores.dietaryHabits || 0}/65</div>
                                        <div class="font-semibold">Á∑èÂêà: ${diagnosis.scores.total || 0}/120</div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); viewDetails('${diagnosis.id}')" 
                                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                    Ë©≥Á¥∞„ÇíË¶ã„Çã
                                </button>
                                <button onclick="event.stopPropagation(); deleteDiagnosis('${diagnosis.id}')" 
                                        class="bg-red-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-600 transition-colors">
                                    ÂâäÈô§
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Ë©≥Á¥∞Ë°®Á§∫
        function viewDetails(diagnosisId) {
            const diagnosis = allDiagnoses.find(d => d.id === diagnosisId);
            if (!diagnosis) return;
            
            const date = diagnosis.createdAt?.toDate?.() || new Date();
            const dateStr = date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            detailContent.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-2">${diagnosis.title || 'Ë®∫Êñ≠ÁµêÊûú'}</h2>
                    <p class="text-gray-500">${dateStr}</p>
                </div>
                
                ${diagnosis.basicInfo ? `
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">Âü∫Êú¨ÊÉÖÂ†±</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>Âπ¥ÈΩ¢: ${diagnosis.basicInfo.age || 'N/A'}Ê≠≥</div>
                            <div>ÊÄßÂà•: ${diagnosis.basicInfo.gender || 'N/A'}</div>
                            <div>Ë∫´Èï∑: ${diagnosis.basicInfo.height || 'N/A'}cm</div>
                            <div>‰ΩìÈáç: ${diagnosis.basicInfo.weight || 'N/A'}kg</div>
                            <div>ÁõÆÊ®ô‰ΩìÈáç: ${diagnosis.basicInfo.targetWeight || 'N/A'}kg</div>
                            <div>BMI: ${diagnosis.basicInfo.bmi ? diagnosis.basicInfo.bmi.toFixed(1) : 'N/A'}</div>
                        </div>
                    </div>
                ` : ''}

                ${diagnosis.scores ? `
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">Ë©ï‰æ°„Çπ„Ç≥„Ç¢</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>Ë∫´‰ΩìÁóáÁä∂: ${diagnosis.scores.physicalSymptoms || 0}/25</div>
                            <div>Á≤æÁ•ûÁóáÁä∂: ${diagnosis.scores.mentalSymptoms || 0}/30</div>
                            <div>È£üÁîüÊ¥ª: ${diagnosis.scores.dietaryHabits || 0}/65</div>
                            <div class="font-semibold text-lg">Á∑èÂêà„Çπ„Ç≥„Ç¢: ${diagnosis.scores.total || 0}/120</div>
                        </div>
                    </div>
                ` : ''}

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Ë®∫Êñ≠„É¨„Éù„Éº„Éà</h3>
                    <div class="prose max-w-none bg-white p-4 rounded-lg border">
                        ${diagnosis.report ? diagnosis.report.replace(/\n/g, '<br>') : '„É¨„Éù„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}
                    </div>
                </div>
            `;
            
            detailModal.classList.remove('hidden');
        }

        // Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.getElementById('close-detail').addEventListener('click', () => {
            detailModal.classList.add('hidden');
        });

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                detailModal.classList.add('hidden');
            }
        });

        // Ë®∫Êñ≠ÁµêÊûú„ÅÆÂâäÈô§
        async function deleteDiagnosis(diagnosisId) {
            if (!confirm('„Åì„ÅÆË®∫Êñ≠ÁµêÊûú„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                return;
            }
            
            try {
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('ai_diagnoses')
                    .doc(diagnosisId)
                    .delete();
                
                allDiagnoses = allDiagnoses.filter(d => d.id !== diagnosisId);
                
                if (allDiagnoses.length === 0) {
                    historyListEl.classList.add('hidden');
                    noHistoryEl.classList.remove('hidden');
                } else {
                    renderDiagnosisCards();
                }
                
                // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
                if (!detailModal.classList.contains('hidden')) {
                    detailModal.classList.add('hidden');
                }
            } catch (error) {
                console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !detailModal.classList.contains('hidden')) {
                detailModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>