<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºæ–­å±¥æ­´ - ã‚¨ãƒ³ãƒ‰ã‚¥ãƒ»ã‚¦ã‚§ãƒ«ãƒã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">ã‚¨ãƒ³ãƒ‰ã‚¥ãƒ»ã‚¦ã‚§ãƒ«ãƒã‚¹</h1>
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='index.html'" class="text-sm text-gray-600 hover:text-gray-800">ãƒ›ãƒ¼ãƒ </button>
                <span id="user-email" class="text-sm text-gray-600"></span>
                <button id="logout-button" class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1 rounded border hover:bg-gray-50">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">è¨ºæ–­å±¥æ­´</h2>
            <p class="text-gray-600">ã“ã‚Œã¾ã§ã®è¨ºæ–­çµæœã‚’ç¢ºèªã—ã€å¥åº·æ”¹å–„ã®é€²æ—ã‚’è¿½è·¡ã§ãã¾ã™</p>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">è¨ºæ–­å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-red-800" id="error-text"></p>
        </div>

        <!-- è¨ºæ–­å±¥æ­´ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="no-history" class="hidden text-center py-12">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                <span class="text-3xl">ğŸ“‹</span>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">è¨ºæ–­å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p class="text-gray-500 mb-6">ã¾ãšã¯AIè¨ºæ–­ã‚’å—ã‘ã¦ã¿ã¾ã—ã‚‡ã†</p>
            <button onclick="window.location.href='ai-shindan.html'" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                AIè¨ºæ–­ã‚’å—ã‘ã‚‹
            </button>
        </div>

        <!-- è¨ºæ–­å±¥æ­´ãƒªã‚¹ãƒˆ -->
        <div id="history-list" class="hidden">
            <!-- è¨ºæ–­çµæœã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div id="diagnosis-cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">è¨ºæ–­çµæœè©³ç´°</h3>
                        <button id="close-detail" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="detail-content">
                        <!-- è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCSK2XMhrPQbZ8J1y-Kz3YCoU45rDKv1bM",
            authDomain: "trauma-note-app.firebaseapp.com",
            projectId: "trauma-note-app",
            storageBucket: "trauma-note-app.appspot.com",
            messagingSenderId: "643740992546",
            appId: "1:643740992546:web:dba603fed8f73b09c9f67b"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let allDiagnoses = [];

        // DOMè¦ç´ 
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const errorTextEl = document.getElementById('error-text');
        const noHistoryEl = document.getElementById('no-history');
        const historyListEl = document.getElementById('history-list');
        const diagnosisCardsEl = document.getElementById('diagnosis-cards');
        const detailModal = document.getElementById('detail-modal');
        const detailContent = document.getElementById('detail-content');
        const userEmailEl = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                userEmailEl.textContent = user.email;
                loadDiagnosisHistory();
            } else {
                window.location.href = 'index.html';
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿
        async function loadDiagnosisHistory() {
            try {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('ai_diagnoses')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allDiagnoses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                loadingEl.classList.add('hidden');
                
                if (allDiagnoses.length === 0) {
                    noHistoryEl.classList.remove('hidden');
                } else {
                    historyListEl.classList.remove('hidden');
                    renderDiagnosisCards();
                }
            } catch (error) {
                console.error('è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                loadingEl.classList.add('hidden');
                showError('è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            errorTextEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // è¨ºæ–­çµæœã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderDiagnosisCards() {
            diagnosisCardsEl.innerHTML = allDiagnoses.map(diagnosis => {
                const date = diagnosis.createdAt?.toDate?.() || new Date();
                const dateStr = date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return `
                    <div class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onclick="viewDetails('${diagnosis.id}')">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-bold text-gray-900">${diagnosis.title || 'è¨ºæ–­çµæœ'}</h3>
                                <span class="text-sm text-gray-500">${dateStr}</span>
                            </div>
                            
                            ${diagnosis.basicInfo ? `
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">åŸºæœ¬æƒ…å ±</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>å¹´é½¢: ${diagnosis.basicInfo.age || 'N/A'}æ­³</div>
                                        <div>æ€§åˆ¥: ${diagnosis.basicInfo.gender || 'N/A'}</div>
                                        <div>BMI: ${diagnosis.basicInfo.bmi ? diagnosis.basicInfo.bmi.toFixed(1) : 'N/A'}</div>
                                        <div>ç›®æ¨™ä½“é‡: ${diagnosis.basicInfo.targetWeight || 'N/A'}kg</div>
                                    </div>
                                </div>
                            ` : ''}

                            ${diagnosis.scores ? `
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">ã‚¹ã‚³ã‚¢</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>èº«ä½“ç—‡çŠ¶: ${diagnosis.scores.physicalSymptoms || 0}/25</div>
                                        <div>ç²¾ç¥ç—‡çŠ¶: ${diagnosis.scores.mentalSymptoms || 0}/30</div>
                                        <div>é£Ÿç”Ÿæ´»: ${diagnosis.scores.dietaryHabits || 0}/65</div>
                                        <div class="font-semibold">ç·åˆ: ${diagnosis.scores.total || 0}/120</div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); viewDetails('${diagnosis.id}')" 
                                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                    è©³ç´°ã‚’è¦‹ã‚‹
                                </button>
                                <button onclick="event.stopPropagation(); deleteDiagnosis('${diagnosis.id}')" 
                                        class="bg-red-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-600 transition-colors">
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // è©³ç´°è¡¨ç¤º
        function viewDetails(diagnosisId) {
            const diagnosis = allDiagnoses.find(d => d.id === diagnosisId);
            if (!diagnosis) return;
            
            const date = diagnosis.createdAt?.toDate?.() || new Date();
            const dateStr = date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            detailContent.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-2">${diagnosis.title || 'è¨ºæ–­çµæœ'}</h2>
                    <p class="text-gray-500">${dateStr}</p>
                </div>
                
                ${diagnosis.basicInfo ? `
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">åŸºæœ¬æƒ…å ±</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>å¹´é½¢: ${diagnosis.basicInfo.age || 'N/A'}æ­³</div>
                            <div>æ€§åˆ¥: ${diagnosis.basicInfo.gender || 'N/A'}</div>
                            <div>èº«é•·: ${diagnosis.basicInfo.height || 'N/A'}cm</div>
                            <div>ä½“é‡: ${diagnosis.basicInfo.weight || 'N/A'}kg</div>
                            <div>ç›®æ¨™ä½“é‡: ${diagnosis.basicInfo.targetWeight || 'N/A'}kg</div>
                            <div>BMI: ${diagnosis.basicInfo.bmi ? diagnosis.basicInfo.bmi.toFixed(1) : 'N/A'}</div>
                        </div>
                    </div>
                ` : ''}

                ${diagnosis.scores ? `
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">è©•ä¾¡ã‚¹ã‚³ã‚¢</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>èº«ä½“ç—‡çŠ¶: ${diagnosis.scores.physicalSymptoms || 0}/25</div>
                            <div>ç²¾ç¥ç—‡çŠ¶: ${diagnosis.scores.mentalSymptoms || 0}/30</div>
                            <div>é£Ÿç”Ÿæ´»: ${diagnosis.scores.dietaryHabits || 0}/65</div>
                            <div class="font-semibold text-lg">ç·åˆã‚¹ã‚³ã‚¢: ${diagnosis.scores.total || 0}/120</div>
                        </div>
                    </div>
                ` : ''}

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                    <div class="prose max-w-none bg-white p-4 rounded-lg border">
                        ${diagnosis.report ? diagnosis.report.replace(/\n/g, '<br>') : 'ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'}
                    </div>
                </div>
            `;
            
            detailModal.classList.remove('hidden');
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.getElementById('close-detail').addEventListener('click', () => {
            detailModal.classList.add('hidden');
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                detailModal.classList.add('hidden');
            }
        });

        // è¨ºæ–­çµæœã®å‰Šé™¤
        async function deleteDiagnosis(diagnosisId) {
            if (!confirm('ã“ã®è¨ºæ–­çµæœã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('ai_diagnoses')
                    .doc(diagnosisId)
                    .delete();
                
                allDiagnoses = allDiagnoses.filter(d => d.id !== diagnosisId);
                
                if (allDiagnoses.length === 0) {
                    historyListEl.classList.add('hidden');
                    noHistoryEl.classList.remove('hidden');
                } else {
                    renderDiagnosisCards();
                }
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
                if (!detailModal.classList.contains('hidden')) {
                    detailModal.classList.add('hidden');
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !detailModal.classList.contains('hidden')) {
                detailModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>