<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºæ–­å±¥æ­´ - ã‚¨ãƒ³ãƒ‰ã‚¥ãƒ»ã‚¦ã‚§ãƒ«ãƒã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">ã‚¨ãƒ³ãƒ‰ã‚¥ãƒ»ã‚¦ã‚§ãƒ«ãƒã‚¹</h1>
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='index.html'" class="text-sm text-gray-600 hover:text-gray-800">ãƒ›ãƒ¼ãƒ </button>
                <span id="user-email" class="text-sm text-gray-600"></span>
                <button id="logout-button" class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1 rounded border hover:bg-gray-50">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">è¨ºæ–­å±¥æ­´</h2>
            <p class="text-gray-600">ã“ã‚Œã¾ã§ã®è¨ºæ–­çµæœã‚’ç¢ºèªã—ã€æ”¹å–„ãƒ—ãƒ©ãƒ³ã‚’æ¯”è¼ƒã§ãã¾ã™</p>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">è¨ºæ–­å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-red-800"></p>
        </div>

        <!-- è¨ºæ–­å±¥æ­´ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="no-history" class="hidden text-center py-12">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                <span class="text-3xl">ğŸ“‹</span>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">è¨ºæ–­å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p class="text-gray-500 mb-6">ã¾ãšã¯AIè¨ºæ–­ã‚’å—ã‘ã¦ã¿ã¾ã—ã‚‡ã†</p>
            <button onclick="window.location.href='ai-shindan.html'" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                AIè¨ºæ–­ã‚’å—ã‘ã‚‹
            </button>
        </div>

        <!-- è¨ºæ–­å±¥æ­´ãƒªã‚¹ãƒˆ -->
        <div id="history-list" class="hidden">
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ -->
            <div class="bg-white rounded-lg p-4 mb-6 flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">ä¸¦ã³æ›¿ãˆ:</label>
                    <select id="sort-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        <option value="newest">æ–°ã—ã„é †</option>
                        <option value="oldest">å¤ã„é †</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰:</label>
                    <button id="compare-toggle" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm hover:bg-gray-300 transition-colors">
                        æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ON
                    </button>
                </div>
                <div id="compare-actions" class="hidden flex items-center space-x-2">
                    <button id="compare-selected" class="bg-purple-600 text-white px-4 py-2 rounded-md text-sm hover:bg-purple-700 transition-colors">
                        é¸æŠã—ãŸè¨ºæ–­çµæœã‚’æ¯”è¼ƒ
                    </button>
                    <button id="clear-selection" class="bg-gray-500 text-white px-4 py-2 rounded-md text-sm hover:bg-gray-600 transition-colors">
                        é¸æŠã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- è¨ºæ–­çµæœã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div id="diagnosis-cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="compare-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">è¨ºæ–­çµæœæ¯”è¼ƒ</h3>
                        <button id="close-compare" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="compare-content" class="grid gap-6">
                        <!-- æ¯”è¼ƒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCSK2XMhrPQbZ8J1y-Kz3YCoU45rDKv1bM",
            authDomain: "trauma-note-app.firebaseapp.com",
            projectId: "trauma-note-app",
            storageBucket: "trauma-note-app.appspot.com",
            messagingSenderId: "643740992546",
            appId: "1:643740992546:web:dba603fed8f73b09c9f67b"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let allDiagnoses = [];
        let selectedDiagnoses = [];
        let compareMode = false;

        // DOMè¦ç´ 
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const noHistoryEl = document.getElementById('no-history');
        const historyListEl = document.getElementById('history-list');
        const diagnosisCardsEl = document.getElementById('diagnosis-cards');
        const sortSelect = document.getElementById('sort-select');
        const compareToggle = document.getElementById('compare-toggle');
        const compareActions = document.getElementById('compare-actions');
        const compareModal = document.getElementById('compare-modal');
        const userEmailEl = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                userEmailEl.textContent = user.email;
                loadDiagnosisHistory();
            } else {
                window.location.href = 'index.html';
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿
        async function loadDiagnosisHistory() {
            try {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('ai_diagnoses')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allDiagnoses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                loadingEl.classList.add('hidden');
                
                if (allDiagnoses.length === 0) {
                    noHistoryEl.classList.remove('hidden');
                } else {
                    historyListEl.classList.remove('hidden');
                    renderDiagnosisCards();
                }
            } catch (error) {
                console.error('è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                loadingEl.classList.add('hidden');
                showError('è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            errorEl.querySelector('p').textContent = message;
            errorEl.classList.remove('hidden');
        }

        // è¨ºæ–­çµæœã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderDiagnosisCards() {
            const sortedDiagnoses = [...allDiagnoses].sort((a, b) => {
                const sortOrder = sortSelect.value;
                if (sortOrder === 'newest') {
                    return b.createdAt?.toDate() - a.createdAt?.toDate();
                } else {
                    return a.createdAt?.toDate() - b.createdAt?.toDate();
                }
            });

            diagnosisCardsEl.innerHTML = sortedDiagnoses.map(diagnosis => {
                const date = diagnosis.createdAt?.toDate();
                const dateStr = date ? date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'æ—¥ä»˜ä¸æ˜';

                const isSelected = selectedDiagnoses.includes(diagnosis.id);
                
                return `
                    <div class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow ${isSelected ? 'ring-2 ring-purple-500' : ''}" data-diagnosis-id="${diagnosis.id}">
                        ${compareMode ? `
                            <div class="p-4 border-b">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                           onchange="toggleSelection('${diagnosis.id}')"
                                           class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                                    <span class="text-sm font-medium text-gray-700">æ¯”è¼ƒå¯¾è±¡ã«é¸æŠ</span>
                                </label>
                            </div>
                        ` : ''}
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-bold text-gray-900">${diagnosis.title || 'è¨ºæ–­çµæœ'}</h3>
                                <span class="text-sm text-gray-500">${dateStr}</span>
                            </div>
                            
                            ${diagnosis.basicInfo ? `
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">åŸºæœ¬æƒ…å ±</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>å¹´é½¢: ${diagnosis.basicInfo.age}æ­³</div>
                                        <div>æ€§åˆ¥: ${diagnosis.basicInfo.gender}</div>
                                        <div>BMI: ${diagnosis.basicInfo.bmi?.toFixed(1) || 'N/A'}</div>
                                        <div>ç›®æ¨™ä½“é‡: ${diagnosis.basicInfo.targetWeight}kg</div>
                                    </div>
                                </div>
                            ` : ''}

                            ${diagnosis.scores ? `
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">ã‚¹ã‚³ã‚¢</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>èº«ä½“ç—‡çŠ¶: ${diagnosis.scores.physicalSymptoms}/25</div>
                                        <div>ç²¾ç¥ç—‡çŠ¶: ${diagnosis.scores.mentalSymptoms}/30</div>
                                        <div>é£Ÿç”Ÿæ´»: ${diagnosis.scores.dietaryHabits}/65</div>
                                        <div>ç·åˆ: ${diagnosis.scores.total}/120</div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex space-x-2">
                                <button onclick="viewDetails('${diagnosis.id}')" 
                                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                    è©³ç´°ã‚’è¦‹ã‚‹
                                </button>
                                <button onclick="deleteDiagnosis('${diagnosis.id}')" 
                                        class="bg-red-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-600 transition-colors">
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚½ãƒ¼ãƒˆå¤‰æ›´
        sortSelect.addEventListener('change', renderDiagnosisCards);

        // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
        compareToggle.addEventListener('click', () => {
            compareMode = !compareMode;
            selectedDiagnoses = [];
            compareToggle.textContent = compareMode ? 'æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰OFF' : 'æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ON';
            compareToggle.className = compareMode 
                ? 'bg-purple-600 text-white px-4 py-2 rounded-md text-sm hover:bg-purple-700 transition-colors'
                : 'bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm hover:bg-gray-300 transition-colors';
            compareActions.classList.toggle('hidden', !compareMode);
            renderDiagnosisCards();
        });

        // é¸æŠã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleSelection(diagnosisId) {
            if (selectedDiagnoses.includes(diagnosisId)) {
                selectedDiagnoses = selectedDiagnoses.filter(id => id !== diagnosisId);
            } else {
                selectedDiagnoses.push(diagnosisId);
            }
            renderDiagnosisCards();
        }

        // é¸æŠã‚’ã‚¯ãƒªã‚¢
        document.getElementById('clear-selection').addEventListener('click', () => {
            selectedDiagnoses = [];
            renderDiagnosisCards();
        });

        // é¸æŠã—ãŸè¨ºæ–­çµæœã‚’æ¯”è¼ƒ
        document.getElementById('compare-selected').addEventListener('click', () => {
            if (selectedDiagnoses.length < 2) {
                alert('æ¯”è¼ƒã™ã‚‹ã«ã¯2ã¤ä»¥ä¸Šã®è¨ºæ–­çµæœã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            showCompareModal();
        });

        // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        function showCompareModal() {
            const selectedData = allDiagnoses.filter(d => selectedDiagnoses.includes(d.id));
            const compareContent = document.getElementById('compare-content');
            
            compareContent.innerHTML = `
                <div class="grid gap-6" style="grid-template-columns: repeat(${selectedData.length}, 1fr);">
                    ${selectedData.map(diagnosis => {
                        const date = diagnosis.createdAt?.toDate()?.toLocaleDateString('ja-JP') || 'æ—¥ä»˜ä¸æ˜';
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-lg mb-2">${diagnosis.title || 'è¨ºæ–­çµæœ'}</h4>
                                <p class="text-sm text-gray-500 mb-4">${date}</p>
                                
                                ${diagnosis.basicInfo ? `
                                    <div class="mb-4">
                                        <h5 class="font-semibold text-sm mb-2">åŸºæœ¬æƒ…å ±</h5>
                                        <div class="text-xs space-y-1">
                                            <div>å¹´é½¢: ${diagnosis.basicInfo.age}æ­³</div>
                                            <div>BMI: ${diagnosis.basicInfo.bmi?.toFixed(1) || 'N/A'}</div>
                                            <div>ç›®æ¨™ä½“é‡: ${diagnosis.basicInfo.targetWeight}kg</div>
                                        </div>
                                    </div>
                                ` : ''}

                                ${diagnosis.scores ? `
                                    <div class="mb-4">
                                        <h5 class="font-semibold text-sm mb-2">ã‚¹ã‚³ã‚¢</h5>
                                        <div class="text-xs space-y-1">
                                            <div>èº«ä½“ç—‡çŠ¶: ${diagnosis.scores.physicalSymptoms}/25</div>
                                            <div>ç²¾ç¥ç—‡çŠ¶: ${diagnosis.scores.mentalSymptoms}/30</div>
                                            <div>é£Ÿç”Ÿæ´»: ${diagnosis.scores.dietaryHabits}/65</div>
                                            <div class="font-semibold">ç·åˆ: ${diagnosis.scores.total}/120</div>
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="text-xs">
                                    <h5 class="font-semibold mb-2">ãƒ¬ãƒãƒ¼ãƒˆæ¦‚è¦</h5>
                                    <div class="max-h-32 overflow-y-auto text-gray-600">
                                        ${diagnosis.report ? diagnosis.report.substring(0, 200) + '...' : 'ãƒ¬ãƒãƒ¼ãƒˆãªã—'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            compareModal.classList.remove('hidden');
        }

        // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.getElementById('close-compare').addEventListener('click', () => {
            compareModal.classList.add('hidden');
        });

        // è©³ç´°è¡¨ç¤º
        function viewDetails(diagnosisId) {
            const diagnosis = allDiagnoses.find(d => d.id === diagnosisId);
            if (!diagnosis) return;
            
            const detailWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            const date = diagnosis.createdAt?.toDate()?.toLocaleDateString('ja-JP') || 'æ—¥ä»˜ä¸æ˜';
            
            detailWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${diagnosis.title || 'è¨ºæ–­çµæœ'} - ã‚¨ãƒ³ãƒ‰ã‚¥ãƒ»ã‚¦ã‚§ãƒ«ãƒã‚¹</title>
                    <script src="https://cdn.tailwindcss.com"></script>
                </head>
                <body class="bg-gray-50 p-6">
                    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
                        <h1 class="text-2xl font-bold mb-2">${diagnosis.title || 'è¨ºæ–­çµæœ'}</h1>
                        <p class="text-gray-500 mb-6">${date}</p>
                        
                        ${diagnosis.basicInfo ? `
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h2 class="text-lg font-semibold mb-3">åŸºæœ¬æƒ…å ±</h2>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>å¹´é½¢: ${diagnosis.basicInfo.age || 'N/A'}æ­³</div>
                                    <div>æ€§åˆ¥: ${diagnosis.basicInfo.gender || 'N/A'}</div>
                                    <div>èº«é•·: ${diagnosis.basicInfo.height || 'N/A'}cm</div>
                                    <div>ä½“é‡: ${diagnosis.basicInfo.weight || 'N/A'}kg</div>
                                    <div>ç›®æ¨™ä½“é‡: ${diagnosis.basicInfo.targetWeight || 'N/A'}kg</div>
                                    <div>BMI: ${diagnosis.basicInfo.bmi ? diagnosis.basicInfo.bmi.toFixed(1) : 'N/A'}</div>
                                </div>
                            </div>
                        ` : ''}

                        ${diagnosis.scores ? `
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h2 class="text-lg font-semibold mb-3">è©•ä¾¡ã‚¹ã‚³ã‚¢</h2>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>èº«ä½“ç—‡çŠ¶: ${diagnosis.scores.physicalSymptom || 0}/25</div>
                                    <div>ç²¾ç¥ç—‡çŠ¶: ${diagnosis.scores.mentalSymptom || 0}/30</div>
                                    <div>é£Ÿç”Ÿæ´»: ${(diagnosis.scores.animalProduct || 0) + (diagnosis.scores.sugarIntake || 0) + (diagnosis.scores.badHabits || 0)}/65</div>
                                    <div class="font-semibold text-lg">ç·åˆã‚¹ã‚³ã‚¢: ${((diagnosis.scores.physicalSymptom || 0) + (diagnosis.scores.mentalSymptom || 0) + (diagnosis.scores.animalProduct || 0) + (diagnosis.scores.sugarIntake || 0) + (diagnosis.scores.badHabits || 0))}/120</div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="mb-6">
                            <h2 class="text-lg font-semibold mb-3">è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                            <div class="prose max-w-none">
                                ${diagnosis.report && diagnosis.report.summary ? diagnosis.report.summary.replace(/\\n/g, '<br>') : 'ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'}
                            </div>
                        </div>
                        
                        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors mr-4">
                            å°åˆ·
                        </button>
                        <button onclick="window.close()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </body>
                </html>
            `);
            detailWindow.document.close();
        }

        // è¨ºæ–­çµæœã®å‰Šé™¤
        async function deleteDiagnosis(diagnosisId) {
            if (!confirm('ã“ã®è¨ºæ–­çµæœã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('ai_diagnoses')
                    .doc(diagnosisId)
                    .delete();
                
                allDiagnoses = allDiagnoses.filter(d => d.id !== diagnosisId);
                selectedDiagnoses = selectedDiagnoses.filter(id => id !== diagnosisId);
                
                if (allDiagnoses.length === 0) {
                    historyListEl.classList.add('hidden');
                    noHistoryEl.classList.remove('hidden');
                } else {
                    renderDiagnosisCards();
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }
    </script>
</body>
</html>