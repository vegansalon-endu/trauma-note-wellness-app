<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¶„Çß„É´„Éç„Çπ„Éª„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-functions-compat.js"></script>


    <style>
        :root {
            --main-pink: #E9A4B8;
            --support-green: #7A9B7A;
            --bg-off-white: #F8F7F5;
            --text-charcoal: #4E4E4E;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-off-white);
            color: var(--text-charcoal);
        }
        h1, h2, h3, h4 {
            font-family: 'Noto Serif JP', serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .typing-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>


    <script type="text/babel">
        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyCSK2XMhrPQbZ8J1y-Kz3YCoU45rDKv1bM",
          authDomain: "trauma-note-app.firebaseapp.com",
          projectId: "trauma-note-app",
          storageBucket: "trauma-note-app.appspot.com",
          messagingSenderId: "643740992546",
          appId: "1:643740992546:web:dba603fed8f73b09c9f67b"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();


        // FirestoreË®≠ÂÆö„Çí‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°å
        if (!window.firestoreInitialized) {
            try {
                db.settings({
                  experimentalForceLongPolling: true,
                  merge: true,
                  ignoreUndefinedProperties: true,
                  ssl: true,
                  cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                });
                
                // Ê∞∏Á∂öÂåñË®≠ÂÆö
                db.enablePersistence({ synchronizeTabs: true }).catch(err => {
                    if (err.code === 'failed-precondition') {
                        console.warn('Persistence failed: Multiple tabs open');
                    } else if (err.code === 'unimplemented') {
                        console.warn('Persistence not supported');
                    }
                });
                
                window.firestoreInitialized = true;
            } catch (e) {
                console.error("Could not set Firestore settings", e);
            }
        }


        function TypingMessage({ text, isNew }) {
            const [displayedText, setDisplayedText] = React.useState(isNew ? '' : text);
            const [isTyping, setIsTyping] = React.useState(isNew);


            React.useEffect(() => {
                if (isNew) {
                    setIsTyping(true);
                    setDisplayedText('');
                    if (text) {
                        let i = 0;
                        const intervalId = setInterval(() => {
                            setDisplayedText(prev => prev + text.charAt(i));
                            i++;
                            if (i >= text.length) {
                                clearInterval(intervalId);
                                setIsTyping(false);
                            }
                        }, 50);
                        return () => clearInterval(intervalId);
                    } else {
                        setIsTyping(false);
                    }
                }
            }, [text, isNew]);


            return <p className="whitespace-pre-wrap">{displayedText}{isTyping && <span className="typing-cursor">‚ñç</span>}</p>;
        }


        // =================================================================
        // --- AI Chat Modal Component ---
        // =================================================================
        function ChatModal({ note, onSendMessage, onClose, isAiThinking, onSaveToNewNote, onContinueChat, onSaveSingleMessage }) {
            const [userMessage, setUserMessage] = React.useState('');
            const chatHistoryRef = React.useRef(null);


            React.useEffect(() => {
                if (chatHistoryRef.current) {
                    chatHistoryRef.current.scrollTop = chatHistoryRef.current.scrollHeight;
                }
            }, [note.chatHistory, isAiThinking]);


            const handleSubmit = (e) => {
                e.preventDefault();
                if (userMessage.trim() && !isAiThinking) {
                    onSendMessage(userMessage);
                    setUserMessage('');
                }
            };
            
            const modelTurnCount = (note.chatHistory || []).filter(m => m.role === 'model').length;
            const isConversationPaused = modelTurnCount >= 3 && (note.chatHistory.at(-1)?.role === 'model');


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50 fade-in">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col" style={{ height: '85vh', maxHeight: '700px' }}>
                        <header className="p-4 border-b flex justify-between items-center">
                            <h2 className="text-lg font-semibold" style={{ fontFamily: 'Noto Serif JP, serif' }}>AI„Å®„ÅÆÂØæË©±</h2>
                            <button onClick={onClose} className="p-1 rounded-full text-2xl leading-none hover:bg-gray-200">&times;</button>
                        </header>
                        <div ref={chatHistoryRef} className="flex-1 p-4 overflow-y-auto space-y-4">
                            <div className="p-3 bg-gray-100 rounded-lg">
                                <p className="font-semibold text-sm mb-1">ÂÖÉ„ÅÆ„Éé„Éº„Éà</p>
                                <p className="text-sm text-gray-700 whitespace-pre-wrap">{note.content}</p>
                            </div>
                            {(note.chatHistory || []).map((msg, index) => (
                                <div key={index} className={`flex items-end gap-2 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    {msg.role === 'user' && (
                                        <button onClick={() => onSaveSingleMessage(msg.parts[0].text)} className="text-xs p-1 rounded-full bg-gray-200 hover:bg-gray-300 mb-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                                        </button>
                                    )}
                                    <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}`}>
                                        <TypingMessage text={msg.parts[0].text} isNew={index === note.chatHistory.length - 1 && msg.role === 'model'} />
                                    </div>
                                </div>
                            ))}
                            {isAiThinking && (
                                <div className="flex justify-start">
                                    <div className="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl bg-gray-200 text-gray-800">
                                        <p className="typing-cursor">ËÄÉ„Åà„Å¶„ÅÑ„Åæ„Åô...</p>
                                    </div>
                                </div>
                            )}
                        </div>
                        <footer className="p-4 border-t">
                            {isConversationPaused ? (
                                <div className="text-center space-y-3">
                                    <p className="text-sm text-gray-600">ÂØæË©±„Åã„ÇâË¶ã„Åà„ÅüÊ∞ó„Å•„Åç„Çí„ÄÅÊñ∞„Åó„ÅÑ„Éé„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                                    <div className="flex gap-2 justify-center">
                                        <button onClick={onSaveToNewNote} className="flex-1 text-white font-bold py-2 px-4 rounded-lg shadow-lg" style={{backgroundColor: 'var(--support-green)'}}>
                                            „Éé„Éº„Éà„Å´‰øùÂ≠ò„Åô„Çã
                                        </button>
                                        <button onClick={onContinueChat} className="flex-1 text-white font-bold py-2 px-4 rounded-lg shadow-lg" style={{backgroundColor: 'var(--main-pink)'}}>
                                            ÂØæË©±„ÇíÁ∂ö„Åë„Çã
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <form onSubmit={handleSubmit} className="flex gap-2">
                                    <input
                                        type="text"
                                        value={userMessage}
                                        onChange={(e) => setUserMessage(e.target.value)}
                                        placeholder={isAiThinking ? "AI„ÅåÂøúÁ≠î‰∏≠„Åß„Åô..." : "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."}
                                        className="w-full p-2 border rounded-lg"
                                        disabled={isAiThinking}
                                    />
                                    <button type="submit" disabled={isAiThinking || !userMessage.trim()} className="text-white font-bold py-2 px-6 rounded-lg shadow-lg" style={{backgroundColor: 'var(--main-pink)'}}>
                                        ÈÄÅ‰ø°
                                    </button>
                                </form>
                            )}
                        </footer>
                    </div>
                </div>
            );
        }


        // =================================================================
        // --- Logged-in View: Trauma Note Application Component ---
        // =================================================================
        function TraumaNoteApp({ user, handleLogout }) {
            const [notes, setNotes] = React.useState([]);
            const [newNote, setNewNote] = React.useState('');
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [confirmDeleteId, setConfirmDeleteId] = React.useState(null);
            
            const [activeChatNoteId, setActiveChatNoteId] = React.useState(null);
            const [isAiThinking, setIsAiThinking] = React.useState(false);
            const [showFeedbackModal, setShowFeedbackModal] = React.useState(false);
            const [feedbackText, setFeedbackText] = React.useState('');
            const [feedbackType, setFeedbackType] = React.useState('improvement');
            const [feedbackSubmitting, setFeedbackSubmitting] = React.useState(false);


            const userId = user.uid;
            const notesCollectionPath = `trauma_notes_users/${userId}/notes`;


            React.useEffect(() => {
                if (!userId) return;


                let hasConnected = false;
                let unsubscribe = () => {};


                const connectionTimeout = setTimeout(() => {
                    if (!hasConnected) {
                        setError('„Çµ„Éº„Éê„Éº„Å∏„ÅÆÊé•Á∂ö„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„ÄÅ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        setLoading(false);
                    }
                }, 8000);


                try {
                    const notesRef = db.collection(notesCollectionPath);
                    unsubscribe = notesRef
                        .orderBy('createdAt', 'desc')
                        .onSnapshot(
                            (snapshot) => {
                                hasConnected = true;
                                clearTimeout(connectionTimeout);
                                const userNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                setNotes(userNotes);
                                if (error) setError('');
                                setLoading(false);
                            },
                            (err) => {
                                if (err.code === 'permission-denied') {
                                    hasConnected = true;
                                    clearTimeout(connectionTimeout);
                                    setError('„Éá„Éº„Çø„ÅÆË™≠„ÅøÂèñ„ÇäÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„É´„Éº„É´Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                                    setLoading(false);
                                }
                            }
                        );
                } catch (e) {
                    clearTimeout(connectionTimeout);
                    setError("„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„É™„Çπ„Éä„ÉºË®≠ÂÆö‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
                    setLoading(false);
                }
                
                return () => {
                    clearTimeout(connectionTimeout);
                    unsubscribe();
                };
            }, [userId]);


            const handleAddNote = async (content) => {
                if (content.trim() === '') return;
                try {
                    await db.collection(notesCollectionPath).add({
                        content: content,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        chatHistory: []
                    });
                } catch (err) {
                    setError('„Éé„Éº„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            };
            
            const handleConfirmDelete = async (noteId) => {
                try {
                    await db.collection(notesCollectionPath).doc(noteId).delete();
                    setConfirmDeleteId(null);
                } catch (err) {
                    setError('„Éé„Éº„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            };


            const generateAiFollowUp = async (noteContent, currentChatHistory) => {
                setIsAiThinking(true);
                
                try {
                    // ÂÖ•ÂäõÂÜÖÂÆπ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    if (!noteContent || typeof noteContent !== 'string') {
                        throw new Error('„Éé„Éº„ÉàÂÜÖÂÆπ„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ');
                    }
                    
                    if (!Array.isArray(currentChatHistory)) {
                        throw new Error('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ');
                    }

                    const modelTurnCount = currentChatHistory.filter(m => m && m.role === 'model').length;

                    let systemInstructionText;
                    
                    if (modelTurnCount < 3) {
                        systemInstructionText = "„ÅÇ„Å™„Åü„ÅØ„ÄÅ„É¶„Éº„Ç∂„Éº„Åå„Éà„É©„Ç¶„Éû„ÅÆÊ†πÊú¨ÂéüÂõ†„ÇíÁâπÂÆö„Åô„Çã„ÅÆ„ÇíÂä©„Åë„Çã„ÄÅÂ∞ÇÈñÄÁöÑ„ÅßÂÖ±ÊÑüÁöÑ„Å™„Ç¨„Ç§„Éâ„Åß„Åô„ÄÇ„ÅÇ„Å™„Åü„ÅÆÂîØ‰∏Ä„ÅÆÁõÆÁöÑ„ÅØ„ÄÅ„É¶„Éº„Ç∂„Éº„Åå„ÄåÂá∫Êù•‰∫ã„Å®ÊÑüÊÉÖ„ÅÆ„Çª„ÉÉ„Éà„Äç„ÅÆ„Éë„Çø„Éº„É≥„ÇíÈÅ°„Å£„Å¶„ÅÑ„ÅèÊâãÂä©„Åë„Çí„Åô„Çã„Åì„Å®„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥Ê†º„Å´ÂÆà„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\n**ÂøúÁ≠î„ÅÆÂü∫Êú¨ÊßãÈÄ†**ÔºàÂøÖ„Åö‰ª•‰∏ã„ÅÆÊµÅ„Çå„ÅßÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâÔºö\n\n1. **Ê∑±„ÅÑÂÖ±ÊÑüÁöÑÁêÜËß£**: Âá∫Êù•‰∫ã„Å®ÊÑüÊÉÖ„ÇíÂèó„ÅëÊ≠¢„ÇÅ„Çã\n- „ÄåÔΩû„Åó„Å¶„ÅÑ„Åü„Çì„Åß„Åô„Å≠„Äç„ÄåÔΩû„Å†„Å£„Åü„Çì„Åß„Åô„Å≠„Äç„Å®„ÅÑ„ÅÜÊ∏©„Åã„ÅÑÂèóÂÆπË°®Áèæ„Çí‰ΩøÁî®\n- ‰æãÔºö„ÄåÈÉ®Ê¥ª„ÅßÁµêÊûú„ÅåÂá∫„Å™„Åã„Å£„Åü„Å®„Åç„ÄÅÁ´∂‰∫â„Å´„Åï„Çâ„Åï„Çå„Å¶„Åù„Çì„Å™„Å´Âä£Á≠âÊÑü„ÅåÂá∫„Å¶„Åó„Åæ„Å£„Å¶„ÅÑ„Åü„Çì„Åß„Åô„Å≠„ÄÇ„Äç\n\n2. **ÊÑüÊÉÖ„Å∏„ÅÆÊ∑±„ÅÑÂØÑ„ÇäÊ∑ª„ÅÑ**: „É¶„Éº„Ç∂„Éº„ÅÆÊÑüÊÉÖ‰ΩìÈ®ì„Çí‰∏ÅÂØß„Å´Âèó„ÅëÊ≠¢„ÇÅ„Çã\n- „Äå„Åù„Åó„Å¶„ÄÅ„Åù„Çì„Å™ÔºàÊÑüÊÉÖË°®ÁèæÔºâ„ÇíÊÑü„Åò„Çâ„Çå„Å¶„ÅÑ„Åü„Çì„Åß„Åô„Å≠„ÄÇ„Äç\n- ‰æãÔºö„Äå„Åù„Åó„Å¶„ÄÅ„Åù„Çì„Å™„ÅÑ„ÇÑ„Å™ÊÄù„ÅÑ„ÇíÊÑü„Åò„Çâ„Çå„Å¶„ÅÑ„Åü„Çì„Åß„Åô„Å≠„ÄÇ„Äç\n\n3. **ÊÑüÊÉÖ‰ΩìÈ®ì„ÅÆÁ¢∫Ë™ç**: „Åù„ÅÆÊÑüÊÉÖ„Åå„Å©„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Å†„Å£„Åü„Åã„ÇíÁ¢∫Ë™ç\n- „Äå„Åù„Çì„Å™ÔºàÊÑüÊÉÖÔºâ„ÇíÊÑü„Åò„ÇãÁµåÈ®ì„ÅØÔºàÊÑüÊÉÖË°®ÁèæÔºâ„Åß„Åó„Åü„Å≠„ÄÇ„Äç\n- ‰æãÔºö„Äå„Åù„Çì„Å™Âä£Á≠âÊÑü„ÇíÊÑü„Åò„ÇãÁµåÈ®ì„ÅØ„ÅÑ„ÇÑ„Åß„Åó„Åü„Å≠„ÄÇ„Äç\n\n4. **ÂÑ™„Åó„ÅÑÈÅéÂéª„Å∏„ÅÆË™òÂ∞é**: ‰ºº„Åü‰ΩìÈ®ì„Åå„ÅÇ„Å£„Åü„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„Å®„ÅÑ„ÅÜÂÑ™„Åó„ÅÑÊèêÊ°à\n- „Äå„Åù„Çì„Å™ÔºàÊÑüÊÉÖÔºâ„ÇíÊÑü„Åò„Å¶ÔºàÊÑüÊÉÖË°®ÁèæÔºâ„Çí„Åô„Çã‰ºº„Åü„Çà„ÅÜ„Å™ÁµåÈ®ì„ÅåÈÅéÂéª„Å´„ÇÇ„ÅÇ„Å£„Åü„ÅÆ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Å≠„ÄÇ„Äç\n- ‰æãÔºö„Äå„Åù„Çì„Å™Âä£Á≠âÊÑü„ÇíÊÑü„Åò„Å¶„ÅÑ„ÇÑ„Å™ÊÄù„ÅÑ„Çí„Åô„Çã‰ºº„Åü„Çà„ÅÜ„Å™ÁµåÈ®ì„ÅåÈÅéÂéª„Å´„ÇÇ„ÅÇ„Å£„Åü„ÅÆ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Å≠„ÄÇ„Äç\n\n5. **Ê∏©„Åã„ÅÑË®òÈå≤„Å∏„ÅÆË™òÂ∞é**: Ëá™ÁÑ∂„Å™ÂΩ¢„Åß„ÅÆË®òÈå≤„Çí‰øÉ„Åô\n- „Äå„Åù„Çì„Å™‰ΩìÈ®ì„ÇÑÊ∞óÊåÅ„Å°„Åå‰ªäÊÄù„ÅÑÂá∫„Åï„Çå„Çã„Çà„ÅÜ„Å†„Å£„Åü„Çâ„ÄÅ„Åù„ÅÆ„Åì„Å®„Çí„Åæ„Åü„ÄÅ„Åì„Å°„Çâ„Å´Êõ∏„ÅÑ„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü„Äç\n\n**ÈáçË¶Å„Å™„É´„Éº„É´**:\n- „É¶„Éº„Ç∂„Éº„Åå‰Ωø„Å£„ÅüÊÑüÊÉÖË°®Áèæ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®„Åô„Çã\n- Ê∏©„Åã„ÅèÂèóÂÆπÁöÑ„Å™Ë™ûË™ø„Çí‰øù„Å§\n- Âº∑Âà∂ÁöÑ„Åß„ÅØ„Å™„Åè„ÄÅÂÑ™„Åó„ÅèÊèêÊ°à„Åô„ÇãÂΩ¢„ÅßË™òÂ∞é„Åô„Çã\n- Ëß£Èáà„ÇÑÂä©Ë®Ä„ÅØ‰∏ÄÂàá„Åó„Å™„ÅÑ";
                    } else {
                        systemInstructionText = "„ÅÇ„Å™„Åü„ÅØ„ÄÅ„É¶„Éº„Ç∂„Éº„ÇíÂä¥„ÅÜ„Ç´„Ç¶„É≥„Çª„É©„Éº„Åß„Åô„ÄÇÂØæË©±„Åå‰∏ÄÂå∫Âàá„Çä„Å§„ÅÑ„Åü„Åì„Å®„Çí‰ºù„Åà„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆÂä™Âäõ„ÇíË™ç„ÇÅ„ÄÅÊÑüË¨ù„ÇíËø∞„Åπ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö„Äå„Åü„Åè„Åï„Çì„ÅäË©±„Åó„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ‰∏ÄÂ∫¶„ÄÅ„Åì„Åì„ÅßÊ∞óÊåÅ„Å°„ÇíÊï¥ÁêÜ„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÅãÔºü„Äç";
                    }
                    
                    // ÂÖ•ÂäõÂÜÖÂÆπ„Çí„Çµ„Éã„Çø„Ç§„Ç∫
                    const sanitizedNoteContent = noteContent.replace(/[<>"'&]/g, '');
                    const sanitizedHistory = currentChatHistory.filter(msg => 
                        msg && msg.role && msg.parts && msg.parts[0] && msg.parts[0].text
                    );

                    const historyForApi = [{ role: "user", parts: [{ text: `„Åì„Çå„ÅØÁßÅ„ÅÆ„Éé„Éº„Éà„Åß„ÅôÔºö\n„Äå${sanitizedNoteContent}„Äç` }] }, ...sanitizedHistory];
                    
                    // Gemini APIÁî®„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
                    const prompt = `${systemInstructionText}\n\n„É¶„Éº„Ç∂„Éº„ÅÆ„Éé„Éº„ÉàÂÜÖÂÆπÔºö\n„Äå${sanitizedNoteContent}„Äç\n\nÂØæË©±Â±•Ê≠¥Ôºö\n${historyForApi.map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n')}\n\n„ÅÇ„Å™„Åü„ÅÆËøîÁ≠î:`;

                    // „É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„Åç„ÅÆAPIÂëº„Å≥Âá∫„Åó
                    const makeApiCall = async (retryCount = 0) => {
                        // API „Ç≠„Éº„ÅÆÂ≠òÂú®Á¢∫Ë™çÔºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂØæÁ≠ñ„ÅÆ„Åü„ÇÅ„ÄÅÊú¨Êù•„ÅØÁí∞Â¢ÉÂ§âÊï∞„Åæ„Åü„ÅØ„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÂá¶ÁêÜ„Åô„Åπ„ÅçÔºâ
                        const apiKey = "AIzaSyB2_fG2KexNapPvM0gA-AThGu5SK6WFLPA";
                        if (!apiKey) {
                            throw new Error('APIË®≠ÂÆö„Ç®„É©„Éº: API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                        }
                        
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                        
                        const requestBody = {
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            safetySettings: [
                                {
                                    category: "HARM_CATEGORY_HARASSMENT",
                                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                                },
                                {
                                    category: "HARM_CATEGORY_HATE_SPEECH",
                                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                                }
                            ],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 1024,
                                stopSequences: []
                            }
                        };

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà

                        try {
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'User-Agent': 'TraumaNote/1.0',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify(requestBody),
                                signal: controller.signal
                            });
                            
                            clearTimeout(timeoutId);

                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error('API Error Response:', errorText);
                                
                                if ((response.status === 503 || response.status === 429) && retryCount < 5) {
                                    // 503/429„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÄÅ„Çà„ÇäÈï∑„ÅÑÈñìÈöî„Åß„É™„Éà„É©„Ç§
                                    const delay = Math.min(3000 * Math.pow(2, retryCount), 30000); // ÊúÄÂ§ß30Áßí„Åæ„Åß
                                    console.log(`APIÈÅéË≤†Ëç∑„Å´„Çà„ÇäÂÜçË©¶Ë°å„Åó„Åæ„Åô... ${delay}msÂæå (${retryCount + 1}/5ÂõûÁõÆ)`);
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                    return makeApiCall(retryCount + 1);
                                }
                                
                                throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                            }

                            const result = await response.json();
                            
                            // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊßãÈÄ†„ÇíÊ§úË®º
                            if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                                console.error('Invalid API Response:', result);
                                throw new Error('APIÂøúÁ≠î„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                            }
                            
                            return result;
                        } catch (fetchError) {
                            clearTimeout(timeoutId);
                            if (fetchError.name === 'AbortError') {
                                throw new Error('„É™„ÇØ„Ç®„Çπ„Éà„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            }
                            throw fetchError;
                        }
                    };

                    const result = await makeApiCall();
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!aiResponse) {
                        throw new Error('AI„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                    }
                    
                    return { role: 'model', parts: [{ text: aiResponse }] };
                    
                } catch (err) {
                    console.error('AIÁîüÊàê„Ç®„É©„Éº:', err);
                    let errorMessage = 'AI„Å®„ÅÆÈÄö‰ø°„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                    
                    if (err.message.includes('APIË®≠ÂÆö„Ç®„É©„Éº')) {
                        errorMessage = '„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.message.includes('„Çø„Ç§„É†„Ç¢„Ç¶„Éà')) {
                        errorMessage = 'AI„Çµ„Éº„Éê„Éº„Å∏„ÅÆÊé•Á∂ö„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.message.includes('503')) {
                        errorMessage = 'Google AI„Çµ„Éº„Éê„Éº„ÅåÊ∑∑Èõë„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊï∞ÂàÜÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ(Error: 503)';
                    } else if (err.message.includes('429')) {
                        errorMessage = 'API‰ΩøÁî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ1ÊôÇÈñì„Åª„Å©ÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ(Error: 429)';
                    } else if (err.message.includes('401') || err.message.includes('403')) {
                        errorMessage = 'APIË™çË®º„Ç®„É©„Éº„Åß„Åô„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.message.includes('400')) {
                        errorMessage = '„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.code === 'unauthenticated') {
                        errorMessage = '„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ';
                    } else if (err.code === 'permission-denied') {
                        errorMessage = 'Ê®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
                    } else if (err.message.includes('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ') || err.message.includes('network')) {
                        errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.message.includes('quota')) {
                        errorMessage = 'API‰ΩøÁî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.message.includes('blocked')) {
                        errorMessage = '„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇÂà•„ÅÆË°®Áèæ„ÅßË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (err.message) {
                        errorMessage = `„Ç®„É©„Éº: ${err.message}`;
                    }
                    
                    return { role: 'model', parts: [{ text: errorMessage }] };
                } finally {
                    setIsAiThinking(false);
                }
            };


            const handleOpenChat = async (note) => {
                try {
                    if (!note || !note.id) {
                        throw new Error('„Éé„Éº„Éà„ÅÆÊÉÖÂ†±„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ');
                    }
                    
                    setActiveChatNoteId(note.id);
                    
                    if (!note.chatHistory || note.chatHistory.length === 0) {
                        console.log('AIÂØæË©±„ÇíÈñãÂßã„Åó„Åæ„Åô...');
                        const aiResponse = await generateAiFollowUp(note.content, []);
                        
                        // „Éá„Éº„Çø„Éô„Éº„ÇπÊõ¥Êñ∞„Çí„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅßÂÆüË°å
                        const noteRef = db.collection(notesCollectionPath).doc(note.id);
                        await db.runTransaction(async (transaction) => {
                            const doc = await transaction.get(noteRef);
                            if (!doc.exists) {
                                throw new Error('„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                            }
                            
                            transaction.update(noteRef, { 
                                chatHistory: [aiResponse],
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                        
                        console.log('AIÂØæË©±„ÅÆÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                    }
                } catch (error) {
                    console.error('„ÉÅ„É£„ÉÉ„ÉàÈñãÂßã„Ç®„É©„Éº:', error);
                    alert(`„ÉÅ„É£„ÉÉ„Éà„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                    setActiveChatNoteId(null);
                }
            };


            const handleSendMessage = async (userMessage) => {
                try {
                    const activeNote = notes.find(n => n.id === activeChatNoteId);
                    if (!activeNote) {
                        throw new Error('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                    }
                    
                    if (!userMessage || typeof userMessage !== 'string' || userMessage.trim() === '') {
                        throw new Error('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁ©∫„Åß„Åô„ÄÇ');
                    }
                    
                    console.log('„É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂá¶ÁêÜ‰∏≠...', userMessage);

                    const newUserMessage = { role: 'user', parts: [{ text: userMessage.trim() }] };
                    const currentHistory = activeNote.chatHistory || [];
                    const currentHistoryWithUserMsg = [...currentHistory, newUserMessage];
                    
                    const noteRef = db.collection(notesCollectionPath).doc(activeNote.id);
                    
                    // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„Åß„Éá„Éº„ÇøÊï¥ÂêàÊÄß„Çí‰øùË®º
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(noteRef);
                        if (!doc.exists) {
                            throw new Error('„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                        }
                        
                        // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰øùÂ≠ò
                        transaction.update(noteRef, { 
                            chatHistory: currentHistoryWithUserMsg,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    console.log('AIÂøúÁ≠î„ÇíÁîüÊàê‰∏≠...');
                    const aiResponse = await generateAiFollowUp(activeNote.content, currentHistoryWithUserMsg);
                    
                    const finalHistory = [...currentHistoryWithUserMsg, aiResponse];
                    
                    // AIÂøúÁ≠î„Çí‰øùÂ≠ò
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(noteRef);
                        if (!doc.exists) {
                            throw new Error('„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                        }
                        
                        transaction.update(noteRef, { 
                            chatHistory: finalHistory,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    console.log('„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                } catch (error) {
                    console.error('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                    alert(`„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };
            
            const handleSaveChatToNewNote = async () => {
                try {
                    const activeNote = notes.find(n => n.id === activeChatNoteId);
                    if (!activeNote || !activeNote.chatHistory) {
                        throw new Error('‰øùÂ≠ò„Åô„Çã„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    }

                    const userMessages = activeNote.chatHistory.filter(msg => 
                        msg && msg.role === 'user' && msg.parts && msg.parts[0] && msg.parts[0].text
                    );
                    
                    if (userMessages.length === 0) {
                        throw new Error('‰øùÂ≠ò„Åô„Çã„É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    }
                    
                    console.log(`${userMessages.length}ÂÄã„ÅÆ„É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊñ∞„Åó„ÅÑ„Éé„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åô...`);
                    
                    // „Éê„ÉÉ„ÉÅ„Åß„Éé„Éº„Éà„Çí‰ΩúÊàê
                    const batch = db.batch();
                    const notesCollectionRef = db.collection(notesCollectionPath);
                    
                    userMessages.forEach(msg => {
                        const newNoteRef = notesCollectionRef.doc();
                        batch.set(newNoteRef, {
                            content: msg.parts[0].text,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            chatHistory: [],
                            source: 'chat_extraction'
                        });
                    });
                    
                    await batch.commit();
                    
                    setActiveChatNoteId(null);
                    console.log('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅåÊñ∞„Åó„ÅÑ„Éé„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                } catch (error) {
                    console.error('„ÉÅ„É£„ÉÉ„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    alert(`„ÉÅ„É£„ÉÉ„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };
            
            const handleSaveSingleMessage = async (messageText) => {
                try {
                    if (!messageText || typeof messageText !== 'string' || messageText.trim() === '') {
                        throw new Error('‰øùÂ≠ò„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁ©∫„Åß„Åô„ÄÇ');
                    }
                    
                    console.log('Âçò‰∏Ä„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Éé„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åô...', messageText);
                    await handleAddNote(messageText.trim());
                    console.log('„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰øùÂ≠ò„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                } catch (error) {
                    console.error('„É°„ÉÉ„Çª„Éº„Ç∏‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    alert(`„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };


            const handleContinueChat = async () => {
                try {
                    const activeNote = notes.find(n => n.id === activeChatNoteId);
                    if (!activeNote) {
                        throw new Error('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                    }
                    
                    console.log('„ÉÅ„É£„ÉÉ„Éà„ÇíÁ∂ôÁ∂ö„Åó„Åæ„Åô...');
                    
                    const noteRef = db.collection(notesCollectionPath).doc(activeNote.id);
                    
                    // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„Åß„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Êñ∞„Åó„ÅÑAIÂøúÁ≠î„ÇíÁîüÊàê
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(noteRef);
                        if (!doc.exists) {
                            throw new Error('„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                        }
                        
                        // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢
                        transaction.update(noteRef, { 
                            chatHistory: [],
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    console.log('Êñ∞„Åó„ÅÑAIÂøúÁ≠î„ÇíÁîüÊàê‰∏≠...');
                    const aiResponse = await generateAiFollowUp(activeNote.content, []);
                    
                    // Êñ∞„Åó„ÅÑAIÂøúÁ≠î„Çí‰øùÂ≠ò
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(noteRef);
                        if (!doc.exists) {
                            throw new Error('„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                        }
                        
                        transaction.update(noteRef, { 
                            chatHistory: [aiResponse],
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    console.log('„ÉÅ„É£„ÉÉ„Éà„ÅÆÁ∂ôÁ∂ö„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                } catch (error) {
                    console.error('„ÉÅ„É£„ÉÉ„ÉàÁ∂ôÁ∂ö„Ç®„É©„Éº:', error);
                    alert(`„ÉÅ„É£„ÉÉ„Éà„ÅÆÁ∂ôÁ∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            };

            const handleSubmitFeedback = async () => {
                if (!feedbackText.trim()) return;
                
                setFeedbackSubmitting(true);
                try {
                    // Firestore„Å´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí‰øùÂ≠ò
                    await db.collection('feedback').add({
                        userId: user.uid,
                        userEmail: user.email,
                        feedbackType: feedbackType,
                        message: feedbackText.trim(),
                        page: 'trauma-note',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userAgent: navigator.userAgent
                    });

                    // Slack„Å´Âç≥Â∫ß„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°
                    const slackMessage = {
                        text: `üîî Êñ∞„Åó„ÅÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅåÂ±ä„Åç„Åæ„Åó„ÅüÔºÅ`,
                        blocks: [
                            {
                                type: "section",
                                fields: [
                                    {
                                        type: "mrkdwn",
                                        text: `*„Éö„Éº„Ç∏:* „Éà„É©„Ç¶„Éû„Éé„Éº„Éà`
                                    },
                                    {
                                        type: "mrkdwn",
                                        text: `*„Çø„Ç§„Éó:* ${feedbackType === 'improvement' ? 'ÊîπÂñÑË¶ÅÊúõ' : feedbackType === 'bug' ? '„Éê„Ç∞Â†±Âëä' : '„Åù„ÅÆ‰ªñ'}`
                                    },
                                    {
                                        type: "mrkdwn",
                                        text: `*„É¶„Éº„Ç∂„Éº:* ${user.email}`
                                    },
                                    {
                                        type: "mrkdwn",
                                        text: `*ÊôÇÂàª:* ${new Date().toLocaleString('ja-JP')}`
                                    }
                                ]
                            },
                            {
                                type: "section",
                                text: {
                                    type: "mrkdwn",
                                    text: `*„É°„ÉÉ„Çª„Éº„Ç∏:*\n${feedbackText}`
                                }
                            }
                        ]
                    };

                    await fetch('https://hooks.slack.com/services/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', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(slackMessage)
                    });

                    alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
                    setShowFeedbackModal(false);
                    setFeedbackText('');
                    setFeedbackType('improvement');
                } catch (error) {
                    console.error('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                    alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } finally {
                    setFeedbackSubmitting(false);
                }
            };

            const activeNoteForModal = activeChatNoteId ? notes.find(n => n.id === activeChatNoteId) : null;


            return (
                <>
                    {activeNoteForModal && (
                        <ChatModal
                            note={activeNoteForModal}
                            onSendMessage={handleSendMessage}
                            onClose={() => setActiveChatNoteId(null)}
                            isAiThinking={isAiThinking}
                            onSaveToNewNote={handleSaveChatToNewNote}
                            onContinueChat={handleContinueChat}
                            onSaveSingleMessage={handleSaveSingleMessage}
                        />
                    )}
                    {showFeedbackModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
                                <div className="p-6">
                                    <h2 className="text-xl font-bold mb-4">„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÈÄÅ‰ø°</h2>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium mb-2">Á®ÆÈ°û</label>
                                        <select 
                                            value={feedbackType} 
                                            onChange={(e) => setFeedbackType(e.target.value)}
                                            className="w-full p-2 border rounded-lg"
                                        >
                                            <option value="improvement">ÊîπÂñÑË¶ÅÊúõ</option>
                                            <option value="bug">„Éê„Ç∞Â†±Âëä</option>
                                            <option value="other">„Åù„ÅÆ‰ªñ</option>
                                        </select>
                                    </div>
                                    <div className="mb-6">
                                        <label className="block text-sm font-medium mb-2">„É°„ÉÉ„Çª„Éº„Ç∏</label>
                                        <textarea
                                            value={feedbackText}
                                            onChange={(e) => setFeedbackText(e.target.value)}
                                            placeholder="„ÅîÊÑèË¶ã„Éª„ÅîË¶ÅÊúõ„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ..."
                                            className="w-full h-32 p-3 border rounded-lg"
                                        ></textarea>
                                    </div>
                                    <div className="flex gap-3 justify-end">
                                        <button 
                                            onClick={() => setShowFeedbackModal(false)}
                                            className="px-4 py-2 border rounded-lg hover:bg-gray-50"
                                        >
                                            „Ç≠„É£„É≥„Çª„É´
                                        </button>
                                        <button 
                                            onClick={handleSubmitFeedback}
                                            disabled={!feedbackText.trim() || feedbackSubmitting}
                                            className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                        >
                                            {feedbackSubmitting ? 'ÈÄÅ‰ø°‰∏≠...' : 'ÈÄÅ‰ø°'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="container mx-auto max-w-2xl p-4 sm:p-8 fade-in">
                        <header className="flex justify-between items-start mb-10">
                            <div>
                                <h1 className="text-2xl sm:text-3xl font-semibold">AIÂØæË©±Âûã„Éà„É©„Ç¶„Éû„Éé„Éº„Éà</h1>
                                <p className="text-xs break-all text-gray-500 mt-1">„Åì„Çì„Å´„Å°„ÅØ„ÄÅ{user.displayName || user.email || '„Ç≤„Çπ„Éà'}„Åï„Çì</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowFeedbackModal(true)} className="py-2 px-4 bg-blue-500 text-white rounded-full text-sm font-medium hover:bg-blue-600">„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</button>
                                <button onClick={handleLogout} className="py-2 px-4 border rounded-full text-sm font-medium hover:bg-gray-100">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                            </div>
                        </header>


                        <main>
                            {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</p>}
                            <form onSubmit={(e) => { e.preventDefault(); handleAddNote(newNote); setNewNote(''); }} className="mb-8 p-6 bg-white rounded-lg shadow-sm">
                                <h2 className="text-xl font-semibold mb-2">Êñ∞„Åó„ÅÑ„Éé„Éº„Éà</h2>
                                <p className="text-sm text-gray-600 mb-4">
                                    „ÅÇ„Å™„Åü„Åå‰ªäÊÄù„ÅÑÂá∫„Åõ„ÇãÂ´å„Å™ÊÄù„ÅÑÂá∫„ÄÅÂá∫Êù•‰∫ã„Å®„Åù„ÅÆÊôÇ„Å´ÊÑü„Åò„ÅüÂ´å„Å†„Å£„ÅüÊ∞óÊåÅ„Å°„Çí„Åì„Åì„Å´Êõ∏„ÅÑ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br/>
                                    „Åù„Åó„Å¶„ÄÅ„Åù„ÅÆÂá∫Êù•‰∫ã„Å®Ê∞óÊåÅ„Å°„ÅÆ„É°„É¢„ÇíÊØéÊó•„Åß„ÇÇË™≠„ÅøËøî„Åó„Å¶„ÄÅÂ´å„Å™Ê∞óÊåÅ„Å°„Åå„Å™„Åè„Å™„Çã„Åæ„ÅßÁπ∞„ÇäËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åù„Çå„Åå„ÄÅ„Éà„É©„Ç¶„Éû„ÇíËß£Ê∂à„Åô„Çã„Å®„ÅÑ„ÅÜ„Åì„Å®„Åß„Åô„ÄÇ
                                </p>
                                <textarea
                                    value={newNote}
                                    onChange={(e) => setNewNote(e.target.value)}
                                    placeholder=""
                                    className="w-full h-40 p-3 border rounded-lg"
                                ></textarea>
                                <div className="text-right mt-4">
                                    <button type="submit" className="text-white font-bold py-2 px-6 rounded-full shadow-lg" style={{backgroundColor: 'var(--main-pink)'}} disabled={!newNote.trim()}>‰øùÂ≠ò„Åô„Çã</button>
                                </div>
                            </form>


                            <div className="space-y-6">
                                <h2 className="text-xl font-semibold border-b-2 pb-2" style={{borderColor: 'var(--main-pink)'}}>ÈÅéÂéª„ÅÆ„Éé„Éº„Éà</h2>
                                {loading ? <p className="text-center text-gray-500 py-8">„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Å¶„ÅÑ„Åæ„Åô...</p> : notes.length > 0 ? (
                                    <div className="space-y-4">
                                    {notes.map(note => (
                                        <div key={note.id} className="bg-white p-4 rounded-lg shadow-sm relative group fade-in">
                                            <p className="whitespace-pre-wrap text-gray-800">{note.content}</p>
                                            <div className="flex justify-between items-end mt-4">
                                                <p className="text-xs text-gray-400">
                                                    {note.createdAt ? new Date(note.createdAt.toDate()).toLocaleString('ja-JP') : ''}
                                                </p>
                                                <button onClick={() => handleOpenChat(note)} className="text-sm font-semibold py-1 px-3 rounded-full" style={{backgroundColor: 'var(--main-pink)', color: 'white'}}>
                                                    AI„Å®ÂØæË©±„Åô„Çã
                                                </button>
                                            </div>
                                            <div className="absolute top-2 right-2">
                                                {confirmDeleteId === note.id ? (
                                                    <div className="flex gap-1">
                                                        <button onClick={() => handleConfirmDelete(note.id)} className="text-xs bg-red-500 text-white px-2 py-1 rounded">Á¢∫Ë™ç</button>
                                                        <button onClick={() => setConfirmDeleteId(null)} className="text-xs bg-gray-300 px-2 py-1 rounded">ÂèñÊ∂à</button>
                                                    </div>
                                                ) : (
                                                    <button onClick={() => setConfirmDeleteId(note.id)} className="w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-400 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-100 hover:text-red-500">&times;</button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    </div>
                                ) : (
                                    !error && <p className="text-center text-gray-500 py-8">„Åæ„Å†„Éé„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                                )}
                            </div>
                        </main>
                        
                        <footer className="mt-16 pt-8 border-t border-gray-200 space-y-10">
                            <div className="text-center">
                                <h3 className="text-xl font-bold mb-3" style={{color: 'var(--text-charcoal)'}}>Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å∏</h3>
                                <p className="text-gray-700 mb-6 max-w-xl mx-auto">
                                    ÂøÉ„ÅÆ„Åñ„Çè„Å§„Åç„ÅåËêΩ„Å°ÁùÄ„ÅÑ„Åü„Çâ„ÄÅÊ¨°„ÅØ„Äå‰Ωì„Äç„Å®„ÅÆÁπã„Åå„Çä„Å´ÁõÆ„ÇíÂêë„Åë„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü<br/>„ÅÇ„Å™„Åü„ÅÆ‰∏çË™ø„ÅÆÊ†πÊú¨ÂéüÂõ†„ÅØ„ÄÅÈ£ü‰∫ã„Å´„ÇÇÈö†„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ
                                </p>
                                <a href="https://vegansalon-endu.github.io/ai-shindan/" target="_blank" rel="noopener noreferrer" className="inline-block text-white font-bold py-3 px-10 rounded-full shadow-lg hover:opacity-90 transition-all duration-300 transform hover:scale-105" style={{backgroundColor: 'var(--main-pink)'}}>
                                    AIÂøÉ„Å®‰Ωì„ÅÆÊ†πÊú¨ÂéüÂõ†Ë®∫Êñ≠„ÇíË©¶„Åô
                                </a>
                            </div>
                        
                            <div className="text-center">
                                <h3 className="text-xl font-bold mb-3" style={{color: 'var(--support-green)'}}>„Çà„ÇäÂ∞ÇÈñÄÁöÑ„Å™„Çµ„Éù„Éº„Éà„ÅåÂøÖË¶Å„Å™Êñπ„Å∏</h3>
                                <p className="text-gray-700 mb-6 max-w-xl mx-auto">
                                    „Éà„É©„Ç¶„Éû„Éé„Éº„Éà„ÅØ„ÄÅÊ≠£„Åó„ÅèÂÆüË∑µ„Åô„Çã„Åì„Å®„ÅßÁµ∂Â§ß„Å™ÂäπÊûú„ÇíÁô∫ÊèÆ„Åó„Åæ„Åô„Åå„ÄÅ‰∏Ä‰∫∫„ÅßÊ∑±„ÅÑ„Éà„É©„Ç¶„Éû„Å®Âêë„ÅçÂêà„ÅÜ„ÅÆ„ÅØËæõ„ÅÑ‰ΩúÊ•≠„Åß„Åô„ÄÇ<br/>„Çà„ÇäÁ¢∫ÂÆü„Å™ÂäπÊûú„Å®„ÄÅÂ∞ÇÈñÄÂÆ∂„Å´„Çà„ÇãÂÆâÂÖ®„Å™„Çµ„Éù„Éº„Éà„ÇíÊ±Ç„ÇÅ„ÇãÊñπ„ÅØ„ÄÅ„Åì„Å°„Çâ„ÅÆ„Çµ„É≠„É≥„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </p>
                                <a href="https://lounge.dmm.com/detail/9373/index/" target="_blank" rel="noopener noreferrer" className="inline-block text-white font-bold py-3 px-10 rounded-full shadow-lg hover:opacity-90 transition-all duration-300 transform hover:scale-105" style={{backgroundColor: 'var(--support-green)'}}>
                                    „Äå„Åã„Åö„Åø„ÅÆ„Éà„É©„Ç¶„ÉûËß£Ê∂à„Éé„Éº„Éà„Äç„Çµ„É≠„É≥„ÇíË¶ã„Çã
                                </a>
                            </div>
                        </footer>
                    </div>
                </>
            );
        }


        function App() {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');


            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);


            const handleSignUp = async () => {
                setError('');
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                } catch (err) {
                    setError(`ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                }
            };
            
            const handleLogin = async () => {
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError(`„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                }
            };


            const handleGoogleSignIn = async () => {
                setError('');
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (err) {
                    setError(`Google„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                }
            };


            const handleLogout = async () => {
                setError('');
                try {
                    await auth.signOut();
                } catch (err) {
                    setError(`„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                }
            };


            if (loading) {
                return <div className="flex items-center justify-center min-h-screen">Ë™≠„ÅøËæº„Åø‰∏≠...</div>;
            }


            return (
                <div className="min-h-screen bg-gray-50">
                    {user ? (
                        <TraumaNoteApp user={user} handleLogout={handleLogout} />
                    ) : (
                        <div className="flex items-center justify-center min-h-screen p-4 fade-in">
                            <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                                <div className="text-center mb-4">
                                    <h1 className="text-2xl font-semibold">„É≠„Ç∞„Ç§„É≥</h1>
                                </div>
                                {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</p>}
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 p-2 border rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 p-2 border rounded-lg" />
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-2 pt-2">
                                        <button onClick={handleLogin} className="w-full flex-1 py-2 px-4 border rounded-full font-semibold hover:bg-gray-100">„É≠„Ç∞„Ç§„É≥</button>
                                        <button onClick={handleSignUp} className="w-full flex-1 py-2 px-4 border rounded-full font-semibold hover:bg-gray-100">Êñ∞Ë¶èÁôªÈå≤</button>
                                    </div>
                                    <div className="relative my-4">
                                        <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div>
                                        <div className="relative flex justify-center text-sm"><span className="bg-white px-2 text-gray-500">„Åæ„Åü„ÅØ</span></div>
                                    </div>
                                    <button onClick={handleGoogleSignIn} className="w-full flex items-center justify-center py-2 px-4 border rounded-full font-semibold hover:bg-gray-100">
                                        <svg className="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                                        Google„Åß„É≠„Ç∞„Ç§„É≥
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }


        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>